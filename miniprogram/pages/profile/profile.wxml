<!--pages/profile/profile.wxml-->
<view class="page-container {{pageThemeClass}}">
  <app-header title="个人中心" subtitle="管理您的账户信息"></app-header>
  <view class="page-content">
  <!-- 用户信息卡片 -->
  <view class="user-card" wx:if="{{isLogin}}">
    <view class="card-background"></view>
    <view class="user-avatar">
      <view class="avatar-container" bindtap="toggleAvatarEdit" wx:if="{{isEditingNickname}}">
        <image 
          class="avatar-image editable" 
          src="{{userInfo.avatar_url || '/images/default-avatar.png'}}" 
          mode="aspectFill"
        />
        <view class="avatar-edit-overlay">
          <view class="edit-icon">📷</view>
          <text class="avatar-edit-text">点击选择</text>
        </view>
      </view>
      <image 
        class="avatar-image" 
        src="{{userInfo.avatar_url || '/images/default-avatar.png'}}" 
        mode="aspectFill"
        wx:else
      />
    </view>
    <view class="user-info">
      <view class="nickname-display">
        <text class="user-name">{{userInfo.nickname || '鹦鹉爱好者'}}</text>
        <view class="edit-nickname-btn" bindtap="toggleNicknameEdit">
          <view class="edit-icon">✏️</view>
        </view>
      </view>
      <text class="user-role">{{roleDisplay}}</text>
      <view class="nickname-edit" wx:if="{{isEditingNickname}}">
        <input 
          class="nickname-edit-input" 
          type="nickname" 
          placeholder="请输入新昵称" 
          value="{{editNickname}}"
          bindinput="onEditNicknameInput"
          maxlength="20"
        />
        <view class="edit-actions">
          <button class="save-btn" bindtap="saveNickname">保存</button>
          <button class="cancel-btn" bindtap="cancelNicknameEdit">取消</button>
        </view>
      </view>
      <view class="info-row">
        <text class="join-date">加入时间：{{joinDate}}</text>
        <view class="points-row">
          <text class="user-points">积分：</text>
          <text class="user-points-val">{{points}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 未登录状态 -->
  <view class="login-prompt" wx:if="{{!isLogin}}">
    <view class="login-card">
      <view class="login-icon">🦜</view>
      <text class="login-text">欢迎使用鹦鹉管家</text>
      <text class="login-subtitle">请先登录以查看个人信息</text>
      <button class="login-btn" bindtap="handleLogin">微信快速登录</button>
    </view>
  </view>



  <!-- 功能卡片区域 -->
  <view class="function-cards" wx:if="{{isLogin}}">
    <!-- 模式设置卡片 -->
      <view class="function-card mode-card">
      <view class="card-content">
        <view class="mode-header">
          <view class="mode-icon">⚙️</view>
          <view class="mode-text">
            <text class="card-title mode-title">模式设置</text>
            <text class="mode-desc">选择应用使用模式</text>
          </view>
        </view>
        <view class="mode-toggle">
          <view class="mode-pill {{userMode === 'personal' ? 'active' : ''}}" data-mode="personal" bindtap="chooseUserMode">个人模式</view>
          <view class="mode-pill {{userMode === 'team' ? 'active' : ''}}" data-mode="team" bindtap="chooseUserMode">团队模式</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 模式切换弹窗 -->
  <view class="modal-overlay" wx:if="{{showModeDialog}}" bindtap="hideModeDialog">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">选择使用模式</text>
      </view>
      <view class="modal-body">
        <view class="mode-options">
          <view class="mode-option {{selectedMode === 'personal' ? 'active' : ''}}" 
                data-mode="personal" bindtap="selectMode">
            <view class="mode-icon">👤</view>
            <view class="mode-info">
              <text class="mode-name">个人模式</text>
              <text class="mode-desc">管理个人的鹦鹉数据</text>
            </view>
          </view>
          <view class="mode-option {{selectedMode === 'team' ? 'active' : ''}}" 
                data-mode="team" bindtap="selectMode">
            <view class="mode-icon">👥</view>
            <view class="mode-info">
              <text class="mode-name">团队模式</text>
              <text class="mode-desc">查看团队管理员的鹦鹉数据</text>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="hideModeDialog">取消</button>
        <button class="btn btn-primary" bindtap="confirmModeSwitch">确认</button>
      </view>
    </view>
  </view>

<!-- 头像选择弹窗 -->
<view class="modal-overlay" wx:if="{{showAvatarModal}}" bindtap="hideAvatarModal">
  <view class="modal-container avatar-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">选择头像</text>
      <text class="modal-close" bindtap="hideAvatarModal">×</text>
    </view>
    <view class="modal-body">
      <view class="avatar-options">
        <view class="avatar-option" 
              wx:for="{{avatarOptions}}" 
              wx:key="index"
              bindtap="selectAvatar"
              data-avatar="{{item}}">
          <image class="option-avatar {{selectedAvatar === item ? 'selected' : ''}}" 
                 src="{{item}}" 
                 mode="aspectFill" />
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideAvatarModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmAvatarChange" disabled="{{!selectedAvatar}}">确认选择</button>
    </view>
  </view>
</view>

<!-- 在用户信息卡片后新增统计网格 -->
<view class="stats-grid" wx:if="{{isLogin}}">
  <view class="stat-card red">
    <view class="stat-icon">❤️</view>
    <view class="stat-value">{{stats.parrotCount}}</view>
    <view class="stat-label">我的鹦鹉</view>
  </view>
  <view class="stat-card orange">
    <view class="stat-icon">🍽️</view>
    <view class="stat-value">{{stats.totalFeedings}}</view>
    <view class="stat-label">总喂食次数</view>
  </view>
  <view class="stat-card green">
    <view class="stat-icon">🛡️</view>
    <view class="stat-value">{{stats.totalCheckups}}</view>
    <view class="stat-label">健康检查</view>
  </view>
</view>

<!-- 成就模块 -->
<view class="achievements-card" wx:if="{{isLogin && userMode !== 'team'}}">
  <view class="section-title">
    <text class="title-icon">🏆</text>
    <text>我的成就</text>
  </view>
  <view class="achievements-grid">
    <block wx:for="{{achievements}}" wx:key="index">
      <view class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}">
        <view class="achievement-icon {{item.bgClass}}">{{item.icon}}</view>
        <view class="achievement-title">{{item.title}}</view>
        <view class="achievement-desc">{{item.desc}}</view>
        <view class="achievement-progress" wx:if="{{!item.unlocked}}">
          <text class="progress-text">{{stats[item.condition] || 0}}/{{item.target}}</text>
        </view>
        <view class="achievement-badge" wx:if="{{item.unlocked}}">
          <text class="badge-text">已解锁</text>
        </view>
      </view>
    </block>
  </view>
</view>

<!-- 团队协作模块（仅团队模式显示） -->
<view class="team-card" wx:if="{{isLogin && userMode === 'team'}}">
  <view class="section-title">
    <text class="title-icon">👥</text>
    <text>团队协作</text>
  </view>
  <view class="team-list">
    <block wx:for="{{teamItems}}" wx:key="index">
      <view class="team-item" bindtap="onTeamItemTap" data-title="{{item.title}}">
        <view class="team-item-icon {{item.bgClass}}">{{item.icon}}</view>
        <view class="team-item-content">
          <view class="team-item-title">{{item.title}}</view>
          <view class="team-item-desc">{{item.desc}}</view>
        </view>
        <text class="arrow">></text>
      </view>
    </block>
  </view>
</view>

<!-- 功能菜单模块 -->
<view class="menu-card">
  <view class="section-title">
    <text class="title-icon">📋</text>
    <text>功能菜单</text>
  </view>
  <view class="menu-list">
    <block wx:for="{{menuItems}}" wx:key="index">
      <view class="menu-item" bindtap="onMenuItemTap" data-title="{{item.title}}">
        <view class="menu-item-icon {{item.bgClass}}">{{item.icon}}</view>
        <view class="menu-item-content">
          <view class="menu-item-title">{{item.title}}</view>
          <view class="menu-item-desc">{{item.desc}}</view>
        </view>
        <text class="arrow">></text>
      </view>
    </block>
  </view>
</view>

<!-- 版本信息模块 -->
<view class="version-card">
  <view class="version-logo">❤️</view>
  <view class="version-title">鹦鹉管家</view>
  <view class="version-sub">专业的鹦鹉护理助手</view>
  <view class="version-info">版本 1.0.0 • 用心呵护每一只小鹦鹉</view>
</view>
</view>
<!-- 自定义底部导航 -->
<bottom-nav active="profile" />
</view>
