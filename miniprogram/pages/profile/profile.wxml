<!--pages/profile/profile.wxml-->
<view class="page-container">
  <!-- 用户信息卡片 -->
  <view class="user-card" wx:if="{{isLogin}}">
    <view class="user-avatar">
      <view class="avatar-container" bindtap="toggleAvatarEdit" wx:if="{{isEditingNickname}}">
        <image 
          class="avatar-image editable" 
          src="{{userInfo.avatar_url || '/images/default-parrot.svg'}}" 
          mode="aspectFill"
        />
        <view class="avatar-edit-overlay">
          <text class="avatar-edit-text">点击选择</text>
        </view>
      </view>
      <image 
        class="avatar-image" 
        src="{{userInfo.avatar_url || '/images/default-parrot.svg'}}" 
        mode="aspectFill"
        wx:else
      />
    </view>
    <view class="user-info">
      <view class="nickname-display">
        <text class="user-name">{{userInfo.nickname || '鹦鹉爱好者'}}</text>
        <view class="edit-nickname-btn" bindtap="toggleNicknameEdit">
          <text class="edit-icon">✏️</text>
        </view>
      </view>
      <view class="nickname-edit" wx:if="{{isEditingNickname}}">
        <input 
          class="nickname-edit-input" 
          type="nickname" 
          placeholder="请输入新昵称" 
          value="{{editNickname}}"
          bindinput="onEditNicknameInput"
          maxlength="20"
        />
        <view class="edit-actions">
          <button class="save-btn" bindtap="saveNickname">保存</button>
          <button class="cancel-btn" bindtap="cancelNicknameEdit">取消</button>
        </view>
      </view>
      <text class="join-date">加入时间: {{joinDate}}</text>
    </view>
  </view>

  <!-- 未登录状态 -->
  <view class="login-prompt" wx:if="{{!isLogin}}">
    <view class="login-card">
      <view class="login-icon">🦜</view>
      <text class="login-text">欢迎使用鹦鹉管家</text>
      <text class="login-subtitle">请先登录以查看个人信息</text>
      <button class="login-btn" bindtap="handleLogin">微信快速登录</button>
    </view>
  </view>



  <!-- 功能卡片区域 -->
  <view class="function-cards" wx:if="{{isLogin}}">
    <!-- 模式设置卡片 -->
    <view class="function-card mode-card">
      <view class="card-header">
        <view class="card-icon">⚙️</view>
        <text class="card-title">模式设置</text>
      </view>
      <view class="card-content">
        <view class="mode-display">
          <text class="current-mode">{{userMode === 'personal' ? '个人模式' : '团队模式'}}</text>
          <text class="mode-desc">{{userMode === 'personal' ? '管理个人鹦鹉数据' : '查看团队鹦鹉数据'}}</text>
        </view>
        <view class="card-action" bindtap="showModeSwitch">
          <text class="action-text">切换</text>
          <text class="action-arrow">></text>
        </view>
      </view>
    </view>

    <!-- 团队协作卡片 -->
    <view class="function-card team-card">
      <view class="card-header">
        <view class="card-icon">👥</view>
        <text class="card-title">团队协作</text>
      </view>
      <view class="card-content">
        <view class="team-actions">
          <view class="team-action-item info-only" bindtap="showTeamInfoModal">
            <view class="action-info">
              <text class="action-title">当前团队</text>
              <text class="action-desc">{{currentTeamName || '未选择团队'}}</text>
            </view>
          </view>
          <view class="team-action-item" bindtap="goToJoinTeam">
            <view class="action-info">
              <text class="action-title">加入团队</text>
              <text class="action-desc">通过邀请码加入团队</text>
            </view>
            <text class="action-arrow">></text>
          </view>
          <view class="team-action-item" bindtap="goToCreateTeam">
            <view class="action-info">
              <text class="action-title">创建团队</text>
              <text class="action-desc">创建新的团队并邀请成员</text>
            </view>
            <text class="action-arrow">></text>
          </view>
          <view class="team-action-item" wx:if="{{isTeamAdmin}}" bindtap="goToTeams">
            <view class="action-info">
              <text class="action-title">团队管理</text>
              <text class="action-desc">管理团队成员和设置</text>
            </view>
            <text class="action-arrow">></text>
          </view>
        </view>
      </view>
    </view>

    <!-- 应用设置卡片 -->
    <view class="function-card settings-card">
      <view class="card-header">
        <view class="card-icon">🔧</view>
        <text class="card-title">应用设置</text>
      </view>
      <view class="card-content">
        <view class="settings-actions">
          <view class="setting-action-item" bindtap="showAbout">
            <view class="setting-icon-wrapper">
              <view class="setting-icon">ℹ️</view>
            </view>
            <view class="setting-content">
              <view class="setting-name">关于应用</view>
              <view class="setting-desc">查看应用版本和信息</view>
            </view>
            <view class="setting-arrow">></view>
          </view>
          <view class="setting-action-item" bindtap="showHelp">
            <view class="setting-icon-wrapper">
              <view class="setting-icon">❓</view>
            </view>
            <view class="setting-content">
              <view class="setting-name">帮助反馈</view>
              <view class="setting-desc">获取帮助或提交反馈</view>
            </view>
            <view class="setting-arrow">></view>
          </view>
          <view class="setting-action-item logout-item" bindtap="handleLogout">
            <view class="setting-icon-wrapper">
              <view class="setting-icon">🚪</view>
            </view>
            <view class="setting-content">
              <view class="setting-name">退出登录</view>
              <view class="setting-desc">安全退出当前账户</view>
            </view>
            <view class="setting-arrow">></view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 模式切换弹窗 -->
  <view class="modal-overlay" wx:if="{{showModeDialog}}" bindtap="hideModeDialog">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">选择使用模式</text>
      </view>
      <view class="modal-body">
        <view class="mode-options">
          <view class="mode-option {{selectedMode === 'personal' ? 'active' : ''}}" 
                data-mode="personal" bindtap="selectMode">
            <view class="mode-icon">👤</view>
            <view class="mode-info">
              <text class="mode-name">个人模式</text>
              <text class="mode-desc">管理个人的鹦鹉数据</text>
            </view>
          </view>
          <view class="mode-option {{selectedMode === 'team' ? 'active' : ''}}" 
                data-mode="team" bindtap="selectMode">
            <view class="mode-icon">👥</view>
            <view class="mode-info">
              <text class="mode-name">团队模式</text>
              <text class="mode-desc">查看团队管理员的鹦鹉数据</text>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="hideModeDialog">取消</button>
        <button class="btn btn-primary" bindtap="confirmModeSwitch">确认</button>
      </view>
    </view>
  </view>
</view>

<!-- 头像选择弹窗 -->
<view class="modal-overlay" wx:if="{{showAvatarModal}}" bindtap="hideAvatarModal">
  <view class="modal-container avatar-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">选择头像</text>
      <text class="modal-close" bindtap="hideAvatarModal">×</text>
    </view>
    <view class="modal-body">
      <view class="avatar-options">
        <view class="avatar-option" 
              wx:for="{{avatarOptions}}" 
              wx:key="index"
              bindtap="selectAvatar"
              data-avatar="{{item}}">
          <image class="option-avatar {{selectedAvatar === item ? 'selected' : ''}}" 
                 src="{{item}}" 
                 mode="aspectFill" />
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideAvatarModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmAvatarChange" disabled="{{!selectedAvatar}}">确认选择</button>
    </view>
  </view>
</view>

<!-- 团队信息弹窗 -->
<view class="modal-overlay" wx:if="{{showTeamInfoModal}}" bindtap="hideTeamInfoModal">
  <view class="modal-container team-info-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">团队信息</text>
      <text class="modal-close" bindtap="hideTeamInfoModal">×</text>
    </view>
    <view class="modal-body">
      <view class="team-info-section">
        <view class="info-item">
          <text class="info-label">团队名称</text>
          <text class="info-value">{{teamInfo.name || '未知团队'}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">团队描述</text>
          <text class="info-value">{{teamInfo.description || '暂无描述'}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">成员数量</text>
          <text class="info-value">{{teamInfo.memberCount || 0}}人</text>
        </view>
        <view class="info-item">
          <text class="info-label">创建时间</text>
          <text class="info-value">{{teamInfo.createdAt || '未知'}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">我的角色</text>
          <text class="info-value">{{teamInfo.myRole || '成员'}}</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideTeamInfoModal">关闭</button>
      <button class="btn btn-danger" bindtap="leaveTeam" wx:if="{{teamInfo.myRole !== '创建者'}}">退出团队</button>
    </view>
  </view>
</view>

<!-- 加入团队弹窗 -->
<view class="modal-overlay" wx:if="{{showJoinTeamModal}}" bindtap="hideJoinTeamModal">
  <view class="modal-container join-team-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">加入团队</text>
      <text class="modal-close" bindtap="hideJoinTeamModal">×</text>
    </view>
    <view class="modal-body">
      <view class="join-form">
        <view class="form-item">
          <text class="form-label">邀请码</text>
          <input class="form-input" 
                 placeholder="请输入团队邀请码" 
                 value="{{inviteCode}}" 
                 bindinput="onInviteCodeInput"
                 maxlength="8" />
        </view>
        <view class="form-tips">
          <text>请向团队管理员获取8位邀请码</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideJoinTeamModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmJoinTeam" disabled="{{!inviteCode}}">加入团队</button>
    </view>
  </view>
</view>

<!-- 创建团队弹窗 -->
<view class="modal-overlay" wx:if="{{showCreateTeamModal}}" bindtap="hideCreateTeamModal">
  <view class="modal-container create-team-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">创建团队</text>
      <text class="modal-close" bindtap="hideCreateTeamModal">×</text>
    </view>
    <view class="modal-body">
      <view class="create-form">
        <view class="form-item">
          <text class="form-label">团队名称</text>
          <input class="form-input" 
                 placeholder="请输入团队名称" 
                 value="{{teamName}}" 
                 bindinput="onTeamNameInput"
                 maxlength="20" />
        </view>
        <view class="form-item">
          <text class="form-label">团队描述</text>
          <textarea class="form-textarea" 
                    placeholder="请输入团队描述（可选）" 
                    value="{{teamDescription}}" 
                    bindinput="onTeamDescriptionInput"
                    maxlength="100" />
        </view>
        <view class="form-tips">
          <text>团队名称将作为您团队的标识</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideCreateTeamModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmCreateTeam" disabled="{{!teamName}}">创建团队</button>
    </view>
  </view>
</view>