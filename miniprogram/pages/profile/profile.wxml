<!--pages/profile/profile.wxml-->
<view class="page-container {{pageThemeClass}}">
  <app-header title="个人中心" subtitle="管理您的账户信息">
    <view slot="actions" class="header-action-btn" bindtap="openNotifications">
      <image class="header-action-icon" src="{{iconPaths.headerNotification}}" mode="aspectFit" binderror="onProfileIconError" data-key="headerNotification" />
      <view class="header-action-badge" wx:if="{{unreadCount > 0}}"></view>
    </view>
  </app-header>
  <view class="page-content">
  <!-- 用户信息卡片 -->
  <view class="user-card" wx:if="{{isLogin}}">
    <view class="card-background"></view>
    <view class="user-avatar">
      <view class="avatar-container" bindtap="toggleAvatarEdit" wx:if="{{isEditingNickname}}">
        <image 
          class="avatar-image editable" 
          src="{{userInfo.avatar_url || '/images/default-avatar.png'}}" 
          mode="aspectFill"
        />
        <view class="avatar-edit-overlay">
          <image class="edit-icon-img" src="{{iconPaths.cameraLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="cameraLine" />
          <text class="avatar-edit-text">点击选择</text>
        </view>
      </view>
      <image 
        class="avatar-image" 
        src="{{userInfo.avatar_url || '/images/default-avatar.png'}}" 
        mode="aspectFill"
        wx:else
      />
    </view>
    <view class="user-info">
      <view class="nickname-display">
        <text class="user-name">{{userInfo.nickname || '鹦鹉爱好者'}}</text>
        <view class="edit-nickname-btn" bindtap="toggleNicknameEdit">
<image class="edit-icon-img" src="{{iconPaths.editLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="editLine" />
        </view>
      </view>
      <text class="user-role">{{roleDisplay}}</text>
      <view class="nickname-edit" wx:if="{{isEditingNickname}}">
        <input 
          class="nickname-edit-input" 
          type="nickname" 
          placeholder="请输入新昵称" 
          value="{{editNickname}}"
          bindinput="onEditNicknameInput"
          maxlength="20"
        />
        <view class="edit-actions">
          <button class="save-btn" bindtap="saveNickname">保存</button>
          <button class="cancel-btn" bindtap="cancelNicknameEdit">取消</button>
        </view>
      </view>
      <view class="info-row">
        <text class="join-date">加入时间：{{joinDate}}</text>
        <view class="points-row">
          <text class="user-points">积分：</text>
          <text class="user-points-val">{{points}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 未登录状态 -->
  <view class="login-prompt" wx:if="{{!isLogin}}">
    <view class="login-card">
<image class="login-icon-img" src="{{iconPaths.loginAvatar}}" mode="aspectFit" binderror="onProfileIconError" data-key="loginAvatar" />
      <text class="login-text">欢迎使用鹦鹉管家</text>
      <text class="login-subtitle">请先登录以查看个人信息</text>
      <button class="login-btn" bindtap="handleLogin">微信快速登录</button>
    </view>
  </view>



  <!-- 功能卡片区域 -->
  <view class="function-cards" wx:if="{{isLogin}}">
    <!-- 模式设置卡片 -->
      <view class="function-card mode-card">
        <view class="section-title">
          <image class="section-icon-img" src="{{iconPaths.sectionSettings}}" mode="aspectFit" binderror="onProfileIconError" data-key="sectionSettings" />
          <text>模式设置</text>
        </view>
        <view class="mode-toggle">
          <view class="mode-pill {{userMode === 'personal' ? 'active' : ''}}" data-mode="personal" bindtap="chooseUserMode">个人模式</view>
          <view class="mode-pill {{userMode === 'team' ? 'active' : ''}}" data-mode="team" bindtap="chooseUserMode">团队模式</view>
        </view>
    </view>
  </view>

<!-- 头像选择弹窗 -->
<view class="modal-overlay" wx:if="{{showAvatarModal}}" bindtap="hideAvatarModal">
  <view class="modal-container avatar-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">选择头像</text>
        <view class="modal-close" bindtap="hideAvatarModal"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="avatar-options">
        <view class="avatar-option" 
              wx:for="{{avatarOptions}}" 
              wx:key="index"
              bindtap="selectAvatar"
              data-avatar="{{item}}">
          <image class="option-avatar {{selectedAvatar === item ? 'selected' : ''}}" 
                 src="{{item}}" 
                 mode="aspectFill" />
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideAvatarModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmAvatarChange" disabled="{{!selectedAvatar}}">确认选择</button>
    </view>
  </view>
</view>

<!-- 在用户信息卡片后新增统计网格 -->
<view class="stats-grid" wx:if="{{isLogin}}">
  <view class="stat-card red">
    <view class="stat-icon stat-icon-red">
      <image class="stat-icon-img" src="{{iconPaths.statHeartRed}}" mode="widthFix" binderror="onProfileIconError" data-key="statHeartRed" />
    </view>
    <view class="stat-value">{{stats.parrotCount}}</view>
    <view class="stat-label">我的鹦鹉</view>
  </view>
  <view class="stat-card orange">
    <view class="stat-icon stat-icon-orange">
      <image class="stat-icon-img" src="{{iconPaths.statFeedingOrange}}" mode="widthFix" binderror="onProfileIconError" data-key="statFeedingOrange" />
    </view>
    <view class="stat-value">{{stats.totalFeedings}}</view>
    <view class="stat-label">总喂食次数</view>
  </view>
  <view class="stat-card green">
    <view class="stat-icon stat-icon-green">
      <image class="stat-icon-img" src="{{iconPaths.statShieldBlue}}" mode="widthFix" binderror="onProfileIconError" data-key="statShieldBlue" />
    </view>
    <view class="stat-value">{{stats.totalCheckups}}</view>
    <view class="stat-label">健康检查</view>
  </view>
</view>

<!-- 团队信息弹窗 -->
<view class="modal-overlay" wx:if="{{showTeamInfoModal}}" bindtap="hideTeamInfoModal">
  <view class="modal-container team-info-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">当前团队</text>
      <view class="modal-close" bindtap="hideTeamInfoModal"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="team-info-section">
        <text class="team-name">{{currentTeamName || '未加入团队'}}</text>
        <text class="team-desc">{{teamInfo.description || '暂无团队描述'}}</text>
        <text>成员数：{{teamInfo.member_count || 0}}</text>
        <text>角色：{{teamInfo.user_role || teamInfo.role || '成员'}}</text>
        <text>邀请码：{{teamInfo.invite_code || '暂无'}}</text>
        <view class="members-section">
          <text class="section-title">成员列表</text>
          <block wx:if="{{teamInfo.members && teamInfo.members.length}}">
            <block wx:for="{{teamInfo.members}}" wx:key="id">
              <view class="member-row">
                <image class="member-avatar" src="{{item.avatar_url || '/images/default-avatar.png'}}" mode="aspectFill" />
                <view class="member-info">
                  <text class="member-name">{{item.nickname}}</text>
                  <text class="member-role">{{item.role}}</text>
                </view>
                <view class="member-actions" wx:if="{{isTeamAdmin && item.role !== 'owner'}}">
                  <button class="btn btn-secondary" size="mini" data-user-id="{{item.id}}" bindtap="changeMemberRole">{{item.role === 'admin' ? '设为成员' : '设为管理员'}}</button>
                  <button class="btn btn-danger" size="mini" data-user-id="{{item.id}}" bindtap="removeMember">移除</button>
                </view>
              </view>
            </block>
          </block>
          <block wx:else>
            <text class="empty-text">暂无成员</text>
          </block>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="copyInviteCode" disabled="{{!(teamInfo && teamInfo.invite_code)}}">复制邀请码</button>
      <button class="btn btn-danger" bindtap="confirmLeaveTeam" wx:if="{{teamInfo && (teamInfo.user_role || teamInfo.role) !== 'owner'}}">退出团队</button>
      <button class="btn btn-primary" bindtap="hideTeamInfoModal">知道了</button>
    </view>
  </view>
  </view>

<!-- 加入团队弹窗 -->
<view class="modal-overlay" wx:if="{{showJoinTeamModal}}" bindtap="hideJoinTeamModal">
  <view class="modal-container join-team-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">加入团队</text>
      <view class="modal-close" bindtap="hideJoinTeamModal"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="form-row">
        <text class="form-label">邀请码</text>
        <input class="form-input" placeholder="请输入团队邀请码" value="{{inviteCode}}" bindinput="onInviteCodeInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideJoinTeamModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmJoinTeam" disabled="{{!inviteCode}}">加入</button>
    </view>
  </view>
</view>

<!-- 创建团队弹窗 -->
<view class="modal-overlay" wx:if="{{showCreateTeamModal}}" bindtap="hideCreateTeamModal">
  <view class="modal-container create-team-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">创建团队</text>
      <view class="modal-close" bindtap="hideCreateTeamModal"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="form-row">
        <text class="form-label">团队名称</text>
        <input class="form-input" placeholder="请输入团队名称" value="{{newTeamName}}" bindinput="onNewTeamNameInput" maxlength="20" />
      </view>
      <view class="form-row">
        <text class="form-label">团队描述</text>
        <textarea class="form-textarea" placeholder="选填：一句话介绍你的团队" value="{{newTeamDesc}}" bindinput="onNewTeamDescInput" maxlength="100" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideCreateTeamModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmCreateTeam" disabled="{{!newTeamName}}">创建</button>
    </view>
  </view>
</view>



<!-- 团队管理弹窗 -->
<view class="modal-overlay" wx:if="{{showTeamManageModal}}" bindtap="hideTeamManageModal">
  <view class="modal-container manage-team-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">团队管理</text>
      <view class="modal-close" bindtap="hideTeamManageModal"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="cards-grid">
        <!-- 基本信息卡片 -->
        <view class="card">
          <view class="card-header">
            <text class="card-title">基本信息</text>
          </view>
          <view class="card-content">
            <view class="form-row">
              <text class="form-label">团队名称</text>
              <input class="form-input" placeholder="请输入团队名称" value="{{editTeamName}}" bindinput="onEditTeamNameInput" maxlength="20" />
            </view>
            <view class="form-row">
              <text class="form-label">团队描述</text>
              <textarea class="form-textarea" placeholder="团队简介（可选）" value="{{editTeamDesc}}" bindinput="onEditTeamDescInput" maxlength="100" />
            </view>
          </view>
        </view>

        <!-- 邀请码卡片 -->
        <view class="card">
          <view class="card-header">
            <text class="card-title">邀请码</text>
          </view>
          <view class="card-content">
            <view class="invite-row">
              <text>当前邀请码：{{teamInfo.invite_code || '暂无'}}</text>
              <button class="btn btn-secondary" size="mini" bindtap="copyInviteCode" disabled="{{!(teamInfo && teamInfo.invite_code)}}">复制邀请码</button>
            </view>
          </view>
        </view>

        <!-- 成员管理卡片 -->
        <view class="card">
          <view class="card-header">
            <text class="card-title">成员管理</text>
          </view>
          <view class="card-content">
            <block wx:if="{{teamInfo.members && teamInfo.members.length}}">
              <block wx:for="{{teamInfo.members}}" wx:key="id">
                <view class="member-row">
                  <image class="member-avatar" src="{{item.avatar_url || '/images/default-avatar.png'}}" mode="aspectFill" />
                  <view class="member-info">
                    <text class="member-name">{{item.nickname}}</text>
                    <text class="member-role">{{item.role}}</text>
                  </view>
                  <view class="member-actions" wx:if="{{isTeamAdmin && item.role !== 'owner'}}">
                    <button class="btn btn-secondary" size="mini" data-user-id="{{item.id}}" data-role="admin" bindtap="changeMemberRole" disabled="{{item.role === 'admin'}}">设为管理员</button>
                    <button class="btn btn-secondary" size="mini" data-user-id="{{item.id}}" data-role="member" bindtap="changeMemberRole" disabled="{{item.role === 'member'}}">设为成员</button>
                    <button class="btn btn-danger" size="mini" data-user-id="{{item.id}}" bindtap="removeMember">移除</button>
                  </view>
                </view>
              </block>
            </block>
            <block wx:else>
              <text class="empty-text">暂无成员</text>
            </block>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-primary" bindtap="confirmUpdateTeam" disabled="{{!isTeamAdmin || !editTeamName}}">保存更新</button>
      <button class="btn" bindtap="hideTeamManageModal">关闭</button>
    </view>
  </view>
  
</view>

<!-- 成就模块已移除 -->

<!-- 团队协作模块（仅团队模式显示） -->
<view class="team-card" wx:if="{{isLogin && userMode === 'team'}}">
  <view class="section-title">
    <image class="section-icon-img" src="{{iconPaths.userLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="userLine" />
    <text>团队协作</text>
  </view>
  <!-- 改为图片式卡片列表，像素级对齐设计 -->
  <view class="team-list">
    <view class="team-item theme-blue" bindtap="onTeamItemTap" data-action="current">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.userLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="userLine" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">当前团队</view>
        <view class="team-item-desc">查看团队成员</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
    <view class="team-item theme-green" bindtap="onTeamItemTap" data-action="join">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.addLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="addLine" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">加入团队</view>
        <view class="team-item-desc">通过邀请码加入团队</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
    <view class="team-item theme-purple" bindtap="onTeamItemTap" data-action="create">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.userFill}}" mode="aspectFit" binderror="onProfileIconError" data-key="userFill" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">创建团队</view>
        <view class="team-item-desc">创建新的团队并邀请成员</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
    <view class="team-item theme-orange" bindtap="onTeamItemTap" data-action="manage">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.sectionSettings}}" mode="aspectFit" binderror="onProfileIconError" data-key="sectionSettings" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">团队管理</view>
        <view class="team-item-desc">管理团队成员和设置</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
  </view>
</view>

<!-- 功能菜单模块 -->
<view class="menu-card">
  <view class="section-title">
    <image class="section-icon-img" src="{{iconPaths.infoLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="infoLine" />
    <text>功能菜单</text>
  </view>
  <view class="menu-list">
    <block wx:for="{{menuItems}}" wx:key="index">
      <block wx:if="{{item.isContact}}">
        <button class="menu-item" open-type="contact" session-from="{{contactSessionFrom}}" bindcontact="onContact">
          <view class="menu-item-icon {{item.bgClass}}">
            <image class="menu-item-icon-img" src="{{item.iconSrc}}" mode="aspectFit" binderror="onMenuItemIconError" data-index="{{index}}" />
          </view>
          <view class="menu-item-content">
            <view class="menu-item-title">{{item.title}}</view>
            <view class="menu-item-desc">{{item.desc}}</view>
          </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
        </button>
      </block>
      <block wx:else>
        <view class="menu-item" bindtap="onMenuItemTap" data-title="{{item.title}}">
          <view class="menu-item-icon {{item.bgClass}}">
            <image class="menu-item-icon-img" src="{{item.iconSrc}}" mode="aspectFit" binderror="onMenuItemIconError" data-index="{{index}}" />
          </view>
          <view class="menu-item-content">
            <view class="menu-item-title">{{item.title}}</view>
            <view class="menu-item-desc">{{item.desc}}</view>
          </view>
          <view class="menu-item-badge" wx:if="{{item.title === '通知' && unreadCount > 0}}">{{unreadCount}}</view>
          <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
        </view>
      </block>
    </block>
  </view>
</view>

<!-- 版本信息模块 -->
<view class="version-card">
<image class="version-logo-img" src="/images/logo.png" mode="aspectFit" />
  <view class="version-title">鹦鹉管家</view>
  <view class="version-sub">专业的鹦鹉护理助手</view>
  <view class="version-info">版本 1.0.0 • 用心呵护每一只小鹦鹉</view>
</view>
</view>
<!-- 自定义底部导航 -->
<bottom-nav active="profile" />
<!-- 通知中心组件挂载到页面根部 -->
<notification-center 
  visible="{{showNotifications}}" 
  notifications="{{notifications}}" 
  bind:close="closeNotifications" 
  bind:markAllRead="markAllNotificationsRead" 
  bind:clearAll="clearAllNotifications" 
  bind:itemTap="handleNotificationTap" 
/>
</view>
