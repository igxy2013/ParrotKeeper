<!--pages/profile/profile.wxml-->
<view class="page-container {{pageThemeClass}}">
  <app-header title="个人中心" subtitle="管理您的账户信息"></app-header>
  <view class="page-content">
  <!-- 用户信息卡片 -->
  <view class="user-card" wx:if="{{isLogin}}">
    <view class="card-background"></view>
    <view class="user-avatar">
        <button class="avatar-container" open-type="chooseAvatar" bindchooseavatar="onChooseWeChatAvatar">
          <image 
            class="avatar-image {{isEditingNickname ? 'editable' : ''}}" 
            src="{{userInfo.avatar_url || '/images/parrot-avatar-green.svg'}}" 
            mode="aspectFill"
          />
          <view class="avatar-edit-overlay" wx:if="{{isEditingNickname}}">
            <image class="edit-icon-img" src="{{iconPaths.cameraLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="cameraLine" catchtap="chooseAvatarPhoto" />
            <text class="avatar-edit-text">点击更换</text>
          </view>
        </button>
    </view>
    <view class="user-info">
      <view class="nickname-display">
        <text class="user-name">{{userInfo.nickname || '鹦鹉爱好者'}}</text>
        <view class="edit-nickname-btn" bindtap="toggleNicknameEdit">
<image class="edit-icon-img" src="{{iconPaths.editLine_white}}" mode="aspectFit" binderror="onProfileIconError" data-key="editLine_white" />
        </view>
      </view>
      <text class="user-role">{{roleDisplay}}</text>
      <!-- 团队信息显示（仅团队模式） -->
      <view class="team-info-row" wx:if="{{userMode === 'team' && (currentTeamName || teamInfo.name)}}">
        <text class="team-name-label">团队：</text>
        <text class="team-name-value">{{currentTeamName || teamInfo.name}}</text>
        <text class="team-role-badge">{{teamRoleDisplay}}</text>
      </view>
      <view class="nickname-edit" wx:if="{{isEditingNickname}}">
        <input 
          class="nickname-edit-input" 
          type="nickname" 
          placeholder="请输入新昵称" 
          value="{{editNickname}}"
          bindinput="onEditNicknameInput"
          maxlength="20"
        />
        <view class="edit-actions">
          <button class="cancel-btn" bindtap="cancelNicknameEdit">取消</button>
          <button class="save-btn" bindtap="saveNickname">保存</button>
        </view>
      </view>
      <view class="info-row">
        <text class="join-date">加入时间：{{joinDate}}</text>
        <view class="points-row">
          <text class="user-points">积分：</text>
          <text class="user-points-val">{{points}}</text>
        </view>
      </view>
    </view>
  </view>
    <!-- 登录提示 -->
    <view class="login-prompt-card" wx:if="{{!isLogin}}">
      <view class="login-content">
      <view class="login-icon"><image class="login-icon" src="{{iconPaths.logo}}" mode="widthFix" binderror="handleIconError" data-key="defaultParrot"/></view>
        <text class="login-title">欢迎使用鹦鹉管家</text>
        <text class="login-subtitle">请先登录以使用完整功能</text>
        <button class="login-btn" bindtap="handleLogin">微信快速登录</button>
      </view>
    </view>



  <!-- 功能卡片区域 -->
  <view class="function-cards" wx:if="{{isLogin}}">
    <!-- 模式设置卡片 -->
      <view class="function-card mode-card">
        <view class="section-title">
          <image class="section-icon-img" src="{{iconPaths.sectionSettings}}" mode="aspectFit" binderror="onProfileIconError" data-key="sectionSettings" />
          <text>模式设置</text>
        </view>
        <view class="mode-toggle">
          <view class="mode-pill {{userMode === 'personal' ? 'active' : ''}}" data-mode="personal" bindtap="chooseUserMode">个人模式</view>
          <view class="mode-pill {{userMode === 'team' ? 'active' : ''}}" data-mode="team" bindtap="chooseUserMode">团队模式</view>
        </view>
    </view>

<!-- 在用户信息卡片后新增统计网格 -->
<view class="stats-grid" wx:if="{{isLogin}}">
  <view class="stat-card red">
    <view class="stat-icon stat-icon-red">
      <image class="stat-icon-img" src="{{iconPaths.statHeartRed}}" mode="widthFix" binderror="onProfileIconError" data-key="statHeartRed" />
    </view>
    <view class="stat-value">{{stats.parrotCount}}</view>
    <view class="stat-label">我的鹦鹉</view>
  </view>
  <view class="stat-card orange">
    <view class="stat-icon stat-icon-orange">
      <image class="stat-icon-img" src="{{iconPaths.statFeedingOrange}}" mode="widthFix" binderror="onProfileIconError" data-key="statFeedingOrange" />
    </view>
    <view class="stat-value">{{stats.totalFeedings}}</view>
    <view class="stat-label">总喂食次数</view>
  </view>
  <view class="stat-card green">
    <view class="stat-icon stat-icon-green">
      <image class="stat-icon-img" src="{{iconPaths.statShieldBlue}}" mode="widthFix" binderror="onProfileIconError" data-key="statShieldBlue" />
    </view>
    <view class="stat-value">{{stats.totalCheckups}}</view>
    <view class="stat-label">健康检查</view>
  </view>
</view>

<!-- 团队信息弹窗 -->
<view class="modal-overlay" wx:if="{{showTeamInfoModal}}" bindtap="hideTeamInfoModal">
  <view class="modal-container team-info-modal" catchtap="preventClose">
    <view class="modal-header team-modal-header">
      <view class="modal-header-content">
        <view class="modal-icon-wrapper">
          <image class="modal-icon-img" src="/images/remix/group-fill-white.png" mode="aspectFit" binderror="onProfileIconError" data-key="groupFillWhite" />
        </view>
        <text class="modal-title">当前团队</text>
      </view>
      <view class="modal-close" bindtap="hideTeamInfoModal">
        <image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" />
      </view>
    </view>
    <view class="modal-body team-modal-body">
      <!-- 团队基本信息卡片 -->
      <view class="team-basic-card">
        <view class="team-header-info">
          <text class="team-name-large">{{currentTeamName || '未加入团队'}}</text>
          <view class="team-role-tag" wx:if="{{teamInfo.user_role || teamInfo.role}}">
            <text class="team-role-text">{{teamRoleDisplay || '团队成员'}}</text>
          </view>
        </view>
        <text class="team-desc-text" wx:if="{{teamInfo.description}}">{{teamInfo.description}}</text>
        <view class="team-stats-row">
          <view class="team-stat-item">
            <text class="team-stat-label">成员</text>
            <text class="team-stat-value">{{teamInfo.member_count || 0}}</text>
          </view>
          <view class="team-stat-divider"></view>
          <view class="team-stat-item">
            <text class="team-stat-label">邀请码</text>
            <text class="team-stat-value invite-code" wx:if="{{teamInfo.invite_code}}">{{teamInfo.invite_code}}</text>
            <text class="team-stat-value invite-code-empty" wx:else>暂无</text>
          </view>
        </view>
      </view>

      <!-- 成员列表区域 -->
      <view class="members-section-card">
        <view class="members-section-header">
          <text class="members-section-title">成员列表</text>
          <text class="members-count" wx:if="{{teamInfo.members && teamInfo.members.length > 0}}">{{teamInfo.members.length}}人</text>
        </view>
        <block wx:if="{{teamInfo.members && teamInfo.members.length > 0}}">
          <view class="members-list">
            <block wx:for="{{teamInfo.members}}" wx:key="id">
              <view class="member-card">
                <view class="member-card-left">
                  <image class="member-avatar-large" src="{{item.avatar_url || '/images/parrot-avatar-green.svg'}}" mode="aspectFill" />
                  <view class="member-info-group">
                    <view class="member-name-row">
                      <text class="member-name-large">{{item.nickname}}</text>
                      <view class="member-role-badge-small {{item.role === 'owner' ? 'role-owner' : (item.role === 'admin' ? 'role-admin' : 'role-member')}}">
                        <text class="member-role-text-small">{{item.role === 'owner' ? '所有者' : (item.role === 'admin' ? '管理员' : '成员')}}</text>
                      </view>
                    </view>
                  </view>
                </view>
                <view class="member-actions-group" wx:if="{{isTeamAdmin && item.role !== 'owner'}}">
                  <button class="icon-btn icon-edit small" data-user-id="{{item.id}}" bindtap="changeMemberRole">
                    <image class="icon-img" src="/images/remix/edit-line-white.png" mode="aspectFit" />
                  </button>
                  <button class="icon-btn icon-delete small" data-user-id="{{item.id}}" bindtap="removeMember">
                    <image class="icon-img" src="/images/remix/delete-bin-line-white.png" mode="aspectFit" />
                  </button>
                </view>
              </view>
            </block>
          </view>
        </block>
        <block wx:else>
          <view class="empty-members">
            <text class="empty-members-text">暂无成员</text>
          </view>
        </block>
      </view>
    </view>
    <view class="modal-footer team-modal-footer">
      <button class="btn btn-primary btn-modal" bindtap="copyInviteCode" disabled="{{!(teamInfo && teamInfo.invite_code)}}">
        <text class="btn-text">{{(teamInfo && teamInfo.invite_code) ? '复制邀请码' : '邀请码不可用'}}</text>
      </button>
      <button class="btn btn-danger btn-modal" bindtap="confirmLeaveTeam" wx:if="{{teamInfo && (teamInfo.user_role || teamInfo.role) !== 'owner'}}">退出团队</button>
      <button class="btn btn-primary btn-modal" bindtap="hideTeamInfoModal">关闭</button>
    </view>
  </view>
</view>

<!-- 加入团队弹窗 -->
<view class="modal-overlay" wx:if="{{showJoinTeamModal}}" bindtap="hideJoinTeamModal">
  <view class="modal-container join-team-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">加入团队</text>
      <view class="modal-close" bindtap="hideJoinTeamModal"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="form-row">
        <text class="form-label">邀请码</text>
        <input class="form-input" placeholder="请输入团队邀请码" value="{{inviteCode}}" bindinput="onInviteCodeInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideJoinTeamModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmJoinTeam" disabled="{{!inviteCode}}">加入</button>
    </view>
  </view>
</view>

<!-- 创建团队弹窗 -->
<view class="modal-overlay" wx:if="{{showCreateTeamModal}}" bindtap="hideCreateTeamModal">
  <view class="modal-container create-team-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">创建团队</text>
      <view class="modal-close" bindtap="hideCreateTeamModal"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="form-row">
        <text class="form-label">团队名称</text>
        <input class="form-input" placeholder="请输入团队名称" value="{{newTeamName}}" bindinput="onNewTeamNameInput" maxlength="20" />
      </view>
      <view class="form-row">
        <text class="form-label">团队描述</text>
        <textarea class="form-textarea" placeholder="选填：一句话介绍你的团队" value="{{newTeamDesc}}" bindinput="onNewTeamDescInput" maxlength="100" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideCreateTeamModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmCreateTeam" disabled="{{!newTeamName}}">创建</button>
    </view>
  </view>
</view>



<!-- 团队管理弹窗 -->
<!-- 团队管理弹窗已迁移为页面：/pages/teams/manage/manage -->

<!-- 团队协作模块（仅团队模式显示） -->
<view class="team-card" wx:if="{{isLogin && userMode === 'team'}}">
  <view class="section-title">
    <image class="section-icon-img" src="{{iconPaths.userLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="userLine" />
    <text>团队协作</text>
  </view>
  <!-- 改为图片式卡片列表，像素级对齐设计 -->
  <view class="team-list">
    <view class="team-item theme-blue" bindtap="onTeamItemTap" data-action="current">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.userLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="userLine" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">当前团队</view>
        <view class="team-item-desc">查看团队成员</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
    <view class="team-item theme-green {{(teamInfo.id || currentTeamName) ? 'disabled' : ''}}" bindtap="onTeamItemTap" data-action="join">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.addLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="addLine" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">加入团队</view>
        <view class="team-item-desc">{{(teamInfo.id || currentTeamName) ? '请先退出当前团队' : '通过邀请码加入团队'}}</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
    <view class="team-item theme-purple {{(teamInfo.id || currentTeamName) ? 'disabled' : ''}}" bindtap="onTeamItemTap" data-action="create">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.userFill}}" mode="aspectFit" binderror="onProfileIconError" data-key="userFill" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">创建团队</view>
        <view class="team-item-desc">{{(teamInfo.id || currentTeamName) ? '请先退出当前团队' : '创建新的团队并邀请成员'}}</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
    <view class="team-item theme-orange {{!teamInfo.id && !currentTeamName ? 'disabled' : ''}}" bindtap="onTeamItemTap" data-action="manage" wx:if="{{isTeamOwner}}">
      <view class="team-item-icon">
        <image class="team-item-icon-img" src="{{iconPaths.sectionSettings}}" mode="aspectFit" binderror="onProfileIconError" data-key="sectionSettings" />
      </view>
      <view class="team-item-content">
        <view class="team-item-title">团队管理</view>
        <view class="team-item-desc">{{teamInfo.id || currentTeamName ? '管理团队成员和设置' : '请先加入或创建团队'}}</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
  </view>
</view>

<!-- 功能菜单模块 -->
<view class="menu-card">
  <view class="section-title">
    <image class="section-icon-img" src="{{iconPaths.infoLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="infoLine" />
    <text>功能菜单</text>
  </view>
  <view class="menu-list">
    <block wx:for="{{menuItems}}" wx:key="index">
      <block wx:if="{{item.isContact}}">
        <button class="menu-item" open-type="contact" session-from="{{contactSessionFrom}}" bindcontact="onContact">
          <view class="menu-item-icon {{item.bgClass}}">
            <image class="menu-item-icon-img" src="{{item.iconSrc}}" mode="aspectFit" binderror="onMenuItemIconError" data-index="{{index}}" />
          </view>
          <view class="menu-item-content">
            <view class="menu-item-title">{{item.title}}</view>
            <view class="menu-item-desc">{{item.desc}}</view>
          </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
        </button>
      </block>
      <block wx:elif="{{item.title === '分享应用'}}">
        <button class="menu-item" open-type="share">
          <view class="menu-item-icon {{item.bgClass}}">
            <image class="menu-item-icon-img" src="{{item.iconSrc}}" mode="aspectFit" binderror="onMenuItemIconError" data-index="{{index}}" />
          </view>
          <view class="menu-item-content">
            <view class="menu-item-title">{{item.title}}</view>
            <view class="menu-item-desc">{{item.desc}}</view>
          </view>
          <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
        </button>
      </block>
      <block wx:else>
        <view class="menu-item" bindtap="onMenuItemTap" data-title="{{item.title}}">
          <view class="menu-item-icon {{item.bgClass}}">
            <image class="menu-item-icon-img" src="{{item.iconSrc}}" mode="aspectFit" binderror="onMenuItemIconError" data-index="{{index}}" />
          </view>
          <view class="menu-item-content">
            <view class="menu-item-title">
              {{item.title}}
              <view class="badge-free" wx:if="{{item.badge}}">{{item.badge}}</view>
            </view>
            <view class="menu-item-desc">{{item.desc}}</view>
          </view>
          <view class="menu-item-badge" wx:if="{{item.title === '通知' && unreadCount > 0}}">{{unreadCount}}</view>
          <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
        </view>
      </block>
    </block>
    <!-- 公告中心：放入功能菜单卡片，普通用户可见 -->
    <view class="menu-item" bindtap="goAnnouncementsCenter">
      <view class="menu-item-icon bg-blue">
        <image class="menu-item-icon-img" src="{{iconPaths.infoLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="infoLine" />
      </view>
      <view class="menu-item-content">
        <view class="menu-item-title">公告中心</view>
        <view class="menu-item-desc">查看系统公告历史</view>
      </view>
      <image class="arrow-icon" src="{{iconPaths.arrowRight}}" mode="aspectFit" binderror="onProfileIconError" data-key="arrowRight" />
    </view>
  </view>
</view>
    <!-- 后台管理入口按钮（迁移卡片至后台管理页面后） -->
    <view class="admin-entry-card" wx:if="{{isSuperAdmin}}">
      <view class="admin-entry-btn" bindtap="goAdminHome">
        <image class="admin-entry-icon" src="{{iconPaths.sectionSettings}}" mode="widthFix" binderror="onProfileIconError" data-key="sectionSettings" />
        <text class="admin-entry-text">后台管理</text>
      </view>
    </view>
</view>
<!-- 版本信息模块 -->
<view class="version-card">
<image class="version-logo-img" src="/images/logo.png" mode="aspectFit" />
  <view class="version-title">鹦鹉管家</view>
  <view class="version-sub">专业的鹦鹉护理助手</view>
  <view class="version-info">版本 {{appVersion}} • 用心呵护每一只小鹦鹉</view>
</view>
</view>
<!-- 自定义底部导航 -->
<bottom-nav active="profile" />
<!-- 通知中心组件挂载到页面根部 -->
<notification-center 
  visible="{{showNotifications}}" 
  notifications="{{notifications}}" 
  bind:close="closeNotifications" 
  bind:markAllRead="markAllNotificationsRead" 
  bind:clearAll="clearAllNotifications" 
  bind:itemTap="handleNotificationTap" 
/>

<!-- 分享应用弹窗 -->
<view class="modal-overlay" wx:if="{{showShareModal}}" bindtap="hideShareOptions">
  <view class="modal-container" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">分享应用</text>
      <view class="modal-close" bindtap="hideShareOptions"><image class="modal-close-icon" src="{{iconPaths.closeLine}}" mode="aspectFit" binderror="onProfileIconError" data-key="closeLine" /></view>
    </view>
    <view class="modal-body">
      <view class="form-row">
        <text class="form-label">分享方式</text>
      </view>
      <view class="mode-options">
        <button class="btn btn-primary" open-type="share">分享给好友/群聊</button>
        <button class="btn btn-secondary" bindtap="copyShareText">复制推荐语</button>
      </view>
      <view class="form-tips" style="margin-top: 20rpx;">
        <text>提示：分享到朋友圈请用右上角菜单（已启用）。</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideShareOptions">关闭</button>
    </view>
  </view>
</view>
</view>
