<!--pages/parrots/parrots.wxml-->
<view class="page-container">
  <!-- 顶部导航统一为组件 -->
  <app-header title="我的鹦鹉" subtitle="管理您的鹦鹉宝贝们">
    <view slot="actions" class="header-btn" bindtap="addParrot">
      <image class="header-btn-icon-img" src="{{iconPaths.headerAddEmerald}}" mode="widthFix" binderror="onListIconError" data-key="headerAddEmerald" lazy-load="true"/>
    </view>
  </app-header>

  <!-- 统计概览卡片 -->
  <view class="stats-overview-card">
    <view class="background-circles">
      <view class="bg-circle bg-circle-1"></view>
      <view class="bg-circle bg-circle-2"></view>
    </view>
    <view class="stats-content">
      <text class="stats-title">鹦鹉总览</text>
      <view class="stats-grid-overview">
        <view class="stat-overview-item {{activeGenderFilter === 'all' ? 'active' : ''}}" bindtap="onOverviewFilterTap" data-filter="all">
          <text class="stat-overview-value">{{parrots.length}}</text>
          <text class="stat-overview-label">总数量</text>
        </view>
        <view class="stat-overview-item {{activeGenderFilter === 'male' ? 'active' : ''}}" bindtap="onOverviewFilterTap" data-filter="male">
          <text class="stat-overview-value">{{maleCount}}</text>
          <text class="stat-overview-label">雄性鹦鹉</text>
        </view>
        <view class="stat-overview-item {{activeGenderFilter === 'female' ? 'active' : ''}}" bindtap="onOverviewFilterTap" data-filter="female">
          <text class="stat-overview-value">{{femaleCount}}</text>
          <text class="stat-overview-label">雌性鹦鹉</text>
        </view>
      </view>
    </view>

<!-- 通过过户码添加弹窗 -->
<view class="modal-overlay" wx:if="{{showClaimByCodeModal}}" bindtap="closeClaimByCodeModal"></view>
<view class="modal-content claim-modal" wx:if="{{showClaimByCodeModal}}" catchtap="stopPropagation">
  <view class="modal-header">
    <text class="modal-title">通过过户码添加鹦鹉</text>
    <view class="modal-close" bindtap="closeClaimByCodeModal">×</view>
  </view>
  <view class="modal-body">
    <view class="input-group">
      <text class="input-label">过户码</text>
      <input class="input" placeholder="请输入过户码" value="{{claimCode}}" bindinput="onInputClaimCode"/>
    </view>
    <view class="tip-text">每个过户码仅可使用一次，请在有效期内使用。</view>
  </view>
  <view class="modal-actions">
    <button class="modal-btn cancel-btn" bindtap="closeClaimByCodeModal" disabled="{{claimingByCode}}">取消</button>
    <button class="modal-btn submit-btn" bindtap="submitClaimByCode" loading="{{claimingByCode}}" disabled="{{claimingByCode}}">确认添加</button>
  </view>
</view>
<!-- 自定义底部导航 -->
<bottom-nav active="parrots" />
    </view>

  <!-- 搜索和筛选 -->
  <view class="search-filter-card">
    <view class="search-bar">
          <image class="search-icon-img" src="{{iconPaths.searchGray}}" mode="widthFix" binderror="onListIconError" data-key="searchGray" lazy-load="true"/>
      <input 
        class="search-input" 
        placeholder="搜索鹦鹉名称、编号或脚环号..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
    </view>
    
    <view class="filter-bar">
      <picker mode="selector" range="{{speciesPickerRange}}" bindchange="onSpeciesPickerChange">
        <view class="filter-item {{selectedSpeciesId ? 'active' : ''}}">
          <text class="filter-text">{{selectedSpeciesId ? selectedSpeciesName : '品种'}}</text>
          <image class="filter-arrow-img" src="{{iconPaths.arrowDown}}" mode="widthFix" binderror="onListIconError" data-key="arrowDown" lazy-load="true"/>
        </view>
      </picker>
      <picker mode="selector" range="{{statusPickerRange}}" bindchange="onStatusPickerChange">
        <view class="filter-item {{selectedStatus ? 'active' : ''}}">
          <text class="filter-text">{{selectedStatus ? selectedStatusText : '状态'}}</text>
          <image class="filter-arrow-img" src="{{iconPaths.arrowDown}}" mode="widthFix" binderror="onListIconError" data-key="arrowDown" lazy-load="true"/>
        </view>
      </picker>
      <picker mode="selector" range="{{sortPickerRange}}" bindchange="onSortPickerChange">
        <view class="filter-item {{sortText !== '默认排序' ? 'active' : ''}}">
          <text class="filter-text">{{sortText}}</text>
          <image class="filter-arrow-img" src="{{iconPaths.arrowDown}}" mode="widthFix" binderror="onListIconError" data-key="arrowDown" lazy-load="true"/>
         </view>
      </picker>
    </view>
  </view>

  <!-- 鹦鹉列表 -->
  <view class="parrot-list" wx:if="{{displayParrots.length > 0}}">
    <view class="parrot-card" wx:for="{{displayParrots}}" wx:key="id" bindtap="viewParrotDetail" data-id="{{item.id}}">
      <view class="parrot-main">
        <!-- 鹦鹉头像 -->
        <view class="parrot-avatar">
          <image 
            class="parrot-image" 
            src="{{item.photo_thumb || item.avatar_thumb || item.photo_url || item.avatar_url || '/images/default-parrot.png'}}" 
            mode="aspectFill"
            binderror="handleImageError"
            data-id="{{item.id}}"
            lazy-load="true"
          />
        </view>
        
        <!-- 基本信息 -->
        <view class="parrot-info">
          <view class="parrot-header">
          <view class="parrot-title">
            <text class="parrot-name">{{item.name}}</text>
            <view class="gender-badge gender-{{item.gender}}">
                <image wx:if="{{item.gender === 'male'}}" class="gender-icon-img" src="/images/remix/men-line.png" mode="widthFix" lazy-load="true" />
                <image wx:elif="{{item.gender === 'female'}}" class="gender-icon-img" src="/images/remix/women-line.png" mode="widthFix" lazy-load="true" />
                <image wx:else class="gender-icon-img" src="/images/remix/question-mark.png" mode="widthFix" lazy-load="true" />
            </view>
          </view>
            <view class="health-badge health-{{item.current_health_status || item.health_status}}">
              <text wx:if="{{(item.current_health_status || item.health_status) === 'healthy'}}">健康</text>
              <text wx:elif="{{(item.current_health_status || item.health_status) === 'sick'}}">生病</text>
              <text wx:elif="{{(item.current_health_status || item.health_status) === 'recovering'}}">康复中</text>
              <text wx:elif="{{(item.current_health_status || item.health_status) === 'observation'}}">观察中</text>
              <text wx:else>健康</text>
            </view>
          </view>
          <text class="parrot-species">{{item.species_name}} • {{item.age_display || '未知'}} • {{item.weight_display || '未记录'}}</text>
          <view class="parrot-status">
            <view class="status-item">
              <image class="status-icon-img" src="{{iconPaths.statusRestaurantOrange}}" mode="widthFix" binderror="onListIconError" data-key="statusRestaurantOrange" lazy-load="true"/>
              <text class="status-text">{{item.last_feed || ''}}</text>
            </view>
          </view>
        </view>
        
        <!-- 箭头图标 -->
        <view class="parrot-arrow">
            <image class="arrow-icon-img" src="{{iconPaths.arrowRight}}" mode="widthFix" binderror="onListIconError" data-key="arrowRight" lazy-load="true"/>
        </view>
      </view>
    </view>
  </view>

  <!-- 添加鹦鹉按钮（位于列表末尾） -->
  <view class="add-parrot-action" wx:if="{{parrots.length > 0}}">
    <view class="add-parrot-card">
      <view class="add-parrot-btn" bindtap="addParrot">
          <image class="add-parrot-btn-icon-img" src="{{iconPaths.addParrotEmerald}}" mode="widthFix" binderror="onListIconError" data-key="addParrotEmerald" lazy-load="true"/>
        <text class="add-parrot-btn-text">添加鹦鹉</text>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state-card" wx:if="{{parrots.length === 0 && !loading}}">
    <view class="empty-content">
      <view class="empty-icon">🦜</view>
      <text class="empty-title" wx:if="{{isLogin}}">还没有鹦鹉记录</text>
      <text class="empty-title" wx:else>游客模式</text>
      <text class="empty-subtitle" wx:if="{{isLogin}}">点击下方按钮添加您的第一只鹦鹉</text>
      <text class="empty-subtitle" wx:else>登录后可以管理您的鹦鹉档案</text>
      <view class="empty-btn" wx:if="{{isLogin}}" bindtap="addParrot">
        <view class="empty-btn-text">添加鹦鹉</view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- 品种筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showSpeciesModal}}" bindtap="hideSpeciesFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择品种</text>
      <view class="modal-close" bindtap="hideSpeciesFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSpecies" data-id="" data-name="">
        <text class="option-text">全部品种</text>
      </view>
      <view class="filter-option" wx:for="{{speciesList}}" wx:key="id" bindtap="selectSpecies" data-id="{{item.id}}" data-name="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
      </view>
    </view>
  </view>
</view>

<!-- 复用组件：添加/编辑鹦鹉弹窗 -->
<parrot-modal 
  visible="{{showParrotModal}}" 
  mode="{{parrotFormMode}}" 
  title="{{parrotFormTitle}}"
  parrot="{{currentParrotForm}}"
  parrotTypes="{{parrotTypes}}"
  speciesList="{{speciesList}}"
  bind:cancel="onParrotModalCancel"
  bind:submit="onParrotModalSubmit"
/>

<!-- 状态筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showStatusModal}}" bindtap="hideStatusFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择状态</text>
      <view class="modal-close" bindtap="hideStatusFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectStatus" data-status="">
        <text class="option-text">全部状态</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="healthy">
        <text class="option-text">健康</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="sick">
        <text class="option-text">生病</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="recovering">
        <text class="option-text">康复中</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="observation">
        <text class="option-text">观察中</text>
      </view>
    </view>
  </view>
</view>

<!-- 排序筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showSortModal}}" bindtap="hideSortFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">排序方式</text>
      <view class="modal-close" bindtap="hideSortFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="asc">
        <text class="option-text">名称 A-Z</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="desc">
        <text class="option-text">名称 Z-A</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="desc">
        <text class="option-text">年龄从小到大</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="asc">
        <text class="option-text">年龄从大到小</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="created_at" data-order="desc">
        <text class="option-text">最新添加</text>
      </view>
    </view>
  </view>
</view>
