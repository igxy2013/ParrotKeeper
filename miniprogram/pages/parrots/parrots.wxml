<!--pages/parrots/parrots.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨å¯¼èˆªç»Ÿä¸€ä¸ºç»„ä»¶ -->
  <app-header title="æˆ‘çš„é¹¦é¹‰" subtitle="ç®¡ç†æ‚¨çš„é¹¦é¹‰å®è´ä»¬">
    <view slot="actions" class="header-btn" bindtap="addParrot">
      <text class="header-btn-icon">+</text>
    </view>
  </app-header>

  <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
  <view class="stats-overview-card">
    <view class="background-circles">
      <view class="bg-circle bg-circle-1"></view>
      <view class="bg-circle bg-circle-2"></view>
    </view>
    <view class="stats-content">
      <text class="stats-title">é¹¦é¹‰æ€»è§ˆ</text>
      <view class="stats-grid-overview">
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{parrots.length}}</text>
          <text class="stat-overview-label">æ€»æ•°é‡</text>
        </view>
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{maleCount}}</text>
          <text class="stat-overview-label">é›„æ€§é¹¦é¹‰</text>
        </view>
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{femaleCount}}</text>
          <text class="stat-overview-label">é›Œæ€§é¹¦é¹‰</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-card">
    <view class="search-bar">
      <text class="search-icon">ğŸ”</text>
      <input 
        class="search-input" 
        placeholder="æœç´¢é¹¦é¹‰åç§°ã€ç¼–å·æˆ–è„šç¯å·..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
    </view>
    
    <view class="filter-bar">
      <view class="filter-item {{selectedSpeciesId ? 'active' : ''}}" bindtap="showSpeciesFilter">
        <text class="filter-text">{{selectedSpeciesId ? selectedSpeciesName : 'å“ç§'}}</text>
        <text class="filter-arrow">â–¼</text>
      </view>
      <view class="filter-item {{selectedStatus ? 'active' : ''}}" bindtap="showStatusFilter">
        <text class="filter-text">{{selectedStatus ? selectedStatusText : 'çŠ¶æ€'}}</text>
        <text class="filter-arrow">â–¼</text>
      </view>
      <view class="filter-item {{sortText !== 'é»˜è®¤æ’åº' ? 'active' : ''}}" bindtap="showSortFilter">
        <text class="filter-text">{{sortText}}</text>
        <text class="filter-arrow">â–¼</text>
      </view>
    </view>
  </view>

  <!-- é¹¦é¹‰åˆ—è¡¨ -->
  <view class="parrot-list" wx:if="{{parrots.length > 0}}">
    <view class="parrot-card" wx:for="{{parrots}}" wx:key="id" bindtap="viewParrotDetail" data-id="{{item.id}}">
      <view class="parrot-main">
        <!-- é¹¦é¹‰å¤´åƒ -->
        <view class="parrot-avatar">
          <image 
            class="parrot-image" 
            src="{{item.photo_url || item.avatar_url || '/images/default-parrot.svg'}}" 
            mode="aspectFill"
            binderror="handleImageError"
            data-id="{{item.id}}"
          />
        </view>
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view class="parrot-info">
          <view class="parrot-header">
            <text class="parrot-name">{{item.name}}</text>
            <view class="health-badge health-{{item.health_status}}">
              <text wx:if="{{item.health_status === 'healthy'}}">å¥åº·</text>
              <text wx:elif="{{item.health_status === 'sick'}}">ç”Ÿç—…</text>
              <text wx:elif="{{item.health_status === 'recovering'}}">åº·å¤ä¸­</text>
              <text wx:else="{{item.health_status === 'observation'}}">è§‚å¯Ÿä¸­</text>
            </view>
          </view>
          <text class="parrot-species">{{item.species_name}} â€¢ {{item.age_days ? item.age_days + 'å¤©' : 'æœªçŸ¥'}} â€¢ {{item.weight ? item.weight + 'g' : ''}}</text>
          <view class="parrot-status">
            <view class="status-item">
              <text class="status-icon">ğŸ½ï¸</text>
              <text class="status-text">{{item.last_feed || '2å°æ—¶å‰'}}</text>
            </view>
          </view>
        </view>
        
        <!-- ç®­å¤´å›¾æ ‡ -->
        <view class="parrot-arrow">
          <text class="arrow-icon">â†’</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state-card" wx:if="{{parrots.length === 0 && !loading}}">
    <view class="empty-content">
      <view class="empty-icon">ğŸ¦œ</view>
      <text class="empty-title" wx:if="{{isLogin}}">è¿˜æ²¡æœ‰é¹¦é¹‰è®°å½•</text>
      <text class="empty-title" wx:else>æ¸¸å®¢æ¨¡å¼</text>
      <text class="empty-subtitle" wx:if="{{isLogin}}">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€åªé¹¦é¹‰</text>
      <text class="empty-subtitle" wx:else>ç™»å½•åå¯ä»¥ç®¡ç†æ‚¨çš„é¹¦é¹‰æ¡£æ¡ˆ</text>
      <view class="empty-btn" wx:if="{{isLogin}}" bindtap="addParrot">
        <text class="empty-btn-text">æ·»åŠ é¹¦é¹‰</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- å“ç§ç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showSpeciesModal}}" bindtap="hideSpeciesFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å“ç§</text>
      <view class="modal-close" bindtap="hideSpeciesFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSpecies" data-id="" data-name="">
        <text class="option-text">å…¨éƒ¨å“ç§</text>
      </view>
      <view class="filter-option" wx:for="{{speciesList}}" wx:key="id" bindtap="selectSpecies" data-id="{{item.id}}" data-name="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
      </view>
    </view>
  </view>
</view>

<!-- æ·»åŠ é¹¦é¹‰å¼¹çª—ï¼ˆä¸¥æ ¼å‚è€ƒå‚è€ƒAPPè®¾è®¡é£æ ¼ï¼‰ -->
<view wx:if="{{showAddParrotModal}}" class="modal-overlay" catchtouchmove="true" bindtap="closeAddParrotModal">
  <view class="modal-content" catchtap="stopPropagation" style="margin-top: {{modalTopOffsetPx}}px; margin-bottom: {{modalBottomOffsetPx}}px;">
    <!-- å¤´éƒ¨æ¸å˜åŒºåŸŸ -->
    <view class="modal-header-gradient">
      <view class="modal-header-row">
        <text class="modal-title">æ·»åŠ æ–°é¹¦é¹‰</text>
        <view class="modal-close-btn" bindtap="closeAddParrotModal"><text class="modal-close-icon">âœ•</text></view>
      </view>
    </view>

    <!-- å¼¹çª—å†…å®¹ -->
    <scroll-view scroll-y="true" class="modal-scroll">
      <view class="form-section">
        <!-- åå­— -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">â¤</text>é¹¦é¹‰åå­— *</text>
          <input class="text-input" placeholder="ç»™æ‚¨çš„é¹¦é¹‰èµ·ä¸ªå¯çˆ±çš„åå­—" value="{{newParrot.name}}" bindinput="onParrotNameInput" />
        </view>

        <!-- å“ç§ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸƒ</text>é¹¦é¹‰å“ç§ *</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{parrotTypes}}" value="{{typeIndex}}" bindchange="onTypePickerChange">
              <view class="picker-display">
                <text>{{newParrot.type ? newParrot.type : 'è¯·é€‰æ‹©å“ç§'}}</text>
                <text class="picker-arrow">â–¾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- ç¼–å· ä¸ è„šç¯å· -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">#</text>é¹¦é¹‰ç¼–å·</text>
            <input class="text-input" placeholder="ä¾‹å¦‚ï¼šPK-2025-001" value="{{newParrot.parrot_number}}" bindinput="onParrotNumberInput" />
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">ğŸª™</text>è„šç¯å·</text>
            <input class="text-input" placeholder="ä¾‹å¦‚ï¼šR-88921" value="{{newParrot.ring_number}}" bindinput="onRingNumberInput" />
          </view>
        </view>

        <!-- ä½“é‡ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">âš–</text>ä½“é‡(g)</text>
          <input class="text-input" placeholder="å¦‚: 35" value="{{newParrot.weight}}" bindinput="onParrotWeightInput" />
        </view>

        <!-- æ€§åˆ« ä¸ é¢œè‰² -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">ğŸ‘¤</text>æ€§åˆ«</text>
            <view class="gender-row">
              <view class="gender-btn {{newParrot.gender === 'é›„æ€§' ? 'gender-male active' : 'gender-male'}}" bindtap="setParrotGender" data-gender="é›„æ€§">é›„æ€§</view>
              <view class="gender-btn {{newParrot.gender === 'é›Œæ€§' ? 'gender-female active' : 'gender-female'}}" bindtap="setParrotGender" data-gender="é›Œæ€§">é›Œæ€§</view>
            </view>
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">ğŸ¨</text>ä¸»è¦é¢œè‰²</text>
            <input class="text-input" placeholder="å¦‚: ç»¿è‰²" value="{{newParrot.color}}" bindinput="onParrotColorInput" />
          </view>
        </view>

        <!-- å‡ºç”Ÿæ—¥æœŸ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸ“…</text>å‡ºç”Ÿæ—¥æœŸ</text>
          <picker mode="date" value="{{newParrot.birthDate}}" bindchange="onBirthDateChange">
            <view class="picker-display">
              <text>{{newParrot.birthDate ? newParrot.birthDate : 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
              <text class="picker-arrow">â–¾</text>
            </view>
          </picker>
        </view>

        <!-- å…¥ä½æ—¥æœŸ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸ </text>å…¥ä½æ—¥æœŸ</text>
          <picker mode="date" value="{{newParrot.acquisition_date}}" bindchange="onAcquisitionDateChange">
            <view class="picker-display">
              <text>{{newParrot.acquisition_date ? newParrot.acquisition_date : 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
              <text class="picker-arrow">â–¾</text>
            </view>
          </picker>
        </view>

        <!-- é¹¦é¹‰ç…§ç‰‡ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸ“·</text>é¹¦é¹‰ç…§ç‰‡</text>
          <view class="photo-upload">
            <view class="photo-preview" wx:if="{{newParrot.photo_url}}">
              <image class="preview-image" src="{{newParrot.photo_url}}" mode="aspectFill" bindtap="previewParrotPhoto" />
              <view class="photo-actions">
                <view class="action-btn" bindtap="deleteParrotPhoto"><text class="action-icon">ğŸ—‘ï¸</text></view>
              </view>
            </view>
            <view class="upload-area" wx:else bindtap="chooseParrotPhoto">
              <view class="upload-icon">ğŸ“·</view>
              <text class="upload-text">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</text>
            </view>
          </view>
        </view>

        <!-- å¤‡æ³¨ä¿¡æ¯ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸ“</text>å¤‡æ³¨ä¿¡æ¯</text>
          <textarea class="textarea-input" placeholder="è®°å½•ä¸€äº›ç‰¹æ®Šä¿¡æ¯ï¼Œå¦‚æ€§æ ¼ç‰¹ç‚¹ã€å–œå¥½ç­‰..." value="{{newParrot.notes}}" bindinput="onParrotNotesInput" />
        </view>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="closeAddParrotModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="submitNewParrot" disabled="{{!newParrot.name || !newParrot.type}}">æ·»åŠ é¹¦é¹‰</button>
    </view>
  </view>
</view>

<!-- çŠ¶æ€ç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showStatusModal}}" bindtap="hideStatusFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©çŠ¶æ€</text>
      <view class="modal-close" bindtap="hideStatusFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectStatus" data-status="">
        <text class="option-text">å…¨éƒ¨çŠ¶æ€</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="healthy">
        <text class="option-text">å¥åº·</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="sick">
        <text class="option-text">ç”Ÿç—…</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="recovering">
        <text class="option-text">åº·å¤ä¸­</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="observation">
        <text class="option-text">è§‚å¯Ÿä¸­</text>
      </view>
    </view>
  </view>
</view>

<!-- æ’åºç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showSortModal}}" bindtap="hideSortFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">æ’åºæ–¹å¼</text>
      <view class="modal-close" bindtap="hideSortFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="asc">
        <text class="option-text">åç§° A-Z</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="desc">
        <text class="option-text">åç§° Z-A</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="desc">
        <text class="option-text">å¹´é¾„ä»å°åˆ°å¤§</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="asc">
        <text class="option-text">å¹´é¾„ä»å¤§åˆ°å°</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="created_at" data-order="desc">
        <text class="option-text">æœ€æ–°æ·»åŠ </text>
      </view>
    </view>
  </view>
</view>