<!--pages/parrots/parrots.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨å¯¼èˆªç»Ÿä¸€ä¸ºç»„ä»¶ -->
  <app-header title="æˆ‘çš„é¹¦é¹‰" subtitle="ç®¡ç†æ‚¨çš„é¹¦é¹‰å®è´ä»¬">
    <view slot="actions" class="header-btn" bindtap="addParrot">
      <image class="header-btn-icon-img" src="{{iconPaths.headerAddEmerald}}" mode="widthFix" binderror="onListIconError" data-key="headerAddEmerald"/>
    </view>
  </app-header>

  <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
  <view class="stats-overview-card">
    <view class="background-circles">
      <view class="bg-circle bg-circle-1"></view>
      <view class="bg-circle bg-circle-2"></view>
    </view>
    <view class="stats-content">
      <text class="stats-title">é¹¦é¹‰æ€»è§ˆ</text>
      <view class="stats-grid-overview">
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{parrots.length}}</text>
          <text class="stat-overview-label">æ€»æ•°é‡</text>
        </view>
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{maleCount}}</text>
          <text class="stat-overview-label">é›„æ€§é¹¦é¹‰</text>
        </view>
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{femaleCount}}</text>
          <text class="stat-overview-label">é›Œæ€§é¹¦é¹‰</text>
</view>
</view>

<!-- é€šè¿‡è¿‡æˆ·ç æ·»åŠ å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showClaimByCodeModal}}" bindtap="closeClaimByCodeModal"></view>
<view class="modal-content claim-modal" wx:if="{{showClaimByCodeModal}}" catchtap="stopPropagation">
  <view class="modal-header">
    <text class="modal-title">é€šè¿‡è¿‡æˆ·ç æ·»åŠ é¹¦é¹‰</text>
    <view class="modal-close" bindtap="closeClaimByCodeModal">Ã—</view>
  </view>
  <view class="modal-body">
    <view class="input-group">
      <text class="input-label">è¿‡æˆ·ç </text>
      <input class="input" placeholder="è¯·è¾“å…¥è¿‡æˆ·ç " value="{{claimCode}}" bindinput="onInputClaimCode"/>
    </view>
    <view class="tip-text">æ¯ä¸ªè¿‡æˆ·ç ä»…å¯ä½¿ç”¨ä¸€æ¬¡ï¼Œè¯·åœ¨æœ‰æ•ˆæœŸå†…ä½¿ç”¨ã€‚</view>
  </view>
  <view class="modal-actions">
    <button class="modal-btn cancel-btn" bindtap="closeClaimByCodeModal" disabled="{{claimingByCode}}">å–æ¶ˆ</button>
    <button class="modal-btn submit-btn" bindtap="submitClaimByCode" loading="{{claimingByCode}}" disabled="{{claimingByCode}}">ç¡®è®¤æ·»åŠ </button>
  </view>
</view>
<!-- è‡ªå®šä¹‰åº•éƒ¨å¯¼èˆª -->
<bottom-nav active="parrots" />
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-card">
    <view class="search-bar">
          <image class="search-icon-img" src="{{iconPaths.searchGray}}" mode="widthFix" binderror="onListIconError" data-key="searchGray"/>
      <input 
        class="search-input" 
        placeholder="æœç´¢é¹¦é¹‰åç§°ã€ç¼–å·æˆ–è„šç¯å·..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
    </view>
    
    <view class="filter-bar">
      <picker mode="selector" range="{{speciesPickerRange}}" bindchange="onSpeciesPickerChange">
        <view class="filter-item {{selectedSpeciesId ? 'active' : ''}}">
          <text class="filter-text">{{selectedSpeciesId ? selectedSpeciesName : 'å“ç§'}}</text>
            <image class="filter-arrow-img" src="{{iconPaths.arrowDown}}" mode="widthFix" binderror="onListIconError" data-key="arrowDown"/>
        </view>
      </picker>
      <picker mode="selector" range="{{statusPickerRange}}" bindchange="onStatusPickerChange">
        <view class="filter-item {{selectedStatus ? 'active' : ''}}">
          <text class="filter-text">{{selectedStatus ? selectedStatusText : 'çŠ¶æ€'}}</text>
            <image class="filter-arrow-img" src="{{iconPaths.arrowDown}}" mode="widthFix" binderror="onListIconError" data-key="arrowDown"/>
        </view>
      </picker>
      <picker mode="selector" range="{{sortPickerRange}}" bindchange="onSortPickerChange">
        <view class="filter-item {{sortText !== 'é»˜è®¤æ’åº' ? 'active' : ''}}">
          <text class="filter-text">{{sortText}}</text>
            <image class="filter-arrow-img" src="{{iconPaths.arrowDown}}" mode="widthFix" binderror="onListIconError" data-key="arrowDown"/>
         </view>
      </picker>
    </view>
  </view>

  <!-- é¹¦é¹‰åˆ—è¡¨ -->
  <view class="parrot-list" wx:if="{{parrots.length > 0}}">
    <view class="parrot-card" wx:for="{{parrots}}" wx:key="id" bindtap="viewParrotDetail" data-id="{{item.id}}">
      <view class="parrot-main">
        <!-- é¹¦é¹‰å¤´åƒ -->
        <view class="parrot-avatar">
          <image 
            class="parrot-image" 
            src="{{item.photo_url || item.avatar_url || '/images/default-parrot.png'}}" 
            mode="aspectFit"
            binderror="handleImageError"
            data-id="{{item.id}}"
          />
        </view>
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view class="parrot-info">
          <view class="parrot-header">
          <view class="parrot-title">
            <text class="parrot-name">{{item.name}}</text>
            <view class="gender-badge gender-{{item.gender}}">
                <image wx:if="{{item.gender === 'male'}}" class="gender-icon-img" src="/images/remix/men-line.png" mode="widthFix" />
                <image wx:elif="{{item.gender === 'female'}}" class="gender-icon-img" src="/images/remix/women-line.png" mode="widthFix" />
                <image wx:else class="gender-icon-img" src="/images/remix/question-mark.png" mode="widthFix" />
            </view>
          </view>
            <view class="health-badge health-{{item.current_health_status || item.health_status}}">
              <text wx:if="{{(item.current_health_status || item.health_status) === 'healthy'}}">å¥åº·</text>
              <text wx:elif="{{(item.current_health_status || item.health_status) === 'sick'}}">ç”Ÿç—…</text>
              <text wx:elif="{{(item.current_health_status || item.health_status) === 'recovering'}}">åº·å¤ä¸­</text>
              <text wx:elif="{{(item.current_health_status || item.health_status) === 'observation'}}">è§‚å¯Ÿä¸­</text>
              <text wx:else>å¥åº·</text>
            </view>
          </view>
          <text class="parrot-species">{{item.species_name}} â€¢ {{item.age_days ? item.age_days + 'å¤©' : 'æœªçŸ¥'}} â€¢ {{item.weight ? (item.weight % 1 === 0 ? item.weight : item.weight.toFixed(1)) + 'g' : ''}}</text>
          <view class="parrot-status">
            <view class="status-item">
              <image class="status-icon-img" src="{{iconPaths.statusRestaurantOrange}}" mode="widthFix" binderror="onListIconError" data-key="statusRestaurantOrange"/>
              <text class="status-text">{{item.last_feed || '2å°æ—¶å‰'}}</text>
            </view>
          </view>
        </view>
        
        <!-- ç®­å¤´å›¾æ ‡ -->
        <view class="parrot-arrow">
            <image class="arrow-icon-img" src="{{iconPaths.arrowRight}}" mode="widthFix" binderror="onListIconError" data-key="arrowRight"/>
        </view>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ é¹¦é¹‰æŒ‰é’®ï¼ˆä½äºåˆ—è¡¨æœ«å°¾ï¼‰ -->
  <view class="add-parrot-action" wx:if="{{parrots.length > 0}}">
    <view class="add-parrot-card">
      <view class="add-parrot-btn" bindtap="addParrot">
          <image class="add-parrot-btn-icon-img" src="{{iconPaths.addParrotEmerald}}" mode="widthFix" binderror="onListIconError" data-key="addParrotEmerald"/>
        <text class="add-parrot-btn-text">æ·»åŠ é¹¦é¹‰</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state-card" wx:if="{{parrots.length === 0 && !loading}}">
    <view class="empty-content">
      <view class="empty-icon">ğŸ¦œ</view>
      <text class="empty-title" wx:if="{{isLogin}}">è¿˜æ²¡æœ‰é¹¦é¹‰è®°å½•</text>
      <text class="empty-title" wx:else>æ¸¸å®¢æ¨¡å¼</text>
      <text class="empty-subtitle" wx:if="{{isLogin}}">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€åªé¹¦é¹‰</text>
      <text class="empty-subtitle" wx:else>ç™»å½•åå¯ä»¥ç®¡ç†æ‚¨çš„é¹¦é¹‰æ¡£æ¡ˆ</text>
      <view class="empty-btn" wx:if="{{isLogin}}" bindtap="addParrot">
        <view class="empty-btn-text">æ·»åŠ é¹¦é¹‰</view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- å“ç§ç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showSpeciesModal}}" bindtap="hideSpeciesFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å“ç§</text>
      <view class="modal-close" bindtap="hideSpeciesFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSpecies" data-id="" data-name="">
        <text class="option-text">å…¨éƒ¨å“ç§</text>
      </view>
      <view class="filter-option" wx:for="{{speciesList}}" wx:key="id" bindtap="selectSpecies" data-id="{{item.id}}" data-name="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
      </view>
    </view>
  </view>
</view>

<!-- å¤ç”¨ç»„ä»¶ï¼šæ·»åŠ /ç¼–è¾‘é¹¦é¹‰å¼¹çª— -->
<parrot-modal 
  visible="{{showParrotModal}}" 
  mode="{{parrotFormMode}}" 
  title="{{parrotFormTitle}}"
  parrot="{{currentParrotForm}}"
  parrotTypes="{{parrotTypes}}"
  speciesList="{{speciesList}}"
  bind:cancel="onParrotModalCancel"
  bind:submit="onParrotModalSubmit"
/>

<!-- çŠ¶æ€ç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showStatusModal}}" bindtap="hideStatusFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©çŠ¶æ€</text>
      <view class="modal-close" bindtap="hideStatusFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectStatus" data-status="">
        <text class="option-text">å…¨éƒ¨çŠ¶æ€</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="healthy">
        <text class="option-text">å¥åº·</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="sick">
        <text class="option-text">ç”Ÿç—…</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="recovering">
        <text class="option-text">åº·å¤ä¸­</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="observation">
        <text class="option-text">è§‚å¯Ÿä¸­</text>
      </view>
    </view>
  </view>
</view>

<!-- æ’åºç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showSortModal}}" bindtap="hideSortFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">æ’åºæ–¹å¼</text>
      <view class="modal-close" bindtap="hideSortFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="asc">
        <text class="option-text">åç§° A-Z</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="desc">
        <text class="option-text">åç§° Z-A</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="desc">
        <text class="option-text">å¹´é¾„ä»å°åˆ°å¤§</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="asc">
        <text class="option-text">å¹´é¾„ä»å¤§åˆ°å°</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="created_at" data-order="desc">
        <text class="option-text">æœ€æ–°æ·»åŠ </text>
      </view>
    </view>
  </view>
</view>
