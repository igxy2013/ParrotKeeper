<!--pages/parrots/parrots.wxml-->
<view class="page-container">
  <!-- 顶部导航统一为组件 -->
  <app-header title="我的鹦鹉" subtitle="管理您的鹦鹉宝贝们">
    <view slot="actions" class="header-btn" bindtap="addParrot">
      <text class="header-btn-icon">+</text>
    </view>
  </app-header>

  <!-- 统计概览卡片 -->
  <view class="stats-overview-card">
    <view class="background-circles">
      <view class="bg-circle bg-circle-1"></view>
      <view class="bg-circle bg-circle-2"></view>
    </view>
    <view class="stats-content">
      <text class="stats-title">鹦鹉总览</text>
      <view class="stats-grid-overview">
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{parrots.length}}</text>
          <text class="stat-overview-label">总数量</text>
        </view>
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{maleCount}}</text>
          <text class="stat-overview-label">雄性鹦鹉</text>
        </view>
        <view class="stat-overview-item">
          <text class="stat-overview-value">{{femaleCount}}</text>
          <text class="stat-overview-label">雌性鹦鹉</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 搜索和筛选 -->
  <view class="search-filter-card">
    <view class="search-bar">
      <text class="search-icon">🔍</text>
      <input 
        class="search-input" 
        placeholder="搜索鹦鹉名称、编号或脚环号..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
    </view>
    
    <view class="filter-bar">
      <view class="filter-item {{selectedSpeciesId ? 'active' : ''}}" bindtap="showSpeciesFilter">
        <text class="filter-text">{{selectedSpeciesId ? selectedSpeciesName : '品种'}}</text>
        <text class="filter-arrow">▼</text>
      </view>
      <view class="filter-item {{selectedStatus ? 'active' : ''}}" bindtap="showStatusFilter">
        <text class="filter-text">{{selectedStatus ? selectedStatusText : '状态'}}</text>
        <text class="filter-arrow">▼</text>
      </view>
      <view class="filter-item {{sortText !== '默认排序' ? 'active' : ''}}" bindtap="showSortFilter">
        <text class="filter-text">{{sortText}}</text>
        <text class="filter-arrow">▼</text>
      </view>
    </view>
  </view>

  <!-- 鹦鹉列表 -->
  <view class="parrot-list" wx:if="{{parrots.length > 0}}">
    <view class="parrot-card" wx:for="{{parrots}}" wx:key="id" bindtap="viewParrotDetail" data-id="{{item.id}}">
      <view class="parrot-main">
        <!-- 鹦鹉头像 -->
        <view class="parrot-avatar">
          <image 
            class="parrot-image" 
            src="{{item.photo_url || item.avatar_url || '/images/default-parrot.svg'}}" 
            mode="aspectFill"
            binderror="handleImageError"
            data-id="{{item.id}}"
          />
        </view>
        
        <!-- 基本信息 -->
        <view class="parrot-info">
          <view class="parrot-header">
            <text class="parrot-name">{{item.name}}</text>
            <view class="health-badge health-{{item.health_status}}">
              <text wx:if="{{item.health_status === 'healthy'}}">健康</text>
              <text wx:elif="{{item.health_status === 'sick'}}">生病</text>
              <text wx:elif="{{item.health_status === 'recovering'}}">康复中</text>
              <text wx:else="{{item.health_status === 'observation'}}">观察中</text>
            </view>
          </view>
          <text class="parrot-species">{{item.species_name}} • {{item.age_days ? item.age_days + '天' : '未知'}} • {{item.weight ? item.weight + 'g' : ''}}</text>
          <view class="parrot-status">
            <view class="status-item">
              <text class="status-icon">🍽️</text>
              <text class="status-text">{{item.last_feed || '2小时前'}}</text>
            </view>
          </view>
        </view>
        
        <!-- 箭头图标 -->
        <view class="parrot-arrow">
          <text class="arrow-icon">→</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state-card" wx:if="{{parrots.length === 0 && !loading}}">
    <view class="empty-content">
      <view class="empty-icon">🦜</view>
      <text class="empty-title" wx:if="{{isLogin}}">还没有鹦鹉记录</text>
      <text class="empty-title" wx:else>游客模式</text>
      <text class="empty-subtitle" wx:if="{{isLogin}}">点击下方按钮添加您的第一只鹦鹉</text>
      <text class="empty-subtitle" wx:else>登录后可以管理您的鹦鹉档案</text>
      <view class="empty-btn" wx:if="{{isLogin}}" bindtap="addParrot">
        <text class="empty-btn-text">添加鹦鹉</text>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>

<!-- 品种筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showSpeciesModal}}" bindtap="hideSpeciesFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择品种</text>
      <view class="modal-close" bindtap="hideSpeciesFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSpecies" data-id="" data-name="">
        <text class="option-text">全部品种</text>
      </view>
      <view class="filter-option" wx:for="{{speciesList}}" wx:key="id" bindtap="selectSpecies" data-id="{{item.id}}" data-name="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
      </view>
    </view>
  </view>
</view>

<!-- 添加鹦鹉弹窗（严格参考参考APP设计风格） -->
<view wx:if="{{showAddParrotModal}}" class="modal-overlay" catchtouchmove="true" bindtap="closeAddParrotModal">
  <view class="modal-content" catchtap="stopPropagation" style="margin-top: {{modalTopOffsetPx}}px; margin-bottom: {{modalBottomOffsetPx}}px;">
    <!-- 头部渐变区域 -->
    <view class="modal-header-gradient">
      <view class="modal-header-row">
        <text class="modal-title">添加新鹦鹉</text>
        <view class="modal-close-btn" bindtap="closeAddParrotModal"><text class="modal-close-icon">✕</text></view>
      </view>
    </view>

    <!-- 弹窗内容 -->
    <scroll-view scroll-y="true" class="modal-scroll">
      <view class="form-section">
        <!-- 名字 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">❤</text>鹦鹉名字 *</text>
          <input class="text-input" placeholder="给您的鹦鹉起个可爱的名字" value="{{newParrot.name}}" bindinput="onParrotNameInput" />
        </view>

        <!-- 品种 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">🍃</text>鹦鹉品种 *</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{parrotTypes}}" value="{{typeIndex}}" bindchange="onTypePickerChange">
              <view class="picker-display">
                <text>{{newParrot.type ? newParrot.type : '请选择品种'}}</text>
                <text class="picker-arrow">▾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- 编号 与 脚环号 -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">#</text>鹦鹉编号</text>
            <input class="text-input" placeholder="例如：PK-2025-001" value="{{newParrot.parrot_number}}" bindinput="onParrotNumberInput" />
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">🪙</text>脚环号</text>
            <input class="text-input" placeholder="例如：R-88921" value="{{newParrot.ring_number}}" bindinput="onRingNumberInput" />
          </view>
        </view>

        <!-- 体重 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">⚖</text>体重(g)</text>
          <input class="text-input" placeholder="如: 35" value="{{newParrot.weight}}" bindinput="onParrotWeightInput" />
        </view>

        <!-- 性别 与 颜色 -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">👤</text>性别</text>
            <view class="gender-row">
              <view class="gender-btn {{newParrot.gender === '雄性' ? 'gender-male active' : 'gender-male'}}" bindtap="setParrotGender" data-gender="雄性">雄性</view>
              <view class="gender-btn {{newParrot.gender === '雌性' ? 'gender-female active' : 'gender-female'}}" bindtap="setParrotGender" data-gender="雌性">雌性</view>
            </view>
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">🎨</text>主要颜色</text>
            <input class="text-input" placeholder="如: 绿色" value="{{newParrot.color}}" bindinput="onParrotColorInput" />
          </view>
        </view>

        <!-- 出生日期 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">📅</text>出生日期</text>
          <picker mode="date" value="{{newParrot.birthDate}}" bindchange="onBirthDateChange">
            <view class="picker-display">
              <text>{{newParrot.birthDate ? newParrot.birthDate : '请选择日期'}}</text>
              <text class="picker-arrow">▾</text>
            </view>
          </picker>
        </view>

        <!-- 入住日期 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">🏠</text>入住日期</text>
          <picker mode="date" value="{{newParrot.acquisition_date}}" bindchange="onAcquisitionDateChange">
            <view class="picker-display">
              <text>{{newParrot.acquisition_date ? newParrot.acquisition_date : '请选择日期'}}</text>
              <text class="picker-arrow">▾</text>
            </view>
          </picker>
        </view>

        <!-- 鹦鹉照片 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">📷</text>鹦鹉照片</text>
          <view class="photo-upload">
            <view class="photo-preview" wx:if="{{newParrot.photo_url}}">
              <image class="preview-image" src="{{newParrot.photo_url}}" mode="aspectFill" bindtap="previewParrotPhoto" />
              <view class="photo-actions">
                <view class="action-btn" bindtap="deleteParrotPhoto"><text class="action-icon">🗑️</text></view>
              </view>
            </view>
            <view class="upload-area" wx:else bindtap="chooseParrotPhoto">
              <view class="upload-icon">📷</view>
              <text class="upload-text">点击上传照片</text>
            </view>
          </view>
        </view>

        <!-- 备注信息 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">📝</text>备注信息</text>
          <textarea class="textarea-input" placeholder="记录一些特殊信息，如性格特点、喜好等..." value="{{newParrot.notes}}" bindinput="onParrotNotesInput" />
        </view>
      </view>
    </scroll-view>

    <!-- 底部按钮 -->
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="closeAddParrotModal">取消</button>
      <button class="btn-primary" bindtap="submitNewParrot" disabled="{{!newParrot.name || !newParrot.type}}">添加鹦鹉</button>
    </view>
  </view>
</view>

<!-- 状态筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showStatusModal}}" bindtap="hideStatusFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择状态</text>
      <view class="modal-close" bindtap="hideStatusFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectStatus" data-status="">
        <text class="option-text">全部状态</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="healthy">
        <text class="option-text">健康</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="sick">
        <text class="option-text">生病</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="recovering">
        <text class="option-text">康复中</text>
      </view>
      <view class="filter-option" bindtap="selectStatus" data-status="observation">
        <text class="option-text">观察中</text>
      </view>
    </view>
  </view>
</view>

<!-- 排序筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showSortModal}}" bindtap="hideSortFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">排序方式</text>
      <view class="modal-close" bindtap="hideSortFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="asc">
        <text class="option-text">名称 A-Z</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="name" data-order="desc">
        <text class="option-text">名称 Z-A</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="desc">
        <text class="option-text">年龄从小到大</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="birth_date" data-order="asc">
        <text class="option-text">年龄从大到小</text>
      </view>
      <view class="filter-option" bindtap="selectSort" data-by="created_at" data-order="desc">
        <text class="option-text">最新添加</text>
      </view>
    </view>
  </view>
</view>