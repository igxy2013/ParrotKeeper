<!--pages/parrots/detail/detail.wxml-->
<view class="page-container">
  <!-- 通用头部组件：标题与返回（使用详情页自定义返回逻辑） -->
  <app-header 
    title="{{parrot.name || '鹦鹉详情'}}" 
    subtitle="{{(parrot.species_name ? parrot.species_name : '') + (age ? (' · ' + age) : '')}}" 
    showBack="{{true}}"
    customBack="{{true}}"
    bind:back="goBack"
  />
  
  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 主内容容器，留出头部空间 -->
  <view class="content-container" wx:else>
    <!-- 鹦鹉信息卡片 -->
    <view class="parrot-info-card">
      <view class="parrot-main-info">
        <view class="parrot-avatar-wrapper">
          <image 
            class="parrot-avatar" 
            src="{{parrot.photo_thumb || parrot.avatar_thumb || parrot.photo_url || parrot.avatar_url || '/images/parrot-avatar-green.svg'}}" 
            mode="aspectFill"
            bindtap="previewPhoto"
            binderror="onPhotoError"
          />
        </view>
        <view class="parrot-details">
          <view class="parrot-title">
            <text class="parrot-name">{{parrot.name}}</text>
            <view class="gender-badge gender-{{parrot.gender}}">
              <image wx:if="{{parrot.gender === 'male'}}" class="gender-icon-img" src="/images/remix/men-line.png" mode="widthFix" />
              <image wx:elif="{{parrot.gender === 'female'}}" class="gender-icon-img" src="/images/remix/women-line.png" mode="widthFix" />
              <image wx:else class="gender-icon-img" src="/images/remix/question-mark.png" mode="widthFix" />
            </view>
          </view>
          <view class="parrot-species">{{parrot.species_name}}</view>
          <view class="parrot-status-tags">
            <view class="health-badge health-{{parrot.current_health_status || parrot.health_status || 'healthy'}}">
              {{parrot.current_health_status_text || healthStatusText || '健康'}}
            </view>
          </view>
        </view>
        <!-- 菜单按钮 -->
        <view class="menu-btn" bindtap="toggleMenu">
          <image class="menu-icon-img" src="/images/remix/settings-3-line.png" mode="widthFix" />
        </view>
      </view>
      
      <!-- 菜单遮罩层 -->
      <view class="menu-overlay" wx:if="{{showMenu}}" bindtap="closeMenu"></view>
      
      <!-- 弹出菜单 -->
      <view class="popup-menu {{showMenu ? 'show' : ''}}" wx:if="{{showMenu}}">
        <view class="menu-item" bindtap="editParrot">
          <image class="menu-icon-img" src="/images/remix/edit-line.png" mode="widthFix" />
          <text class="menu-item-text">编辑信息</text>
        </view>
        <view class="menu-item" wx:if="{{hasOperationPermission}}" bindtap="openGenerateTransferCode">
          <image class="menu-icon-img" src="/images/remix/arrow-left-right-line.png" mode="widthFix" />
          <text class="menu-item-text">鹦鹉过户</text>
        </view>
        <view class="menu-item delete-item" bindtap="deleteParrot">
          <image class="menu-icon-img" src="/images/remix/delete-bin-line-red.png" mode="widthFix" />
          <text class="menu-item-text">删除鹦鹉</text>
        </view>
      </view>

      <!-- 快速操作按钮 -->
      <view class="quick-actions">
        <view class="action-btn feeding-btn" bindtap="quickFeeding">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.actions.quickFeeding}}" mode="widthFix" binderror="onDetailIconError" data-key="actions.quickFeeding"/>
          </view>
          <text class="action-text">喂食</text>
        </view>
        <view class="action-btn health-btn" bindtap="quickHealthCheck">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.actions.quickHealth}}" mode="widthFix" binderror="onDetailIconError" data-key="actions.quickHealth"/>
          </view>
          <text class="action-text">健康</text>
        </view>
        <view class="action-btn cleaning-btn" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.actions.quickCleaning}}" mode="widthFix" binderror="onDetailIconError" data-key="actions.quickCleaning"/>
          </view>
          <text class="action-text">清洁</text>
        </view>
        <view class="action-btn breeding-btn" bindtap="quickBreeding">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.actions.quickBreeding}}" mode="widthFix" binderror="onDetailIconError" data-key="actions.quickBreeding"/>
          </view>
          <text class="action-text">繁殖</text>
        </view>
      </view>

      <view class="last-feed-info">
        最后喂食: {{lastFeedingInfo}}
      </view>
    </view>

    <!-- 选项卡 -->
    <view class="tabs-container">
      <view class="tabs-bar">
        <view class="tab-item {{activeTab === item ? 'active' : ''}}" wx:for="{{tabs}}" wx:key="*this" bindtap="setActiveTab" data-tab="{{item}}">{{item}}</view>
      </view>
      
      <view class="tab-content">
        <!-- 基本信息 -->
        <view wx:if="{{activeTab === '基本信息'}}" class="tab-panel">
          <view class="info-grid">
            <view class="info-grid-item type-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-book-fill-green.png" />
                <text class="grid-label">品种</text>
              </view>
              <view class="grid-value">{{parrot.species_name || '未设置'}}</view>
            </view>
            <view class="info-grid-item age-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-calendar-fill-blue.png" />
                <text class="grid-label">年龄</text>
              </view>
              <view class="grid-value">{{agePrecise || '未知'}}</view>
            </view>
            <view class="info-grid-item gender-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-user-fill-emerald.png" />
                <text class="grid-label">性别</text>
              </view>
              <view class="grid-value">{{parrot.gender === 'male' ? '雄性' : parrot.gender === 'female' ? '雌性' : '未知'}}</view>
            </view>
            <view class="info-grid-item birthdate-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-calendar-fill-blue.png" />
                <text class="grid-label">出生日期</text>
              </view>
              <view class="grid-value">{{parrot.birth_date || '未设置'}}</view>
            </view>
            <view class="info-grid-item birthplace-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-home-5-fill-green.png" />
                <text class="grid-label">出生地</text>
              </view>
              <view class="grid-value">
                {{(parrot.birth_place_province || parrot.birth_place_city || parrot.birth_place_county) ? ((parrot.birth_place_province || '') + (parrot.birth_place_city || '') + (parrot.birth_place_county || '')) : '未设置'}}
              </view>
            </view>
            <view class="info-grid-item color-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-camera-fill-pink.png" />
                <text class="grid-label">羽色</text>
              </view>
              <view class="grid-value">{{parrot.color || '未设置'}}<text wx:if="{{plumageSplitsText}}">（携带：{{plumageSplitsText}}）</text></view>
            </view>
            <view class="info-grid-item weight-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-scales-fill-green.png" />
                <text class="grid-label">体重</text>
              </view>
              <view class="grid-value">{{parrot.weight_display || '未记录'}}</view>
            </view>
            <view class="info-grid-item number-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-information-fill-amber.png" />
                <text class="grid-label">鹦鹉编号</text>
              </view>
              <view class="grid-value">{{parrot.parrot_number || '未设置'}}</view>
            </view>
            <view class="info-grid-item ring-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-shield-check-fill-blue.png" />
                <text class="grid-label">脚环号</text>
              </view>
              <view class="grid-value">{{parrot.ring_number || '未设置'}}</view>
            </view>
            <view class="info-grid-item admission-info">
              <view class="grid-label-wrap">
                <image class="grid-icon" src="/images/remix/ri-home-5-fill-green.png" />
                <text class="grid-label">入住日期</text>
              </view>
              <view class="grid-value">{{parrot.acquisition_date || '未设置'}}</view>
            </view>
          </view>
          
          <!-- 鹦鹉照片 -->
          <view class="photo-section" wx:if="{{parrot.photo_url}}">
            <view class="card-header">
              <image class="card-icon-img" src="/images/remix/ri-camera-line-gray.png" mode="widthFix" />
              <text class="card-title">鹦鹉照片</text>
              <view class="card-actions">
                <view class="modern-action-btn" bindtap="confirmRemoveBg" hover-class="modern-action-btn--hover" data-key="actions.removeBg">
                  <image 
                    class="modern-action-icon" 
                    src="{{iconPaths.actions.removeBg}}" 
                    mode="widthFix" 
                  />
                  <text class="modern-action-text" binderror="onDetailIconError">AI一键抠图</text>
                </view>
              </view>
            </view>
            <view class="photo-container">
              <image 
                class="parrot-photo" 
                src="{{parrot.photo_url}}" 
                mode="aspectFit"
                bindtap="previewPhoto"
                binderror="onPhotoError"
              />

            </view>
          </view>
          
          <view class="characteristics-card">
            <view class="card-header">
              <image class="card-icon-img" src="/images/remix/edit-line-gray.png" mode="widthFix" />
              <text class="card-title">备注信息</text>
            </view>
            <view class="notes-content">
              <text class="notes-text" wx:if="{{parrot.notes}}">{{parrot.notes}}</text>
              <text class="notes-empty" wx:else>暂无备注信息</text>
            </view>
          </view>
        </view>

        <!-- 喂食记录 -->
        <view wx:elif="{{activeTab === '喂食记录'}}" class="tab-panel">
          <view wx:if="{{hasFeedingRecords}}" class="records-list">
            <view class="record-item feeding-record" wx:for="{{feedingRecords}}" wx:key="id" bindtap="viewRecordDetail" data-type="feeding" data-id="{{item.id}}">
              <view class="record-header">
                <block wx:if="{{item.data && item.data.food_types && item.data.food_types.length === 1}}">
                  <text class="record-food">{{item.data.food_types[0].name || '未知食物'}}</text>
                  <text class="record-amount">{{item.data.food_types[0].amount}}{{item.data.food_types[0].unit}}</text>
                </block>
                <block wx:elif="{{item.data && item.data.food_types && item.data.food_types.length > 1}}">
                  <text class="record-food">多种食物</text>
                </block>
                <block wx:else>
                  <text class="record-food">未知食物</text>
                  <text class="record-amount">未记录</text>
                </block>
              </view>
              <view class="record-footer">
                <!-- 固定显示实际发生时间（统一为 created_at，经 JS 格式化） -->
                <text class="record-time">{{item.created_at}}</text>
                <text class="record-notes">{{item.data && item.data.notes || '无备注'}}</text>
              </view>
            </view>
          </view>
          <view wx:else class="empty-tip">
            <image class="empty-icon-img" src="/images/remix/ri-restaurant-fill-gray.png" mode="widthFix" />
            <text class="empty-text">暂无喂食记录</text>
          </view>
        </view>

        <!-- 健康档案 -->
        <view wx:elif="{{activeTab === '健康档案'}}" class="tab-panel">
          <view wx:if="{{healthRecords && healthRecords.length > 0}}" class="records-list">
            <view class="record-item health-record" wx:for="{{healthRecords}}" wx:key="id" bindtap="viewRecordDetail" data-type="health" data-id="{{item.id}}">
              <view class="record-header">
                <!-- 固定显示实际发生时间（统一为 created_at，经 JS 格式化） -->
                <text class="record-date">{{item.created_at}}</text>
                <view class="health-status-badge status-{{(item.data && item.data.health_status) === 'sick' ? 'poor' : ((item.data && item.data.health_status) === 'observation' ? 'fair' : 'good')}}">
                  {{(item.data && item.data.health_status_text) || '健康'}}
                </view>
              </view>
              <view class="record-details">
                <block wx:if="{{item.data && item.data.food_types && item.data.food_types.length > 1}}">
                  <view class="detail-item" wx:for="{{item.data.food_types}}" wx:key="id">
                    <text class="detail-label">{{item.name}}: </text>
                    <text class="detail-value">{{item.amount}}{{item.unit}}</text>
                  </view>
                </block>
                <view wx:if="{{item.data && item.data.weight}}" class="detail-item">
                  <text class="detail-label">体重: </text>
                  <text class="detail-value">{{item.data.weight}} g</text>
                </view>
              </view>
              <view wx:if="{{item.data && item.data.notes}}" class="record-notes">{{item.data.notes}}</view>
            </view>
          </view>
          <view wx:else class="empty-tip">
            <image class="empty-icon-img" src="/images/remix/ri-heart-fill-gray.png" mode="widthFix" />
            <text class="empty-text">暂无健康记录</text>
          </view>
        </view>

        <!-- 繁殖记录 -->
        <view wx:elif="{{activeTab === '繁殖记录'}}" class="tab-panel">
          <view wx:if="{{breedingRecords && breedingRecords.length > 0}}" class="records-list">
            <view class="record-item training-record" wx:for="{{breedingRecords}}" wx:key="id" bindtap="viewRecordDetail" data-type="breeding" data-id="{{item.id}}">
              <view class="record-header">
                <text class="record-skill">
                  {{(item.male_parrot_name || (item.male_parrot && item.male_parrot.name) || '雄性')}} × {{(item.female_parrot_name || (item.female_parrot && item.female_parrot.name) || '雌性')}}
                </text>
              </view>
              <view class="record-details">
                <view wx:if="{{item.mating_date}}" class="detail-item">
                  <text class="detail-label">交配: </text>
                  <text class="detail-value">{{item.mating_date}}</text>
                </view>
                <view wx:if="{{item.egg_laying_date}}" class="detail-item">
                  <text class="detail-label">产蛋: </text>
                  <text class="detail-value">{{item.egg_laying_date}}</text>
                </view>
                <view wx:if="{{item.hatching_date}}" class="detail-item">
                  <text class="detail-label">孵化: </text>
                  <text class="detail-value">{{item.hatching_date}}</text>
                </view>
                <view wx:if="{{item.egg_count !== undefined}}" class="detail-item">
                  <text class="detail-label">蛋数: </text>
                  <text class="detail-value">{{item.egg_count}}</text>
                </view>
                <view wx:if="{{item.chick_count !== undefined}}" class="detail-item">
                  <text class="detail-label">幼鸟: </text>
                  <text class="detail-value">{{item.chick_count}}</text>
                </view>
              </view>
              <view class="record-footer">
                <text class="record-date">{{item.created_at || ''}}</text>
              </view>
              <view wx:if="{{item.notes}}" class="record-notes">{{item.notes}}</view>
            </view>
          </view>
          <view wx:else class="empty-tip">
            <image class="empty-icon-img" src="/images/remix/book-fill-gray.png" mode="widthFix" />
            <text class="empty-text">暂无繁殖记录</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 过户码弹窗 -->
<view class="modal-overlay" wx:if="{{showTransferCodeModal}}" bindtap="closeTransferCodeModal"></view>
<view class="transfer-code-modal" wx:if="{{showTransferCodeModal}}">
  <view class="modal-header">
    <view class="modal-title">生成过户码</view>
    <view class="modal-subtitle">将此码提供给下一任主人，对方即可认领</view>
  </view>
  <view class="modal-body">
    <view class="code-box">
      <text class="code-text">{{transferCode || (transferCodeGenerating ? '生成中...' : '点击下方生成')}}</text>
    </view>
  </view>
  <view class="modal-actions">
    <button class="modal-btn cancel-btn" bindtap="closeTransferCodeModal">关闭</button>
    <button class="modal-btn cancel-btn" bindtap="copyTransferCode" disabled="{{!transferCode || transferCodeGenerating}}">复制过户码</button>
    <button class="modal-btn submit-btn" bindtap="generateTransferCode" loading="{{transferCodeGenerating}}" disabled="{{transferCodeGenerating}}">生成过户码</button>
  </view>
</view>
<!-- 复用组件：添加/编辑鹦鹉弹窗（编辑用） -->
<parrot-modal 
  visible="{{showParrotModal}}"
  mode="{{parrotFormMode}}"
  title="{{parrotFormTitle}}"
  parrot="{{currentParrotForm}}"
  parrotTypes="{{parrotTypes}}"
  speciesList="{{speciesList}}"
  bind:cancel="onParrotModalCancel"
  bind:submit="onParrotModalSubmit"
/>
