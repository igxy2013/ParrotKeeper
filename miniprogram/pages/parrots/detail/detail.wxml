<!--pages/parrots/detail/detail.wxml-->
<view class="page-container">
  <!-- è‡ªå®šä¹‰å¤´éƒ¨ï¼šæ¸å˜èƒŒæ™¯ + è¿”å›æŒ‰é’® + æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-inner">
      <view class="header-left">
        <view class="back-btn" bindtap="goBack">
          <text class="back-icon">â†</text>
        </view>
        <view class="title-block">
          <text class="title">{{parrot.name || 'é¹¦é¹‰è¯¦æƒ…'}}</text>
          <text class="subtitle">
            <block wx:if="{{parrot.species_name}}">{{parrot.species_name}}</block>
            <block wx:if="{{age}}"> Â· {{age}}</block>
          </text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»å†…å®¹å®¹å™¨ï¼Œç•™å‡ºå¤´éƒ¨ç©ºé—´ -->
  <view class="content-container" wx:else>
    <!-- é¹¦é¹‰ä¿¡æ¯å¡ç‰‡ -->
    <view class="parrot-info-card">
      <view class="parrot-main-info">
        <view class="parrot-avatar-wrapper">
          <image 
            class="parrot-avatar" 
            src="{{parrot.photo_url || parrot.avatar_url || '/images/default-parrot.png'}}" 
            mode="aspectFill"
            bindtap="previewPhoto"
          />
        </view>
        <view class="parrot-details">
          <view class="parrot-name">{{parrot.name}}</view>
          <view class="parrot-species">{{parrot.species_name}}</view>
          <view class="parrot-status-tags">
            <view class="status-tag health-{{parrot.health_status || 'healthy'}}">
              {{healthStatusText || 'å¥åº·'}}
            </view>
            <view class="status-tag mood-tag">
              {{parrot.mood || 'æ´»æ³¼'}}
            </view>
          </view>
        </view>
        <!-- èœå•æŒ‰é’® -->
        <view class="menu-btn" bindtap="toggleMenu">
          <text class="menu-icon">â‹¯</text>
        </view>
      </view>
      
      <!-- èœå•é®ç½©å±‚ -->
      <view class="menu-overlay" wx:if="{{showMenu}}" bindtap="closeMenu"></view>
      
      <!-- å¼¹å‡ºèœå• -->
      <view class="popup-menu {{showMenu ? 'show' : ''}}" wx:if="{{showMenu}}">
        <view class="menu-item" bindtap="editParrot">
          <text class="menu-item-icon">âœï¸</text>
          <text class="menu-item-text">ç¼–è¾‘ä¿¡æ¯</text>
        </view>
        <view class="menu-item delete-item" bindtap="deleteParrot">
          <text class="menu-item-icon">ğŸ—‘ï¸</text>
          <text class="menu-item-text">åˆ é™¤é¹¦é¹‰</text>
        </view>
      </view>

      <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
      <view class="quick-actions">
        <view class="action-btn feeding-btn" bindtap="quickFeeding">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.quickFeedingOrange}}" mode="widthFix" binderror="onDetailIconError" data-key="quickFeedingOrange"/>
          </view>
          <text class="action-text">å–‚é£Ÿ</text>
        </view>
        <view class="action-btn health-btn" bindtap="quickHealthCheck">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.quickHealthEmerald}}" mode="widthFix" binderror="onDetailIconError" data-key="quickHealthEmerald"/>
          </view>
          <text class="action-text">å¥åº·</text>
        </view>
        <view class="action-btn cleaning-btn" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.quickCleaningBlue}}" mode="widthFix" binderror="onDetailIconError" data-key="quickCleaningBlue"/>
          </view>
          <text class="action-text">æ¸…æ´</text>
        </view>
        <view class="action-btn breeding-btn" bindtap="quickBreeding">
          <view class="action-icon-wrapper">
            <image class="action-icon-img" src="{{iconPaths.quickBreedingGreen}}" mode="widthFix" binderror="onDetailIconError" data-key="quickBreedingGreen"/>
          </view>
          <text class="action-text">ç¹æ®–</text>
        </view>
      </view>

      <view class="last-feed-info">
        æœ€åå–‚é£Ÿ: {{lastFeedingInfo}}
      </view>
    </view>

    <!-- é€‰é¡¹å¡ -->
    <view class="tabs-container">
      <view class="tabs-bar">
        <view class="tab-item {{activeTab === item ? 'active' : ''}}" wx:for="{{tabs}}" wx:key="*this" bindtap="setActiveTab" data-tab="{{item}}">{{item}}</view>
      </view>
      
      <view class="tab-content">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view wx:if="{{activeTab === 'åŸºæœ¬ä¿¡æ¯'}}" class="tab-panel">
          <view class="info-grid">
            <view class="info-grid-item type-info">
              <view class="grid-label">å“ç§</view>
              <view class="grid-value">{{parrot.species_name || 'æœªè®¾ç½®'}}</view>
            </view>
            <view class="info-grid-item age-info">
              <view class="grid-label">å¹´é¾„</view>
              <view class="grid-value">{{age || 'æœªçŸ¥'}}</view>
            </view>
            <view class="info-grid-item gender-info">
              <view class="grid-label">æ€§åˆ«</view>
              <view class="grid-value">{{parrot.gender === 'male' ? 'é›„æ€§' : parrot.gender === 'female' ? 'é›Œæ€§' : 'æœªçŸ¥'}}</view>
            </view>
            <view class="info-grid-item color-info">
              <view class="grid-label">ä¸»è¦é¢œè‰²</view>
              <view class="grid-value">{{parrot.color || 'æœªè®¾ç½®'}}</view>
            </view>
            <view class="info-grid-item weight-info">
              <view class="grid-label">ä½“é‡</view>
              <view class="grid-value">{{parrot.weight ? (parrot.weight % 1 === 0 ? parrot.weight : parrot.weight.toFixed(1)) + 'g' : 'æœªè®°å½•'}}</view>
            </view>
            <view class="info-grid-item number-info">
              <view class="grid-label">é¹¦é¹‰ç¼–å·</view>
              <view class="grid-value">{{parrot.parrot_number || 'æœªè®¾ç½®'}}</view>
            </view>
            <view class="info-grid-item ring-info">
              <view class="grid-label">è„šç¯å·</view>
              <view class="grid-value">{{parrot.ring_number || 'æœªè®¾ç½®'}}</view>
            </view>
            <view class="info-grid-item admission-info">
              <view class="grid-label">å…¥ä½æ—¥æœŸ</view>
              <view class="grid-value">{{parrot.acquisition_date || 'æœªè®¾ç½®'}}</view>
            </view>
          </view>
          
          <!-- é¹¦é¹‰ç…§ç‰‡ -->
          <view class="photo-section" wx:if="{{parrot.photo_url}}">
            <view class="card-header">
              <text class="card-icon">ğŸ“·</text>
              <text class="card-title">é¹¦é¹‰ç…§ç‰‡</text>
            </view>
            <view class="photo-container">
              <image 
                class="parrot-photo" 
                src="{{parrot.photo_url}}" 
                mode="aspectFill"
                bindtap="previewParrotPhoto"
              />
            </view>
          </view>
          
          <view class="characteristics-card">
            <view class="card-header">
              <text class="card-icon">ğŸ“</text>
              <text class="card-title">å¤‡æ³¨ä¿¡æ¯</text>
            </view>
            <view class="notes-content">
              <text class="notes-text" wx:if="{{parrot.notes}}">{{parrot.notes}}</text>
              <text class="notes-empty" wx:else>æš‚æ— å¤‡æ³¨ä¿¡æ¯</text>
            </view>
          </view>
        </view>

        <!-- å–‚é£Ÿè®°å½• -->
        <view wx:elif="{{activeTab === 'å–‚é£Ÿè®°å½•'}}" class="tab-panel">
          <view wx:if="{{hasFeedingRecords}}" class="records-list">
            <view class="record-item feeding-record" wx:for="{{feedingRecords}}" wx:key="id">
              <view class="record-header">
                <text class="record-food">{{item.data && (item.data.feed_type_name || (item.data.feed_type && item.data.feed_type.name)) || 'æœªçŸ¥é£Ÿç‰©'}}</text>
                <text class="record-amount" wx:if="{{item.data && item.data.amount !== undefined && item.data.amount !== null}}">{{item.data.amount}} g</text>
                <text class="record-amount" wx:else>æœªè®°å½•</text>
              </view>
              <view class="record-footer">
                <text class="record-time">{{(item.data && item.data.feeding_time) || item.created_at}}</text>
                <text class="record-notes">{{item.data && item.data.notes || 'æ— å¤‡æ³¨'}}</text>
              </view>
            </view>
          </view>
          <view wx:else class="empty-tip">
            <text class="empty-icon">ğŸ½ï¸</text>
            <text class="empty-text">æš‚æ— å–‚é£Ÿè®°å½•</text>
          </view>
        </view>

        <!-- å¥åº·æ¡£æ¡ˆ -->
        <view wx:elif="{{activeTab === 'å¥åº·æ¡£æ¡ˆ'}}" class="tab-panel">
          <view wx:if="{{healthRecords && healthRecords.length > 0}}" class="records-list">
            <view class="record-item health-record" wx:for="{{healthRecords}}" wx:key="id">
              <view class="record-header">
                <text class="record-date">{{(item.data && item.data.record_date) || item.created_at}}</text>
                <view class="health-status-badge status-{{(item.data && item.data.health_status) === 'sick' ? 'poor' : ((item.data && item.data.health_status) === 'observation' ? 'fair' : 'good')}}">
                  {{(item.data && item.data.health_status_text) || 'å¥åº·'}}
                </view>
              </view>
              <view class="record-details">
                <view wx:if="{{item.data && item.data.weight}}" class="detail-item">
                  <text class="detail-label">ä½“é‡: </text>
                  <text class="detail-value">{{item.data.weight}} g</text>
                </view>
              </view>
              <view wx:if="{{item.data && item.data.notes}}" class="record-notes">{{item.data.notes}}</view>
            </view>
          </view>
          <view wx:else class="empty-tip">
            <text class="empty-icon">â¤ï¸</text>
            <text class="empty-text">æš‚æ— å¥åº·è®°å½•</text>
          </view>
        </view>

        <!-- ç¹æ®–è®°å½• -->
        <view wx:elif="{{activeTab === 'ç¹æ®–è®°å½•'}}" class="tab-panel">
          <view wx:if="{{breedingRecords && breedingRecords.length > 0}}" class="records-list">
            <view class="record-item training-record" wx:for="{{breedingRecords}}" wx:key="id">
              <view class="record-header">
                <text class="record-skill">
                  {{(item.male_parrot_name || (item.male_parrot && item.male_parrot.name) || 'é›„æ€§')}} Ã— {{(item.female_parrot_name || (item.female_parrot && item.female_parrot.name) || 'é›Œæ€§')}}
                </text>
              </view>
              <view class="record-details">
                <view wx:if="{{item.mating_date}}" class="detail-item">
                  <text class="detail-label">äº¤é…: </text>
                  <text class="detail-value">{{item.mating_date}}</text>
                </view>
                <view wx:if="{{item.egg_laying_date}}" class="detail-item">
                  <text class="detail-label">äº§è›‹: </text>
                  <text class="detail-value">{{item.egg_laying_date}}</text>
                </view>
                <view wx:if="{{item.hatching_date}}" class="detail-item">
                  <text class="detail-label">å­µåŒ–: </text>
                  <text class="detail-value">{{item.hatching_date}}</text>
                </view>
                <view wx:if="{{item.egg_count !== undefined}}" class="detail-item">
                  <text class="detail-label">è›‹æ•°: </text>
                  <text class="detail-value">{{item.egg_count}}</text>
                </view>
                <view wx:if="{{item.chick_count !== undefined}}" class="detail-item">
                  <text class="detail-label">å¹¼é¸Ÿ: </text>
                  <text class="detail-value">{{item.chick_count}}</text>
                </view>
              </view>
              <view class="record-footer">
                <text class="record-date">{{item.created_at || ''}}</text>
              </view>
              <view wx:if="{{item.notes}}" class="record-notes">{{item.notes}}</view>
            </view>
          </view>
          <view wx:else class="empty-tip">
            <text class="empty-icon">ğŸ£</text>
            <text class="empty-text">æš‚æ— ç¹æ®–è®°å½•</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å¤ç”¨ç»„ä»¶ï¼šæ·»åŠ /ç¼–è¾‘é¹¦é¹‰å¼¹çª—ï¼ˆç¼–è¾‘ç”¨ï¼‰ -->
<parrot-modal 
  visible="{{showParrotModal}}"
  mode="{{parrotFormMode}}"
  title="{{parrotFormTitle}}"
  parrot="{{currentParrotForm}}"
  parrotTypes="{{parrotTypes}}"
  speciesList="{{speciesList}}"
  bind:cancel="onParrotModalCancel"
  bind:submit="onParrotModalSubmit"
/>
