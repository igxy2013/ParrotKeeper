<!--pages/health-check/health-check.wxml-->
<view class="page-container">
  <app-header title="å¥åº·æ£€æŸ¥è®°å½•" subtitle="è®°å½•é¹¦é¹‰å¥åº·çŠ¶å†µ" showBack="true" theme="purple">
    <view slot="actions" class="header-btn" bindtap="addHealthRecord">
      <text class="header-btn-icon">+</text>
    </view>
  </app-header>

  <view class="page-content">
    <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
    <view wx:if="{{!isLogin}}" class="guest-tip">
      <text class="tip-text">ğŸ¥ å¥åº·æ£€æŸ¥éœ€è¦ç™»å½•ä½¿ç”¨</text>
      <text class="tip-subtitle">ç™»å½•åå¯ä»¥è®°å½•å’ŒæŸ¥çœ‹æ‚¨çš„å¥åº·è®°å½•</text>
    </view>

    <!-- å·²ç™»å½•å†…å®¹ -->
    <view wx:if="{{isLogin}}">
      <!-- ç­›é€‰ï¼šé¹¦é¹‰æ ‡ç­¾ -->
      <view class="filter-section">
        <scroll-view scroll-x="true" class="chip-scroll" show-scrollbar="false">
          <view class="chip {{selectedParrotId === '' ? 'active' : ''}}" bindtap="switchParrot" data-id="" data-name="å…¨éƒ¨">
            <text>å…¨éƒ¨</text>
          </view>
          <view class="chip {{selectedParrotId === item.id ? 'active' : ''}}" wx:for="{{parrotsList}}" wx:key="id" bindtap="switchParrot" data-id="{{item.id}}" data-name="{{item.name}}">
            <text>{{item.name}}</text>
          </view>
        </scroll-view>
      </view>

      <!-- å¥åº·æ¦‚è§ˆå¡ç‰‡ -->
      <view class="overview-card rounded-3xl p-6 shadow-xl">
        <text class="overview-title text-lg font-bold">å¥åº·æ¦‚è§ˆ</text>
        <view class="overview-grid">
          <view class="metric">
            <text class="metric-value text-2xl font-bold">{{overview.healthyCount}}</text>
            <text class="metric-label text-sm text-white-80">å¥åº·é¹¦é¹‰</text>
          </view>
          <view class="metric">
            <text class="metric-value text-2xl font-bold">{{overview.attentionCount}}</text>
            <text class="metric-label text-sm text-white-80">éœ€å…³æ³¨</text>
          </view>
          <view class="metric">
            <text class="metric-value text-2xl font-bold">{{overview.checkCount}}</text>
            <text class="metric-label text-sm text-white-80">æ£€æŸ¥æ¬¡æ•°</text>
          </view>
        </view>
      </view>

      <!-- è®°å½•åˆ—è¡¨ -->
      <view class="record-list" wx:if="{{healthRecords.length > 0}}">
        <view class="record-card" wx:for="{{healthRecords}}" wx:key="id">
          <view class="record-header">
            <view class="avatar-cell">
              <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
                <view class="avatar-cluster">
                  <block wx:for="{{item.parrot_avatars}}" wx:for-index="idx" wx:for-item="avatar" wx:key="*this">
                    <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                      <image src="{{avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" />
                    </view>
                  </block>
                </view>
              </block>
              <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
                <view class="single-avatar">
                  <image src="{{item.parrot_avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" />
                </view>
              </block>
              <block wx:else>
                <view class="single-avatar">
                  <image src="/images/default-parrot.png" class="w-full h-full object-cover" mode="aspectFill" />
                </view>
              </block>
            </view>
            <view class="record-info">
              <text class="record-title">{{item.parrot_name}}</text>
              <view class="record-meta">
                <text class="record-time">{{item.record_date_formatted}}</text>
                <text class="record-weight" wx:if="{{item.weight}}">ä½“é‡ï¼š{{item.weight}} g</text>
              </view>
            </view>
            <view class="health-status-badge status-{{item.health_status}}">
              {{item.health_status_text || 'å¥åº·'}}
            </view>
          </view>
          <view class="record-body">
            <view class="record-detail" wx:if="{{item.notes}}">
              <text class="detail-label">å¤‡æ³¨ï¼š</text>
              <text class="detail-value">{{item.notes}}</text>
            </view>
            <view class="record-detail" wx:if="{{item.symptoms}}">
              <text class="detail-label">ç—‡çŠ¶ï¼š</text>
              <text class="detail-value">{{item.symptoms}}</text>
            </view>
            <view class="record-detail" wx:if="{{item.treatment}}">
              <text class="detail-label">æ²»ç–—ï¼š</text>
              <text class="detail-value">{{item.treatment}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{healthRecords.length === 0 && !loading}}">
        <view class="empty-icon">ğŸ¥</view>
        <view class="empty-text">æš‚æ— å¥åº·è®°å½•</view>
        <button wx:if="{{hasOperationPermission}}" class="btn btn-primary btn-large mt-20" bindtap="addHealthRecord">æ·»åŠ å¥åº·è®°å½•</button>
      </view>
    </view>
  </view>
</view>
