<!--pages/index/index.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨å¯¼èˆªç»Ÿä¸€ä¸ºç»„ä»¶ -->
  <app-header title="é¹¦é¹‰ç®¡å®¶" subtitle="ä¸“ä¸šé¹¦é¹‰æŠ¤ç†åŠ©æ‰‹">
    <view slot="actions" class="header-btn" bindtap="openNotifications" style="position: relative;">
      <text class="icon-notification">ğŸ””</text>
      <view wx:if="{{unreadCount > 0}}" style="position:absolute;top:6rpx;right:6rpx;min-width:28rpx;height:28rpx;padding:0 8rpx;border-radius:14rpx;background:#ff4757;color:#fff;font-size:20rpx;line-height:28rpx;text-align:center;">{{unreadCount}}</view>
    </view>
  </app-header>

  <notification-center 
    visible="{{showNotifications}}" 
    notifications="{{notifications}}"
    bind:close="closeNotifications"
    bind:markAllRead="markAllNotificationsRead"
    bind:clearAll="clearAllNotifications"
    bind:itemTap="handleNotificationTap"
  />

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    <!-- æ¬¢è¿å¡ç‰‡ -->
    <view class="welcome-card">
      <view class="welcome-bg-circle circle-1"></view>
      <view class="welcome-bg-circle circle-2"></view>
      <view class="welcome-content">
        <text class="welcome-greeting">{{greeting}}ï¼Œ{{userInfo.nickname || userInfo.username || 'é¹¦é¹‰çˆ±å¥½è€…'}}ï¼</text>
        <text class="welcome-message">ä»Šå¤©ä¹Ÿè¦å¥½å¥½ç…§é¡¾å°å®¶ä¼™ä»¬å“¦ ğŸ¦œ</text>
        <view class="status-indicator">
          <view class="status-dot"></view>
          <text class="status-text">{{overview.total_parrots || 0}}åªé¹¦é¹‰çŠ¶æ€è‰¯å¥½</text>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡æ•°æ®ç½‘æ ¼ -->
    <view class="stats-grid">
      <view class="stat-card" bindtap="navigateToParrots">
        <view class="stat-icon-container emerald">
          <text class="stat-icon">â™¥</text>
        </view>
        <view class="stat-value emerald-text">{{overview.total_parrots || 0}}</view>
        <view class="stat-label">æˆ‘çš„é¹¦é¹‰</view>
      </view>
      <view class="stat-card" bindtap="navigateToFeedingRecords">
        <view class="stat-icon-container orange">
          <text class="stat-icon">ğŸ</text>
        </view>
        <view class="stat-value orange-text">{{overview.today_records.feeding || 0}}</view>
        <view class="stat-label">ä»Šæ—¥å–‚é£Ÿ</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon-container green">
          <text class="stat-icon">ğŸ’°</text>
        </view>
        <view class="stat-value green-text">Â¥{{overview.monthly_income || 0}}</view>
        <view class="stat-label">æœ¬æœˆæ”¶å…¥</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon-container blue">
          <text class="stat-icon">ğŸ’°</text>
        </view>
        <view class="stat-value blue-text">Â¥{{overview.monthly_expense || 1265}}</view>
        <view class="stat-label">æœ¬æœˆæ”¯å‡º</view>
      </view>
    </view>

    <!-- æˆ‘çš„é¹¦é¹‰å¡ç‰‡ -->
    <view class="my-parrots-card" wx:if="{{myParrots.length > 0}}">
      <view class="card-header">
        <text class="card-title">â™¥ æˆ‘çš„é¹¦é¹‰</text>
        <text class="more-link" bindtap="navigateToParrots">æŸ¥çœ‹å…¨éƒ¨ â†’</text>
      </view>
      <view class="parrot-card-list">
        <view class="parrot-mini-card" wx:for="{{myParrots}}" wx:key="id" data-id="{{item.id}}" bindtap="openParrotDetail">
          <image class="parrot-mini-avatar" src="{{item.photo_url || '/images/default-parrot.svg'}}" mode="aspectFit" data-id="{{item.id}}" binderror="handleIndexParrotImageError"/>
          <text class="parrot-mini-name">{{item.name}}</text>
          <text class="parrot-mini-species">{{item.species_name || (item.species && item.species.name) || ''}}</text>
          <view class="parrot-mini-badge {{item.health_status}}">{{item.health_text || 'å¥åº·'}}</view>
        </view>
      </view>
    </view>

    <!-- å¿«é€Ÿæ“ä½œåŒºåŸŸ -->
    <view class="quick-actions-card">
      <view class="card-header">
        <text class="card-title">âš¡ å¿«é€Ÿæ“ä½œ</text>
      </view>
      <view class="actions-grid">
        <view class="action-item feeding {{!isLogin ? 'disabled' : ''}}" bindtap="navigateToFeedingRecords">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ</text>
          </view>
          <text class="action-label">å–‚é£Ÿè®°å½•</text>
        </view>
        <view class="action-item health {{!isLogin ? 'disabled' : ''}}" bindtap="quickHealth">
          <view class="action-icon-wrapper">
            <text class="action-icon">â™¥</text>
          </view>
          <text class="action-label">å¥åº·æ£€æŸ¥</text>
        </view>
        <view class="action-item training {{!isLogin ? 'disabled' : ''}}" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ§½</text>
          </view>
          <text class="action-label">æ¸…æ´è®°å½•</text>
        </view>
        <view class="action-item add-expense {{!isLogin ? 'disabled' : ''}}" bindtap="quickBreeding">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ¥š</text>
          </view>
    <text class="action-label">ç¹æ®–è®°å½•</text>
        </view>
        <view class="action-item add {{!isLogin ? 'disabled' : ''}}" bindtap="addParrot">
          <view class="action-icon-wrapper">
            <text class="action-icon">â•</text>
          </view>
          <text class="action-label">æ·»åŠ é¹¦é¹‰</text>
        </view>
        <view class="action-item expenses {{!isLogin ? 'disabled' : ''}}" bindtap="quickExpense">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ’°</text>
          </view>
          <text class="action-label">æ·»åŠ æ”¶æ”¯</text>
        </view>
        <view class="action-item statistics {{!isLogin ? 'disabled' : ''}}" bindtap="goToExpenseManagement">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ’°</text>
          </view>
          <text class="action-label">æ”¶æ”¯ç®¡ç†</text>
        </view>
        <view class="action-item guide {{!isLogin ? 'disabled' : ''}}" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“–</text>
          </view>
          <text class="action-label">æŠ¤ç†æŒ‡å—</text>
        </view>
      </view>
    </view>

    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <view class="recent-activity-card" wx:if="{{recentRecords.length > 0}}">
      <view class="card-header">
        <text class="card-title">ğŸ•’ æœ€è¿‘æ´»åŠ¨</text>
      </view>
      <view class="activity-list">
        <view class="activity-item orange-theme" wx:if="{{recentRecords.length > 0}}">
          <view class="activity-icon-container">
            <text class="activity-icon">ğŸ</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">ç»™å°å½©å–‚é£Ÿäº†å°ç±³</text>
            <text class="activity-subtitle">2å°æ—¶å‰ â€¢ è¥å…»å‡è¡¡</text>
          </view>
          <view class="activity-dot orange"></view>
        </view>
        <view class="activity-item green-theme" wx:if="{{recentRecords.length > 1}}">
          <view class="activity-icon-container">
            <text class="activity-icon">â™¥</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">é˜¿ç¦å®Œæˆå¥åº·æ£€æŸ¥</text>
            <text class="activity-subtitle">æ˜¨å¤© â€¢ çŠ¶æ€è‰¯å¥½</text>
          </view>
          <view class="activity-dot green"></view>
        </view>
        <view class="activity-item purple-theme" wx:if="{{recentRecords.length > 2}}">
          <view class="activity-icon-container">
            <text class="activity-icon">ğŸ“…</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">å°ç»¿å®Œæˆè®­ç»ƒè®¡åˆ’</text>
            <text class="activity-subtitle">3å¤©å‰ â€¢ å­¦ä¼šæ–°æŠ€èƒ½</text>
          </view>
          <view class="activity-dot purple"></view>
        </view>
      </view>
    </view>

  <!-- å¥åº·æé†’ -->
  <view class="health-alerts" wx:if="{{healthAlerts.length > 0}}">
    <view class="card">
      <view class="card-header">
        <text class="card-title">å¥åº·æé†’</text>
      </view>
      <view class="card-content">
        <view class="alert-list">
          <view class="alert-item" wx:for="{{healthAlerts}}" wx:key="id">
            <view class="alert-icon">âš ï¸</view>
            <view class="alert-content">
              <view class="alert-title">{{item.title}}</view>
              <view class="alert-subtitle">{{item.description}}</view>
            </view>
          </view>
      </view>
    </view>
  </view>
</view>

<!-- æ·»åŠ é¹¦é¹‰å¼¹çª—ï¼ˆä¸¥æ ¼å‚è€ƒå‚è€ƒAPPè®¾è®¡é£æ ¼ï¼‰ -->
<view wx:if="{{showAddParrotModal}}" class="modal-overlay" catchtouchmove="true" bindtap="closeAddParrotModal">
  <view class="modal-content" catchtap="stopPropagation">
    <!-- å¤´éƒ¨æ¸å˜åŒºåŸŸ -->
    <view class="modal-header-gradient">
      <view class="modal-header-row">
        <text class="modal-title">æ·»åŠ æ–°é¹¦é¹‰</text>
        <view class="modal-close-btn" bindtap="closeAddParrotModal">
          <text class="modal-close-icon">âœ•</text>
        </view>
      </view>
    </view>

    <!-- å¼¹çª—å†…å®¹ -->
    <scroll-view scroll-y="true" class="modal-scroll">
      <view class="form-section">
        <!-- åå­— -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">â¤</text>é¹¦é¹‰åå­— *</text>
          <input class="text-input" placeholder="ç»™æ‚¨çš„é¹¦é¹‰èµ·ä¸ªå¯çˆ±çš„åå­—" value="{{newParrot.name}}" bindinput="onParrotNameInput" />
        </view>

        <!-- å“ç§ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸƒ</text>é¹¦é¹‰å“ç§ *</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{parrotTypes}}" value="{{typeIndex}}" bindchange="onTypePickerChange">
              <view class="picker-display">
                <text>{{newParrot.type ? newParrot.type : 'è¯·é€‰æ‹©å“ç§'}}</text>
                <text class="picker-arrow">â–¾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- å¹´é¾„ ä¸ ä½“é‡ -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">â±</text>å¹´é¾„</text>
            <input class="text-input" placeholder="å¦‚: 2å²" value="{{newParrot.age}}" bindinput="onParrotAgeInput" />
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">âš–</text>ä½“é‡</text>
            <input class="text-input" placeholder="å¦‚: 35g" value="{{newParrot.weight}}" bindinput="onParrotWeightInput" />
          </view>
        </view>

        <!-- æ€§åˆ« ä¸ é¢œè‰² -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">ğŸ‘¤</text>æ€§åˆ«</text>
            <view class="gender-row">
              <view class="gender-btn {{newParrot.gender === 'é›„æ€§' ? 'gender-male active' : 'gender-male'}}" bindtap="setParrotGender" data-gender="é›„æ€§">é›„æ€§</view>
              <view class="gender-btn {{newParrot.gender === 'é›Œæ€§' ? 'gender-female active' : 'gender-female'}}" bindtap="setParrotGender" data-gender="é›Œæ€§">é›Œæ€§</view>
            </view>
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">ğŸ¨</text>ä¸»è¦é¢œè‰²</text>
            <input class="text-input" placeholder="å¦‚: ç»¿è‰²" value="{{newParrot.color}}" bindinput="onParrotColorInput" />
          </view>
        </view>

        <!-- å‡ºç”Ÿæ—¥æœŸ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸ“…</text>å‡ºç”Ÿæ—¥æœŸ</text>
          <picker mode="date" value="{{newParrot.birthDate}}" bindchange="onBirthDateChange">
            <view class="picker-display">
              <text>{{newParrot.birthDate ? newParrot.birthDate : 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
              <text class="picker-arrow">â–¾</text>
            </view>
          </picker>
        </view>

        <!-- å¤‡æ³¨ä¿¡æ¯ -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">ğŸ“</text>å¤‡æ³¨ä¿¡æ¯</text>
          <textarea class="textarea-input" placeholder="è®°å½•ä¸€äº›ç‰¹æ®Šä¿¡æ¯ï¼Œå¦‚æ€§æ ¼ç‰¹ç‚¹ã€å–œå¥½ç­‰..." value="{{newParrot.notes}}" bindinput="onParrotNotesInput" />
        </view>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="closeAddParrotModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="submitNewParrot" disabled="{{!newParrot.name || !newParrot.type}}">æ·»åŠ é¹¦é¹‰</button>
    </view>
  </view>
</view>

<!-- æ·»åŠ æ”¶æ”¯è®°å½•å¼¹çª—ï¼ˆä¸¥æ ¼å‚è€ƒå‚è€ƒAPPè®¾è®¡ï¼‰ -->
<view wx:if="{{showAddExpenseModal}}" class="modal-overlay" catchtouchmove="true" bindtap="closeAddExpenseModal">
  <view class="expense-modal-card" catchtap="stopPropagation">
    <!-- å¼¹çª—å¤´éƒ¨ï¼šæ ‡é¢˜ä¸å…³é—­æŒ‰é’® -->
    <view class="expense-modal-header">
      <text class="expense-modal-title">æ·»åŠ æ”¶æ”¯è®°å½•</text>
      <view class="expense-modal-close" bindtap="closeAddExpenseModal">âœ•</view>
    </view>

    <!-- å¼¹çª—ä¸»ä½“å†…å®¹ -->
    <scroll-view scroll-y="true" class="expense-modal-scroll">
      <view class="expense-form-section">
        <!-- ç±»å‹åˆ‡æ¢ï¼šæ”¶å…¥ / æ”¯å‡º -->
        <view class="form-item">
          <text class="form-label">è®°å½•ç±»å‹</text>
          <view class="type-switch-row">
            <view class="type-btn {{expenseForm.type==='æ”¶å…¥' ? 'type-income active' : 'type-income'}}" bindtap="setExpenseType" data-type="æ”¶å…¥">æ”¶å…¥</view>
            <view class="type-btn {{expenseForm.type==='æ”¯å‡º' ? 'type-expense active' : 'type-expense'}}" bindtap="setExpenseType" data-type="æ”¯å‡º">æ”¯å‡º</view>
          </view>
        </view>

        <!-- é€‰æ‹©é¹¦é¹‰ -->
        <view class="form-item">
          <text class="form-label">é€‰æ‹©é¹¦é¹‰</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{parrotOptions}}" value="{{expenseForm.parrotIndex}}" bindchange="onExpenseParrotChange">
              <view class="picker-display">
                <text>{{parrotOptions[expenseForm.parrotIndex] || 'è¯·é€‰æ‹©é¹¦é¹‰'}}</text>
                <text class="picker-arrow">â–¾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- é€‰æ‹©ç±»åˆ« -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}ç±»åˆ«</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{categoryOptions}}" value="{{expenseForm.categoryIndex}}" bindchange="onExpenseCategoryChange">
              <view class="picker-display">
                <text>{{categoryOptions[expenseForm.categoryIndex] || 'è¯·é€‰æ‹©ç±»åˆ«'}}</text>
                <text class="picker-arrow">â–¾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- é‡‘é¢ -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}é‡‘é¢</text>
          <input class="text-input" type="number" placeholder="è¯·è¾“å…¥é‡‘é¢" value="{{expenseForm.amount}}" bindinput="onExpenseAmountInput" />
        </view>

        <!-- æè¿° -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}æè¿°</text>
          <input class="text-input" placeholder="è¯·è¾“å…¥æè¿°" value="{{expenseForm.description}}" bindinput="onExpenseDescInput" />
        </view>

        <!-- æ—¥æœŸ -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}æ—¥æœŸ</text>
          <picker mode="date" value="{{expenseForm.date}}" bindchange="onExpenseDateChange">
            <view class="picker-display">
              <text>{{expenseForm.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
              <text class="picker-arrow">â–¾</text>
            </view>
          </picker>
        </view>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="expense-modal-footer">
      <button class="btn-secondary" bindtap="closeAddExpenseModal">å–æ¶ˆ</button>
      <button class="btn-add {{expenseForm.type==='æ”¶å…¥' ? 'btn-add-income' : 'btn-add-expense'}}" bindtap="submitExpenseRecord" disabled="{{!canSubmitExpense}}">æ·»åŠ </button>
    </view>
  </view>
</view>

    <!-- ç™»å½•æç¤º -->
    <view class="login-prompt-card" wx:if="{{!isLogin}}">
      <view class="login-content">
        <view class="login-icon">ğŸ¦œ</view>
        <text class="login-title">æ¬¢è¿ä½¿ç”¨é¹¦é¹‰ç®¡å®¶</text>
        <text class="login-subtitle">è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½</text>
        <button class="login-btn" bindtap="handleLogin">å¾®ä¿¡å¿«é€Ÿç™»å½•</button>
      </view>
    </view>
  </view>
</view>
