<!--pages/index/index.wxml-->
<view class="page-container">
  <!-- 顶部导航统一为组件 -->
  <app-header title="鹦鹉管家" subtitle="专业鹦鹉护理助手">
    <view slot="actions" class="header-btn" bindtap="openNotifications" style="position: relative;">
      <text class="icon-notification">🔔</text>
      <view wx:if="{{unreadCount > 0}}" style="position:absolute;top:6rpx;right:6rpx;min-width:28rpx;height:28rpx;padding:0 8rpx;border-radius:14rpx;background:#ff4757;color:#fff;font-size:20rpx;line-height:28rpx;text-align:center;">{{unreadCount}}</view>
    </view>
  </app-header>

  <notification-center 
    visible="{{showNotifications}}" 
    notifications="{{notifications}}"
    bind:close="closeNotifications"
    bind:markAllRead="markAllNotificationsRead"
    bind:clearAll="clearAllNotifications"
    bind:itemTap="handleNotificationTap"
  />

  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 欢迎卡片 -->
    <view class="welcome-card">
      <view class="welcome-bg-circle circle-1"></view>
      <view class="welcome-bg-circle circle-2"></view>
      <view class="welcome-content">
        <text class="welcome-greeting">{{greeting}}，{{userInfo.nickname || userInfo.username || '鹦鹉爱好者'}}！</text>
        <text class="welcome-message">今天也要好好照顾小家伙们哦 🦜</text>
        <view class="status-indicator">
          <view class="status-dot"></view>
          <text class="status-text">{{overview.total_parrots || 0}}只鹦鹉状态良好</text>
        </view>
      </view>
    </view>

    <!-- 统计数据网格 -->
    <view class="stats-grid">
      <view class="stat-card" bindtap="navigateToParrots">
        <view class="stat-icon-container emerald">
          <text class="stat-icon">♥</text>
        </view>
        <view class="stat-value emerald-text">{{overview.total_parrots || 0}}</view>
        <view class="stat-label">我的鹦鹉</view>
      </view>
      <view class="stat-card" bindtap="navigateToRecords">
        <view class="stat-icon-container orange">
          <text class="stat-icon">🍎</text>
        </view>
        <view class="stat-value orange-text">{{overview.today_records.feeding || 0}}</view>
        <view class="stat-label">今日喂食</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon-container green">
          <text class="stat-icon">🛡</text>
        </view>
        <view class="stat-value green-text">优秀</view>
        <view class="stat-label">健康状态</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon-container blue">
          <text class="stat-icon">💰</text>
        </view>
        <view class="stat-value blue-text">¥{{overview.monthly_expense || 1265}}</view>
        <view class="stat-label">本月支出</view>
      </view>
    </view>

    <!-- 我的鹦鹉卡片 -->
    <view class="my-parrots-card" wx:if="{{myParrots.length > 0}}">
      <view class="card-header">
        <text class="card-title">♥ 我的鹦鹉</text>
        <text class="more-link" bindtap="navigateToParrots">查看全部 →</text>
      </view>
      <view class="parrot-card-list">
        <view class="parrot-mini-card" wx:for="{{myParrots}}" wx:key="id" data-id="{{item.id}}" bindtap="openParrotDetail">
          <image class="parrot-mini-avatar" src="{{item.photo_url || '/images/default-parrot.svg'}}" mode="aspectFit" data-id="{{item.id}}" binderror="handleIndexParrotImageError"/>
          <text class="parrot-mini-name">{{item.name}}</text>
          <text class="parrot-mini-species">{{item.species_name || (item.species && item.species.name) || ''}}</text>
          <view class="parrot-mini-badge {{item.health_status}}">{{item.health_text || '健康'}}</view>
        </view>
      </view>
    </view>

    <!-- 快速操作区域 -->
    <view class="quick-actions-card">
      <view class="card-header">
        <text class="card-title">⚡ 快速操作</text>
      </view>
      <view class="actions-grid">
        <view class="action-item feeding {{!isLogin ? 'disabled' : ''}}" bindtap="quickFeeding">
          <view class="action-icon-wrapper">
            <text class="action-icon">🍎</text>
          </view>
          <text class="action-label">喂食记录</text>
        </view>
        <view class="action-item health {{!isLogin ? 'disabled' : ''}}" bindtap="quickHealth">
          <view class="action-icon-wrapper">
            <text class="action-icon">♥</text>
          </view>
          <text class="action-label">健康检查</text>
        </view>
        <view class="action-item training {{!isLogin ? 'disabled' : ''}}" bindtap="quickBreeding">
          <view class="action-icon-wrapper">
            <text class="action-icon">📅</text>
          </view>
          <text class="action-label">训练计划</text>
        </view>
        <view class="action-item add-expense {{!isLogin ? 'disabled' : ''}}" bindtap="quickExpense">
          <view class="action-icon-wrapper">
            <text class="action-icon">💰</text>
          </view>
          <text class="action-label">添加支出</text>
        </view>
        <view class="action-item add {{!isLogin ? 'disabled' : ''}}" bindtap="addParrot">
          <view class="action-icon-wrapper">
            <text class="action-icon">➕</text>
          </view>
          <text class="action-label">添加鹦鹉</text>
        </view>
        <view class="action-item expenses {{!isLogin ? 'disabled' : ''}}" bindtap="goToExpenseManagement">
          <view class="action-icon-wrapper">
            <text class="action-icon">🛒</text>
          </view>
          <text class="action-label">用品购买</text>
        </view>
        <view class="action-item statistics {{!isLogin ? 'disabled' : ''}}" bindtap="navigateToRecords">
          <view class="action-icon-wrapper">
            <text class="action-icon">📊</text>
          </view>
          <text class="action-label">数据统计</text>
        </view>
        <view class="action-item guide {{!isLogin ? 'disabled' : ''}}" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
            <text class="action-icon">📖</text>
          </view>
          <text class="action-label">护理指南</text>
        </view>
      </view>
    </view>

    <!-- 最近活动 -->
    <view class="recent-activity-card" wx:if="{{recentRecords.length > 0}}">
      <view class="card-header">
        <text class="card-title">🕒 最近活动</text>
        <text class="more-link" bindtap="viewAllRecords">查看全部 →</text>
      </view>
      <view class="activity-list">
        <view class="activity-item orange-theme" wx:if="{{recentRecords.length > 0}}">
          <view class="activity-icon-container">
            <text class="activity-icon">🍎</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">给小彩喂食了小米</text>
            <text class="activity-subtitle">2小时前 • 营养均衡</text>
          </view>
          <view class="activity-dot orange"></view>
        </view>
        <view class="activity-item green-theme" wx:if="{{recentRecords.length > 1}}">
          <view class="activity-icon-container">
            <text class="activity-icon">♥</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">阿福完成健康检查</text>
            <text class="activity-subtitle">昨天 • 状态良好</text>
          </view>
          <view class="activity-dot green"></view>
        </view>
        <view class="activity-item purple-theme" wx:if="{{recentRecords.length > 2}}">
          <view class="activity-icon-container">
            <text class="activity-icon">📅</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">小绿完成训练计划</text>
            <text class="activity-subtitle">3天前 • 学会新技能</text>
          </view>
          <view class="activity-dot purple"></view>
        </view>
      </view>
    </view>

  <!-- 健康提醒 -->
  <view class="health-alerts" wx:if="{{healthAlerts.length > 0}}">
    <view class="card">
      <view class="card-header">
        <text class="card-title">健康提醒</text>
      </view>
      <view class="card-content">
        <view class="alert-list">
          <view class="alert-item" wx:for="{{healthAlerts}}" wx:key="id">
            <view class="alert-icon">⚠️</view>
            <view class="alert-content">
              <view class="alert-title">{{item.title}}</view>
              <view class="alert-subtitle">{{item.description}}</view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

    <!-- 登录提示 -->
    <view class="login-prompt-card" wx:if="{{!isLogin}}">
      <view class="login-content">
        <view class="login-icon">🦜</view>
        <text class="login-title">欢迎使用鹦鹉管家</text>
        <text class="login-subtitle">请先登录以使用完整功能</text>
        <button class="login-btn" bindtap="handleLogin">微信快速登录</button>
      </view>
    </view>
  </view>
</view>