<!--pages/index/index.wxml-->
<view class="page-container">
  <!-- 顶部导航统一为组件 -->
  <app-header title="鹦鹉管家" subtitle="专业鹦鹉护理助手">
    <view slot="actions" class="header-action-btn" bindtap="openNotifications">
  <image class="header-action-icon" src="{{iconPaths.headerNotification}}" mode="aspectFit" binderror="handleIconError" data-key="headerNotification" />
      <view class="header-action-badge" wx:if="{{unreadCount > 0}}"></view>
    </view>
  </app-header>

  <!-- 公告弹窗（首页展示） -->
  <block wx:if="{{showAnnouncementModal && latestAnnouncement}}">
    <view class="announcement-modal-overlay" bindtap="closeAnnouncementModal"></view>
    <view class="announcement-modal" catchtap="stopPropagation">
      <view class="announcement-modal-header">
        <view class="announcement-modal-title">系统公告</view>
        <view class="announcement-modal-close" bindtap="closeAnnouncementModal">
          <text class="announcement-modal-close-text">×</text>
        </view>
      </view>
      <view class="announcement-modal-body">
        <view class="announcement-modal-h1">{{latestAnnouncement.title}}</view>
        <view class="announcement-modal-content">{{latestAnnouncement.content}}</view>
      </view>
    </view>
  </block>

  <notification-center 
    visible="{{showNotifications}}" 
    notifications="{{notifications}}"
    bind:close="closeNotifications"
    bind:markAllRead="markAllNotificationsRead"
    bind:clearAll="clearAllNotifications"
    bind:itemTap="handleNotificationTap"
  />

  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 欢迎卡片 -->
    <view class="welcome-card">
      <view class="welcome-bg-circle circle-1"></view>
      <view class="welcome-bg-circle circle-2"></view>
      <view class="welcome-content">
        <text class="welcome-greeting">{{greeting}}，{{userInfo.nickname || userInfo.username || '鹦鹉爱好者'}}！</text>
        <block wx:if="{{isSingleParrot}}">
          <text class="welcome-message">今天是你和{{singleParrotName}}相处的第<text class="welcome-day-count">{{singleParrotDays}}</text>天！</text>
        </block>
        <block wx:else>
          <text class="welcome-message">{{welcomeMessage}}</text>
        </block>
        <view class="status-indicator">
          <view class="status-dot {{overview.health_status && (overview.health_status.sick > 0 || overview.health_status.recovering > 0 || overview.health_status.observation > 0) ? 'status-dot-warning' : 'status-dot-healthy'}}"></view>
          <view class="status-text">{{overview_status_text}}</view>
        </view>
</view>
    </view>

    <!-- 统计数据网格（支持长按自定义显示项） -->
    <view class="stats-grid {{isEditMode ? 'edit-mode' : ''}}" bindlongpress="openWidgetPicker">
      <!-- 编辑模式背景遮罩 -->
      <view wx:if="{{isEditMode}}" class="edit-mode-mask"></view>
      <!-- 拖拽浮层（实时跟随手指） -->
      <view wx:if="{{isEditMode && dragGhost}}" class="drag-ghost" style="left: {{dragGhost.x}}px; top: {{dragGhost.y}}px; width: {{dragGhost.w}}px; height: {{dragGhost.h}}px;">
        <block wx:if="{{dragGhost.id === 'parrots'}}">
          <home-card-parrots count="{{overview.total_parrots || 0}}" />
        </block>
        <block wx:elif="{{dragGhost.id === 'feeding_today'}}">
          <home-card-feeding-today count="{{(overview.today_records && overview.today_records.feeding) || 0}}" />
        </block>
        <block wx:elif="{{dragGhost.id === 'monthly_income'}}">
          <home-card-monthly-income amount="{{overview.monthly_income || 0}}" />
        </block>
        <block wx:elif="{{dragGhost.id === 'monthly_expense'}}">
          <home-card-monthly-expense amount="{{overview.monthly_expense || 0}}" />
        </block>
        <block wx:elif="{{dragGhost.id === 'weight_trend'}}">
          <home-card-weight-trend series="{{homeWeightSeries}}" />
        </block>
      </view>
      <!-- 编辑模式顶部工具栏 -->
      <view wx:if="{{isEditMode}}" class="edit-toolbar">
        <text class="edit-title">自定义卡片</text>
      </view>
      
      <!-- 现有卡片 -->
      <block wx:if="{{isEditMode}}">
        <view class="widget-container wiggle" catchtouchmove="blockTouchMove">
          <view wx:for="{{homeWidgets}}" wx:key="*this" wx:if="{{!hiddenWidgetsMap[item]}}"
                class="{{item === 'weight_trend' ? 'widget-wrapper full-row' : 'widget-wrapper'}}" data-id="{{item}}" style="{{draggingWidgetId === item ? 'opacity:0.35' : ''}}"
                bindtouchstart="onDragStart" bindtouchmove="onDragMove" bindtouchend="onDragEnd">
            <block wx:if="{{item === 'parrots'}}">
              <home-card-parrots count="{{overview.total_parrots || 0}}" bind:tap="navigateToParrots" />
            </block>
            <block wx:elif="{{item === 'feeding_today'}}">
              <home-card-feeding-today count="{{(overview.today_records && overview.today_records.feeding) || 0}}" bind:tap="navigateToFeedingRecords" />
            </block>
            <block wx:elif="{{item === 'monthly_income'}}">
              <home-card-monthly-income amount="{{overview.monthly_income || 0}}" bind:tap="goToExpenseManagement" />
            </block>
            <block wx:elif="{{item === 'monthly_expense'}}">
              <home-card-monthly-expense amount="{{overview.monthly_expense || 0}}" bind:tap="goToExpenseManagement" />
            </block>
            <block wx:elif="{{item === 'weight_trend'}}">
              <home-card-weight-trend series="{{homeWeightSeries}}" bind:tap="navigateToStatistics" />
            </block>
            
            <view wx:if="{{isEditMode}}" class="remove-btn" bindtap="removeWidget" data-widget="{{item}}">
              <image src="/images/icons/close-white.png" class="remove-icon" />
            </view>
          </view>
        </view>
      </block>
      <block wx:else>
        <view class="widget-container">
          <view wx:for="{{homeWidgets}}" wx:key="*this" wx:if="{{!hiddenWidgetsMap[item]}}"
                class="{{item === 'weight_trend' ? 'widget-wrapper full-row' : 'widget-wrapper'}}" data-id="{{item}}"
                bindtouchstart="onDragStart" bindtouchmove="onDragMove" bindtouchend="onDragEnd">
            <block wx:if="{{item === 'parrots'}}">
              <home-card-parrots count="{{overview.total_parrots || 0}}" bind:tap="navigateToParrots" />
            </block>
            <block wx:elif="{{item === 'feeding_today'}}">
              <home-card-feeding-today count="{{(overview.today_records && overview.today_records.feeding) || 0}}" bind:tap="navigateToFeedingRecords" />
            </block>
            <block wx:elif="{{item === 'monthly_income'}}">
              <home-card-monthly-income amount="{{overview.monthly_income || 0}}" bind:tap="goToExpenseManagement" />
            </block>
            <block wx:elif="{{item === 'monthly_expense'}}">
              <home-card-monthly-expense amount="{{overview.monthly_expense || 0}}" bind:tap="goToExpenseManagement" />
            </block>
            <block wx:elif="{{item === 'weight_trend'}}">
              <home-card-weight-trend series="{{homeWeightSeries}}" bind:tap="navigateToStatistics" />
            </block>
            
            <view wx:if="{{isEditMode}}" class="remove-btn" bindtap="removeWidget" data-widget="{{item}}">
              <image src="/images/icons/close-white.png" class="remove-icon" />
            </view>
          </view>
        </view>
      </block>
      
      <!-- 空状态：当四张卡片都隐藏时展示提示与恢复按钮 -->
      <view wx:if="{{!isEditMode && hiddenWidgets.length >= homeWidgets.length}}" class="empty-widgets-placeholder">
        <text class="empty-title">统计卡片已隐藏</text>
        <text class="empty-subtitle">长按此区域自定义显示，或恢复默认布局</text>
        <button class="empty-reset-btn" bindtap="resetHiddenWidgets">恢复默认</button>
      </view>

      <!-- 添加卡片按钮区域 -->
      <view wx:if="{{isEditMode}}" class="add-widgets-section">
        <view class="add-widgets-title">可添加的卡片</view>
        <view class="add-widgets-grid">
          <view wx:for="{{availableWidgetsToAdd}}" wx:key="id" 
                class="add-widget-item" bindtap="addWidget" data-widget="{{item.id}}">
            <view class="add-widget-icon">
              <image src="{{item.icon}}" class="widget-icon" />
              <view class="add-plus">+</view>
            </view>
            <text class="add-widget-name">{{item.name}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 我的鹦鹉卡片 -->
    <view class="my-parrots-card" wx:if="{{myParrots.length > 0}}">
      <view class="card-header">
      <text class="card-title"><image class="inline-title-icon" src="{{iconPaths.myParrotsTitleHeart}}" mode="widthFix" binderror="handleIconError" data-key="myParrotsTitleHeart"/> 我的鹦鹉</text>
        <text class="more-link" bindtap="navigateToParrots">查看全部</text>
      </view>
      <scroll-view class="parrot-card-scroll" scroll-x="true" enable-flex="true" scroll-with-animation="true">
        <view class="parrot-card-row">
          <view class="parrot-mini-card" wx:for="{{myParrots}}" wx:key="id" data-id="{{item.id}}" bindtap="openParrotDetail">
            <image class="parrot-mini-avatar" src="{{item.photo_thumb || item.avatar_thumb || item.photo_url || item.avatar_url || iconPaths.defaultParrot}}" mode="aspectFill" data-id="{{item.id}}" binderror="handleIndexParrotImageError" lazy-load="true"/>
            <view class="parrot-mini-title">
              <text class="parrot-mini-name">{{item.name}}</text>
              <view class="mini-gender-badge gender-{{item.gender}}">
                <image wx:if="{{item.gender === 'male'}}" class="mini-gender-icon-img" src="{{iconPaths.genderMale}}" mode="widthFix" binderror="handleIconError" data-key="genderMale" />
                <image wx:elif="{{item.gender === 'female'}}" class="mini-gender-icon-img" src="{{iconPaths.genderFemale}}" mode="widthFix" binderror="handleIconError" data-key="genderFemale" />
                <image wx:else class="mini-gender-icon-img" src="{{iconPaths.genderUnknown}}" mode="widthFix" binderror="handleIconError" data-key="genderUnknown" />
              </view>
            </view>
            <text class="parrot-mini-species">{{item.species_name || (item.species && item.species.name) || ''}}</text>
            <view class="health-badge health-{{item.current_health_status || 'healthy'}}">{{item.current_health_status_text || '健康'}}</view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 快速操作区域 -->
    <view class="quick-actions-card">
      <view class="card-header">
        <text class="card-title">快速操作</text>
      </view>
      <view class="actions-grid">
        <view class="action-item feeding {{!isLogin ? 'disabled' : ''}}" bindtap="navigateToFeedingRecords">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.quickFeeding}}" mode="widthFix" binderror="handleIconError" data-key="actions.quickFeeding"/>
          </view>
          <text class="action-label">喂食记录</text>
        </view>
        <view class="action-item training {{!isLogin ? 'disabled' : ''}}" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.quickCleaning}}" mode="widthFix" binderror="handleIconError" data-key="actions.quickCleaning"/>
          </view>
          <text class="action-label">清洁记录</text>
        </view>
        <view class="action-item health {{!isLogin ? 'disabled' : ''}}" bindtap="quickHealth">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.quickHealth}}" mode="widthFix" binderror="handleIconError" data-key="actions.quickHealth"/>
          </view>
          <text class="action-label">健康检查</text>
        </view>
        <view class="action-item add-expense {{!isLogin ? 'disabled' : ''}}" bindtap="quickBreeding">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.quickBreeding}}" mode="widthFix" binderror="handleIconError" data-key="actions.quickBreeding"/>
          </view>
    <text class="action-label">繁殖记录</text>
        </view>
        <view class="action-item add {{!isLogin ? 'disabled' : ''}}" bindtap="addParrot">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.addParrot}}" mode="widthFix" binderror="handleIconError" data-key="actions.addParrot"/>
          </view>
          <text class="action-label">添加鹦鹉</text>
        </view>
        <view class="action-item expenses {{!isLogin ? 'disabled' : ''}}" bindtap="quickExpense">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.quickExpense}}" mode="widthFix" binderror="handleIconError" data-key="actions.quickExpense"/>
          </view>
          <text class="action-label">添加收支</text>
        </view>
        <view class="action-item management {{!isLogin ? 'disabled' : ''}}" bindtap="goToExpenseManagement">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.expenseMgmt}}" mode="widthFix" binderror="handleIconError" data-key="actions.expenseMgmt"/>
          </view>
          <text class="action-label">收支管理</text>
        </view>
        <view class="action-item Careguide {{!isLogin ? 'disabled' : ''}}" bindtap="navigateToCareguide">
          <view class="action-icon-wrapper">
        <image class="action-icon-img" src="{{iconPaths.actions.Careguide}}" mode="widthFix" binderror="handleIconError" data-key="actions.Careguide"/>
          </view>
          <text class="action-label">护理指南</text>
        </view>
      </view>
    </view>

    <!-- 最近活动 -->
    <view class="recent-activity-card" wx:if="{{recentRecords.length > 0}}">
      <view class="card-header">
        <text class="card-title">最近活动</text>
      </view>
      <view class="activity-list">
        <view class="activity-item {{item.type === 'feeding' ? 'orange-theme' : (item.type === 'health' ? 'green-theme' : (item.type === 'cleaning' ? 'blue-theme' : 'purple-theme'))}}" 
              wx:for="{{recentRecords}}" wx:key="id" wx:if="{{index < 3}}">
          <view class="activity-icon-container">
        <image class="activity-icon-img" src="{{item.iconPath}}" mode="widthFix" binderror="handleActivityIconError" data-index="{{index}}" />
          </view>
          <view class="activity-content">
            <text class="activity-title">给{{item.parrot_name}}{{item.title}}</text>
            <text class="activity-subtitle">{{item.timeText || item.time}}</text>
          </view>
          <view class="activity-dot {{item.type === 'feeding' ? 'orange' : (item.type === 'health' ? 'green' : (item.type === 'cleaning' ? 'blue' : 'purple'))}}"></view>
        </view>
      </view>
    </view>

  <!-- 健康提醒 -->
  <view class="health-alerts" wx:if="{{healthAlerts.length > 0}}">
    <view class="card">
      <view class="card-header">
        <text class="card-title">健康提醒</text>
        <text class="more-link" bindtap="navigateToHealthAlerts">查看全部</text>
      </view>
      <view class="card-content">
        <view class="alert-list">
          <view class="alert-item {{item.severity}}" wx:for="{{healthAlerts}}" wx:key="id">
      <view class="alert-icon"><image class="alert-icon-img" src="{{iconPaths.alertInfo}}" mode="widthFix" binderror="handleIconError" data-key="alertInfo"/></view>
            <view class="alert-content">
              <view class="alert-title">{{item.title}}</view>
              <view class="alert-subtitle">{{item.description}}</view>
            </view>
          </view>
      </view>
    </view>
  </view>
</view>

  <!-- 编辑模式完成按钮 -->
  <view wx:if="{{isEditMode}}" class="edit-done-btn-container">
    <button class="edit-done-btn-fixed" bindtap="exitEditMode">完成</button>
  </view>

<!-- 自定义底部导航 -->
<bottom-nav active="index" />

<!-- 统一使用通用弹窗组件：添加鹦鹉 -->
<parrot-modal 
  visible="{{showAddParrotModal}}"
  mode="add"
  parrotTypes="{{parrotTypes}}"
  speciesList="{{speciesList}}"
  bind:cancel="closeAddParrotModal"
  bind:submit="submitNewParrotFromComponent"
/>

<!-- 添加收支记录弹窗组件 -->
<expense-modal 
  visible="{{showAddExpenseModal}}" 
  modalTopOffsetPx="{{modalTopOffsetPx}}"
  modalBottomOffsetPx="{{modalBottomOffsetPx}}"
  bind:close="closeAddExpenseModal"
  bind:success="onExpenseSuccess"
/>

    <!-- 登录提示 -->
    <view class="login-prompt-card" wx:if="{{!isLogin}}">
      <view class="login-content">
      <view class="login-icon"><image class="login-icon-img" src="{{iconPaths.logo}}" mode="widthFix" binderror="handleIconError" data-key="defaultParrot"/></view>
        <text class="login-title">欢迎使用鹦鹉管家</text>
        <text class="login-subtitle">请先登录以使用完整功能</text>
        <button class="login-btn" bindtap="handleLogin">微信快速登录</button>
      </view>
    </view>
  </view>
</view>
