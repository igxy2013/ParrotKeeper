<!--pages/index/index.wxml-->
<view class="page-container">
  <!-- 顶部导航统一为组件 -->
  <app-header title="鹦鹉管家" subtitle="专业鹦鹉护理助手">
    <view slot="actions" class="header-btn" bindtap="openNotifications" style="position: relative;">
      <text class="icon-notification">🔔</text>
      <view wx:if="{{unreadCount > 0}}" style="position:absolute;top:6rpx;right:6rpx;min-width:28rpx;height:28rpx;padding:0 8rpx;border-radius:14rpx;background:#ff4757;color:#fff;font-size:20rpx;line-height:28rpx;text-align:center;">{{unreadCount}}</view>
    </view>
  </app-header>

  <notification-center 
    visible="{{showNotifications}}" 
    notifications="{{notifications}}"
    bind:close="closeNotifications"
    bind:markAllRead="markAllNotificationsRead"
    bind:clearAll="clearAllNotifications"
    bind:itemTap="handleNotificationTap"
  />

  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 欢迎卡片 -->
    <view class="welcome-card">
      <view class="welcome-bg-circle circle-1"></view>
      <view class="welcome-bg-circle circle-2"></view>
      <view class="welcome-content">
        <text class="welcome-greeting">{{greeting}}，{{userInfo.nickname || userInfo.username || '鹦鹉爱好者'}}！</text>
        <text class="welcome-message">今天也要好好照顾小家伙们哦 🦜</text>
        <view class="status-indicator">
          <view class="status-dot"></view>
          <text class="status-text">{{overview.total_parrots || 0}}只鹦鹉状态良好</text>
        </view>
      </view>
    </view>

    <!-- 统计数据网格 -->
    <view class="stats-grid">
      <view class="stat-card" bindtap="navigateToParrots">
        <view class="stat-icon-container emerald">
          <text class="stat-icon">♥</text>
        </view>
        <view class="stat-value emerald-text">{{overview.total_parrots || 0}}</view>
        <view class="stat-label">我的鹦鹉</view>
      </view>
      <view class="stat-card" bindtap="navigateToFeedingRecords">
        <view class="stat-icon-container orange">
          <text class="stat-icon">🍎</text>
        </view>
        <view class="stat-value orange-text">{{overview.today_records.feeding || 0}}</view>
        <view class="stat-label">今日喂食</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon-container green">
          <text class="stat-icon">💰</text>
        </view>
        <view class="stat-value green-text">¥{{overview.monthly_income || 0}}</view>
        <view class="stat-label">本月收入</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon-container blue">
          <text class="stat-icon">💰</text>
        </view>
        <view class="stat-value blue-text">¥{{overview.monthly_expense || 1265}}</view>
        <view class="stat-label">本月支出</view>
      </view>
    </view>

    <!-- 我的鹦鹉卡片 -->
    <view class="my-parrots-card" wx:if="{{myParrots.length > 0}}">
      <view class="card-header">
        <text class="card-title">♥ 我的鹦鹉</text>
        <text class="more-link" bindtap="navigateToParrots">查看全部 →</text>
      </view>
      <view class="parrot-card-list">
        <view class="parrot-mini-card" wx:for="{{myParrots}}" wx:key="id" data-id="{{item.id}}" bindtap="openParrotDetail">
          <image class="parrot-mini-avatar" src="{{item.photo_url || '/images/default-parrot.svg'}}" mode="aspectFit" data-id="{{item.id}}" binderror="handleIndexParrotImageError"/>
          <text class="parrot-mini-name">{{item.name}}</text>
          <text class="parrot-mini-species">{{item.species_name || (item.species && item.species.name) || ''}}</text>
          <view class="parrot-mini-badge {{item.health_status}}">{{item.health_text || '健康'}}</view>
        </view>
      </view>
    </view>

    <!-- 快速操作区域 -->
    <view class="quick-actions-card">
      <view class="card-header">
        <text class="card-title">⚡ 快速操作</text>
      </view>
      <view class="actions-grid">
        <view class="action-item feeding {{!isLogin ? 'disabled' : ''}}" bindtap="navigateToFeedingRecords">
          <view class="action-icon-wrapper">
            <text class="action-icon">🍎</text>
          </view>
          <text class="action-label">喂食记录</text>
        </view>
        <view class="action-item health {{!isLogin ? 'disabled' : ''}}" bindtap="quickHealth">
          <view class="action-icon-wrapper">
            <text class="action-icon">♥</text>
          </view>
          <text class="action-label">健康检查</text>
        </view>
        <view class="action-item training {{!isLogin ? 'disabled' : ''}}" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
            <text class="action-icon">🧽</text>
          </view>
          <text class="action-label">清洁记录</text>
        </view>
        <view class="action-item add-expense {{!isLogin ? 'disabled' : ''}}" bindtap="quickBreeding">
          <view class="action-icon-wrapper">
            <text class="action-icon">🥚</text>
          </view>
    <text class="action-label">繁殖记录</text>
        </view>
        <view class="action-item add {{!isLogin ? 'disabled' : ''}}" bindtap="addParrot">
          <view class="action-icon-wrapper">
            <text class="action-icon">➕</text>
          </view>
          <text class="action-label">添加鹦鹉</text>
        </view>
        <view class="action-item expenses {{!isLogin ? 'disabled' : ''}}" bindtap="quickExpense">
          <view class="action-icon-wrapper">
            <text class="action-icon">💰</text>
          </view>
          <text class="action-label">添加收支</text>
        </view>
        <view class="action-item statistics {{!isLogin ? 'disabled' : ''}}" bindtap="goToExpenseManagement">
          <view class="action-icon-wrapper">
            <text class="action-icon">💰</text>
          </view>
          <text class="action-label">收支管理</text>
        </view>
        <view class="action-item guide {{!isLogin ? 'disabled' : ''}}" bindtap="quickCleaning">
          <view class="action-icon-wrapper">
            <text class="action-icon">📖</text>
          </view>
          <text class="action-label">护理指南</text>
        </view>
      </view>
    </view>

    <!-- 最近活动 -->
    <view class="recent-activity-card" wx:if="{{recentRecords.length > 0}}">
      <view class="card-header">
        <text class="card-title">🕒 最近活动</text>
      </view>
      <view class="activity-list">
        <view class="activity-item orange-theme" wx:if="{{recentRecords.length > 0}}">
          <view class="activity-icon-container">
            <text class="activity-icon">🍎</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">给小彩喂食了小米</text>
            <text class="activity-subtitle">2小时前 • 营养均衡</text>
          </view>
          <view class="activity-dot orange"></view>
        </view>
        <view class="activity-item green-theme" wx:if="{{recentRecords.length > 1}}">
          <view class="activity-icon-container">
            <text class="activity-icon">♥</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">阿福完成健康检查</text>
            <text class="activity-subtitle">昨天 • 状态良好</text>
          </view>
          <view class="activity-dot green"></view>
        </view>
        <view class="activity-item purple-theme" wx:if="{{recentRecords.length > 2}}">
          <view class="activity-icon-container">
            <text class="activity-icon">📅</text>
          </view>
          <view class="activity-content">
            <text class="activity-title">小绿完成训练计划</text>
            <text class="activity-subtitle">3天前 • 学会新技能</text>
          </view>
          <view class="activity-dot purple"></view>
        </view>
      </view>
    </view>

  <!-- 健康提醒 -->
  <view class="health-alerts" wx:if="{{healthAlerts.length > 0}}">
    <view class="card">
      <view class="card-header">
        <text class="card-title">健康提醒</text>
      </view>
      <view class="card-content">
        <view class="alert-list">
          <view class="alert-item" wx:for="{{healthAlerts}}" wx:key="id">
            <view class="alert-icon">⚠️</view>
            <view class="alert-content">
              <view class="alert-title">{{item.title}}</view>
              <view class="alert-subtitle">{{item.description}}</view>
            </view>
          </view>
      </view>
    </view>
  </view>
</view>

<!-- 添加鹦鹉弹窗（严格参考参考APP设计风格） -->
<view wx:if="{{showAddParrotModal}}" class="modal-overlay" catchtouchmove="true" bindtap="closeAddParrotModal">
  <view class="modal-content" catchtap="stopPropagation">
    <!-- 头部渐变区域 -->
    <view class="modal-header-gradient">
      <view class="modal-header-row">
        <text class="modal-title">添加新鹦鹉</text>
        <view class="modal-close-btn" bindtap="closeAddParrotModal">
          <text class="modal-close-icon">✕</text>
        </view>
      </view>
    </view>

    <!-- 弹窗内容 -->
    <scroll-view scroll-y="true" class="modal-scroll">
      <view class="form-section">
        <!-- 名字 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">❤</text>鹦鹉名字 *</text>
          <input class="text-input" placeholder="给您的鹦鹉起个可爱的名字" value="{{newParrot.name}}" bindinput="onParrotNameInput" />
        </view>

        <!-- 品种 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">🍃</text>鹦鹉品种 *</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{parrotTypes}}" value="{{typeIndex}}" bindchange="onTypePickerChange">
              <view class="picker-display">
                <text>{{newParrot.type ? newParrot.type : '请选择品种'}}</text>
                <text class="picker-arrow">▾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- 年龄 与 体重 -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">⏱</text>年龄</text>
            <input class="text-input" placeholder="如: 2岁" value="{{newParrot.age}}" bindinput="onParrotAgeInput" />
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">⚖</text>体重</text>
            <input class="text-input" placeholder="如: 35g" value="{{newParrot.weight}}" bindinput="onParrotWeightInput" />
          </view>
        </view>

        <!-- 性别 与 颜色 -->
        <view class="form-grid">
          <view class="form-item">
            <text class="form-label"><text class="label-icon">👤</text>性别</text>
            <view class="gender-row">
              <view class="gender-btn {{newParrot.gender === '雄性' ? 'gender-male active' : 'gender-male'}}" bindtap="setParrotGender" data-gender="雄性">雄性</view>
              <view class="gender-btn {{newParrot.gender === '雌性' ? 'gender-female active' : 'gender-female'}}" bindtap="setParrotGender" data-gender="雌性">雌性</view>
            </view>
          </view>
          <view class="form-item">
            <text class="form-label"><text class="label-icon">🎨</text>主要颜色</text>
            <input class="text-input" placeholder="如: 绿色" value="{{newParrot.color}}" bindinput="onParrotColorInput" />
          </view>
        </view>

        <!-- 出生日期 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">📅</text>出生日期</text>
          <picker mode="date" value="{{newParrot.birthDate}}" bindchange="onBirthDateChange">
            <view class="picker-display">
              <text>{{newParrot.birthDate ? newParrot.birthDate : '请选择日期'}}</text>
              <text class="picker-arrow">▾</text>
            </view>
          </picker>
        </view>

        <!-- 备注信息 -->
        <view class="form-item">
          <text class="form-label"><text class="label-icon">📝</text>备注信息</text>
          <textarea class="textarea-input" placeholder="记录一些特殊信息，如性格特点、喜好等..." value="{{newParrot.notes}}" bindinput="onParrotNotesInput" />
        </view>
      </view>
    </scroll-view>

    <!-- 底部按钮 -->
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="closeAddParrotModal">取消</button>
      <button class="btn-primary" bindtap="submitNewParrot" disabled="{{!newParrot.name || !newParrot.type}}">添加鹦鹉</button>
    </view>
  </view>
</view>

<!-- 添加收支记录弹窗（严格参考参考APP设计） -->
<view wx:if="{{showAddExpenseModal}}" class="modal-overlay" catchtouchmove="true" bindtap="closeAddExpenseModal">
  <view class="expense-modal-card" catchtap="stopPropagation">
    <!-- 弹窗头部：标题与关闭按钮 -->
    <view class="expense-modal-header">
      <text class="expense-modal-title">添加收支记录</text>
      <view class="expense-modal-close" bindtap="closeAddExpenseModal">✕</view>
    </view>

    <!-- 弹窗主体内容 -->
    <scroll-view scroll-y="true" class="expense-modal-scroll">
      <view class="expense-form-section">
        <!-- 类型切换：收入 / 支出 -->
        <view class="form-item">
          <text class="form-label">记录类型</text>
          <view class="type-switch-row">
            <view class="type-btn {{expenseForm.type==='收入' ? 'type-income active' : 'type-income'}}" bindtap="setExpenseType" data-type="收入">收入</view>
            <view class="type-btn {{expenseForm.type==='支出' ? 'type-expense active' : 'type-expense'}}" bindtap="setExpenseType" data-type="支出">支出</view>
          </view>
        </view>

        <!-- 选择鹦鹉 -->
        <view class="form-item">
          <text class="form-label">选择鹦鹉</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{parrotOptions}}" value="{{expenseForm.parrotIndex}}" bindchange="onExpenseParrotChange">
              <view class="picker-display">
                <text>{{parrotOptions[expenseForm.parrotIndex] || '请选择鹦鹉'}}</text>
                <text class="picker-arrow">▾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- 选择类别 -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}类别</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{categoryOptions}}" value="{{expenseForm.categoryIndex}}" bindchange="onExpenseCategoryChange">
              <view class="picker-display">
                <text>{{categoryOptions[expenseForm.categoryIndex] || '请选择类别'}}</text>
                <text class="picker-arrow">▾</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- 金额 -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}金额</text>
          <input class="text-input" type="number" placeholder="请输入金额" value="{{expenseForm.amount}}" bindinput="onExpenseAmountInput" />
        </view>

        <!-- 描述 -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}描述</text>
          <input class="text-input" placeholder="请输入描述" value="{{expenseForm.description}}" bindinput="onExpenseDescInput" />
        </view>

        <!-- 日期 -->
        <view class="form-item">
          <text class="form-label">{{expenseForm.type}}日期</text>
          <picker mode="date" value="{{expenseForm.date}}" bindchange="onExpenseDateChange">
            <view class="picker-display">
              <text>{{expenseForm.date || '请选择日期'}}</text>
              <text class="picker-arrow">▾</text>
            </view>
          </picker>
        </view>
      </view>
    </scroll-view>

    <!-- 底部按钮 -->
    <view class="expense-modal-footer">
      <button class="btn-secondary" bindtap="closeAddExpenseModal">取消</button>
      <button class="btn-add {{expenseForm.type==='收入' ? 'btn-add-income' : 'btn-add-expense'}}" bindtap="submitExpenseRecord" disabled="{{!canSubmitExpense}}">添加</button>
    </view>
  </view>
</view>

    <!-- 登录提示 -->
    <view class="login-prompt-card" wx:if="{{!isLogin}}">
      <view class="login-content">
        <view class="login-icon">🦜</view>
        <text class="login-title">欢迎使用鹦鹉管家</text>
        <text class="login-subtitle">请先登录以使用完整功能</text>
        <button class="login-btn" bindtap="handleLogin">微信快速登录</button>
      </view>
    </view>
  </view>
</view>
