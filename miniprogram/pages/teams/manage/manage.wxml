<view class="page-container">
  <app-header title="团队管理" subtitle="管理团队信息与成员" showBack="{{true}}"></app-header>
  <view class="page-content">
    <!-- 团队信息概览 -->
    <view class="card info-card">
      <view class="card-content info-overview">
        <view class="info-left">
          <!-- 添加团队头像显示 -->
          <image class="team-avatar" src="{{teamInfo.avatar_url || '/images/remix/group-line-gray.png'}}" mode="aspectFill" />
          <view class="info-text">
            <text class="info-name">{{teamInfo.name || '未命名团队'}}</text>
            <text class="info-desc">{{teamInfo.description || '暂无描述'}}</text>
            <view class="info-meta">
              <text class="tag">{{currentRoleDisplay || (isTeamOwner ? '创建者' : (isTeamAdmin ? '管理员' : '成员'))}}</text>
              <text class="meta-text">成员 {{members.length || 0}}</text>
              <text class="meta-text">邀请码 {{teamInfo.invite_code || '—'}}</text>
            </view>
          </view>
        </view>
        <view class="info-actions">
          <!-- 编辑按钮使用白色图标，避免依赖滤镜 -->
          <button class="icon-btn" bindtap="showEditModal">
            <image class="icon-img" src="/images/remix/edit-line-white.png" mode="aspectFit" />
          </button>
        </view>
      </view>
    </view>

    <!-- 移除基本信息卡片 -->

    <!-- 邀请码 -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">团队邀请码</text>
      </view>
      <view class="card-content">
        <view class="invite-row">
          <text class="invite-code">{{teamInfo.invite_code || '暂无'}}</text>
          <button class="btn btn-secondary wide short" bindtap="copyInviteCode" disabled="{{!teamInfo.invite_code}}">复制</button>
        </view>
        <text class="tips">使用邀请码让成员加入团队</text>
      </view>
    </view>

    <!-- 成员管理 -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">成员管理</text>
      </view>
      <view class="card-content">
        <block wx:if="{{members && members.length}}">
          <view class="member-item" wx:for="{{members}}" wx:key="id">
            <image class="avatar" src="{{item.avatar_url || '/images/remix/user-line.png'}}" mode="aspectFill" />
            <view class="member-info">
              <text class="name">{{item.nickname || '未命名'}}</text>
              <text class="role">角色：{{item.role_display}}</text>
              <text class="meta">分组：{{item.group_name || '未分组'}}</text>
            </view>
            <view class="member-actions">
              <button class="icon-btn small" bindtap="assignMemberGroup" data-user-id="{{item.id}}" disabled="{{!(isTeamOwner || isTeamAdmin)}}">
                <image class="icon-img" src="/images/remix/group-line-white.png" mode="aspectFit" />
              </button>
              <button class="icon-btn icon-delete small" bindtap="removeMember" data-user-id="{{item.id}}" disabled="{{!isTeamOwner || item.role === 'owner'}}">
                <image class="icon-img" src="/images/remix/delete-bin-line-white.png" mode="aspectFit" />
              </button>
            </view>
          </view>
        </block>
        <block wx:else>
          <view class="empty">暂无成员</view>
        </block>
      </view>
    </view>

    <!-- 分组管理 -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">分组管理</text>
        <view class="card-actions">
          <button class="btn btn-secondary short" bindtap="showCreateGroup" disabled="{{!(isTeamOwner || isTeamAdmin)}}">新增分组</button>
        </view>
      </view>
      <view class="card-content">
        <block wx:if="{{groups && groups.length}}">
          <view class="group-item" wx:for="{{groups}}" wx:key="id">
          <view class="group-info">
              <text class="name">{{item.name}}</text>
              <text class="desc">{{item.description || '—'}}</text>
              <text class="meta">权限：{{item.permission_scope === 'team' ? '查看/编辑团队所有信息' : '查看/编辑本组所有信息'}}</text>
          </view>
          <view class="group-actions">
              <button class="icon-btn icon-edit small" bindtap="showEditGroup" data-group-id="{{item.id}}" disabled="{{!(isTeamOwner || isTeamAdmin)}}">
                <image class="icon-img" src="/images/remix/edit-line-white.png" mode="aspectFit" />
              </button>
              <button class="icon-btn icon-delete small" bindtap="deleteGroup" data-group-id="{{item.id}}" disabled="{{!(isTeamOwner || isTeamAdmin)}}">
                <image class="icon-img" src="/images/remix/delete-bin-line-white.png" mode="aspectFit" />
              </button>
            </view>
          </view>
        </block>
        <block wx:else>
          <view class="empty">暂无分组</view>
        </block>
      </view>
    </view>

    <!-- 操作 -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">其他操作</text>
      </view>
      <view class="card-content">
        <view class="btn-row">
          <button class="btn btn-secondary wide short" bindtap="confirmLeaveTeam" disabled="{{isTeamOwner}}">离开团队</button>
          <button class="btn btn-danger wide short" bindtap="confirmDissolveTeam" wx:if="{{isTeamOwner}}">解散团队</button>
        </view>
      </view>
    </view>
  </view>
  <bottom-nav active="profile" />
</view>

<!-- 添加团队编辑弹窗 -->
<team-edit-modal 
  visible="{{showEditModal}}" 
  team-info="{{teamInfo}}"
  bind:close="hideEditModal"
  bind:submit="handleEditSubmit"
/>

<!-- 分组编辑弹窗（对齐 parrot-modal 规范样式） -->
<view wx:if="{{showGroupEdit}}" class="modal-overlay" bindtap="hideGroupEdit"></view>
<view wx:if="{{showGroupEdit}}" class="modal-content">
  <view class="modal-card" catchtap="stopPropagation">
    <view class="modal-header-gradient">
      <view class="modal-header-row">
        <text class="modal-title">{{groupEditId ? '编辑分组' : '新增分组'}}</text>
        <view class="modal-close-btn" bindtap="hideGroupEdit"><text class="modal-close-icon">✕</text></view>
      </view>
    </view>
    <scroll-view scroll-y="true" class="modal-scroll">
      <view class="form-section">
        <view class="form-item">
          <text class="form-label">分组名称 *</text>
          <input class="text-input" placeholder="请输入分组名称" value="{{groupEditName}}" bindinput="onGroupNameInput" />
        </view>
        <view class="form-item">
          <text class="form-label">分组权限 *</text>
          <view class="picker-wrapper">
            <picker mode="selector" range="{{permissionOptions}}" value="{{permissionIndex}}" bindchange="onPermissionChange">
              <view class="picker-display">
                <text>{{permissionOptions[permissionIndex]}}</text>
                <image class="picker-arrow" src="/images/remix/arrow-down-s-line-gray.png" mode="aspectFit" />
              </view>
            </picker>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">分组权限清单</text>
          <block wx:for="{{permissionCatalog}}" wx:key="key" wx:for-item="grp">
            <view class="form-item">
              <view class="picker-display" bindtap="togglePermissionGroup" data-group-key="{{grp.key}}">
                <text>{{grp.label}}</text>
                <image class="picker-arrow" src="/images/remix/arrow-down-s-line-gray.png" mode="aspectFit" />
              </view>
              <view wx:if="{{!permissionCollapsed[grp.key]}}">
                <block wx:for="{{grp.children}}" wx:key="key" wx:for-item="child">
                  <view style="display:flex; align-items:center; justify-content:space-between; padding:16rpx 20rpx; border-bottom:1rpx solid #f3f4f6;">
                    <text style="font-size:26rpx; color:#374151;">{{child.label}}</text>
                    <view class="icon-btn small" bindtap="togglePermissionItem" data-key="{{child.key}}" style="background: {{permissionSelections[child.key] ? '#10b981' : '#e5e7eb'}};">
                      <text style="color:#fff; font-size:28rpx;">{{permissionSelections[child.key] ? '✓' : ''}}</text>
                    </view>
                  </view>
                </block>
              </view>
            </view>
          </block>
        </view>
        <view class="form-item">
          <text class="form-label">分组成员</text>
          <view class="picker-display" catchtap="toggleMemberDropdown">
            <view class="item-line">
              <text class="item-name">{{selectedGroupMembers.length ? '已选择 ' + selectedGroupMembers.length + ' 人' : '选择成员加入该分组'}}</text>
            </view>
            <image class="picker-arrow" src="/images/remix/arrow-down-s-line-gray.png" mode="aspectFit" />
          </view>
          <view class="selected-members" wx:if="{{selectedGroupMembers.length}}">
            <view class="member-chip" wx:for="{{selectedGroupMembers}}" wx:key="user_id">
              <text class="chip-name">{{item.nickname}}</text>
              <view class="chip-remove" bindtap="removeSelectedMember" data-user-id="{{item.user_id}}">✕</view>
            </view>
          </view>
          <view class="dropdown-menu dropdown-panel" wx:if="{{showMemberDropdown}}" catchtap="stopPropagation">
            <view class="search-row">
              <input 
                class="search-input" 
                placeholder="搜索成员昵称" 
                value="{{groupMemberSearchKeyword}}" 
                bindinput="onMemberSearchInput" 
              />
              <view class="clear-btn" wx:if="{{groupMemberSearchKeyword}}" bindtap="clearMemberSearch">清除</view>
            </view>
            <scroll-view scroll-y="true" class="dropdown-scroll">
              <view class="dropdown-item" wx:for="{{filteredMemberOptions}}" wx:key="user_id" catchtap="addMemberFromDropdown" data-user-id="{{item.user_id}}">
                <view class="item-line">
                  <text class="item-name">{{item.nickname}}</text>
                  <text class="item-meta">{{item.role_display}}</text>
                </view>
                <text class="check-icon">{{item.selected ? '✓' : ''}}</text>
              </view>
              <view class="dropdown-item" wx:if="{{!filteredMemberOptions.length}}">
                <text class="item-text">暂无可添加成员</text>
              </view>
            </scroll-view>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">分组描述</text>
          <textarea class="textarea-input" placeholder="请输入分组描述" value="{{groupEditDesc}}" bindinput="onGroupDescInput"></textarea>
        </view>
      </view>
    </scroll-view>
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="hideGroupEdit">取消</button>
      <button class="btn-primary" bindtap="submitGroupEdit">保存</button>
    </view>
  </view>
</view>

<!-- 已将分组权限清单整合到分组编辑弹窗 -->
