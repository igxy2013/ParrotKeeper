<!-- pages/records/cleaning/cleaning.wxml -->
<view class="cleaning-page">
  <!-- é€šç”¨å¤´éƒ¨ç»„ä»¶ -->
  <app-header title="æ¸…æ´è®°å½•" subtitle="é¹¦é¹‰æ¸…æ´æŠ¤ç†ç®¡ç†" showBack="{{true}}" theme="blue">
    <view slot="actions" class="header-btn" bindtap="addCleaningRecord">
      <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" />
    </view>
  </app-header>

  <!-- Content -->
  <scroll-view class="content" scroll-y="true" bindscrolltolower="onListScrollLower" lower-threshold="50">
    <!-- Filter Chips (aligned with feeding page design) -->
    <view class="filter-section">
      <scroll-view scroll-x="true" class="chip-scroll">
        <block wx:for="{{filterOptions}}" wx:key="*this">
          <view class="chip {{selectedFilter === item ? 'active' : ''}}" bindtap="selectFilter" data-filter="{{item}}">
            <text class="chip-text">{{item}}</text>
          </view>
        </block>
      </scroll-view>
    </view>
    <!-- Summary Card (aligned with feeding stats design) -->
    <view class="summary-card rounded-3xl p-6 shadow-xl">
      <text class="summary-title text-lg font-bold">æ¸…æ´ç»Ÿè®¡</text>
      <view class="summary-grid">
        <view class="summary-metric">
          <text class="summary-value text-2xl font-bold">{{stats.weeklyCount}}</text>
          <text class="summary-label text-sm text-white-80">æœ¬å‘¨æ¸…æ´</text>
        </view>
        <view class="summary-metric">
          <text class="summary-value text-2xl font-bold">{{stats.uniqueTypes}}</text>
          <text class="summary-label text-sm text-white-80">æ¸…æ´ç±»å‹</text>
        </view>
        <view class="summary-metric last-metric">
          <text class="summary-value text-2xl font-bold">{{stats.lastTimeText || 'â€”'}}</text>
          <text class="summary-label text-sm text-white-80">æœ€è¿‘ä¸€æ¬¡</text>
        </view>
      </view>
    </view>

    <!-- æœç´¢ä¸æ—¥æœŸç­›é€‰ -->
    <view class="search-filter">
      <input class="search-input" placeholder="æœç´¢ï¼ˆé¹¦é¹‰/ç±»å‹/å¤‡æ³¨ï¼‰" value="{{searchQuery}}" bindinput="onSearchInput" confirm-type="search" />
      <view class="date-filter-row">
        <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
          <view class="date-picker">{{startDate || 'å¼€å§‹æ—¥æœŸ'}}</view>
        </picker>
        <text class="range-sep">â€”</text>
        <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
          <view class="date-picker">{{endDate || 'ç»“æŸæ—¥æœŸ'}}</view>
        </picker>
        <view class="clear-date" bindtap="clearDateFilter">æ¸…é™¤</view>
      </view>
    </view>

    <!-- Cleaning Records -->
    <view class="list" wx:if="{{displayRecords.length > 0}}">
      <block wx:for="{{virtualDisplayRecords}}" wx:key="id">
        <view class="card" bindtap="viewRecordDetail" data-type="cleaning" data-id="{{item.id}}" data-ids="{{item.record_ids}}">
          <view class="card-left">
            <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
              <view class="avatar-cluster">
                <block wx:for="{{item.parrot_avatars}}" wx:for-item="avatar" wx:for-index="idx" wx:key="*this">
                  <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                    <image src="{{avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" lazy-load="true" />
                  </view>
                </block>
              </view>
            </block>
            <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
              <view class="single-avatar">
                <image src="{{item.parrot_avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" lazy-load="true" />
              </view>
            </block>
            <block wx:else>
              <view class="single-avatar">
                <image src="/images/default-parrot.png" class="cluster-img" mode="aspectFill" lazy-load="true" />
              </view>
            </block>
          </view>
          <view class="card-right">
            <view class="card-head">
              <view class="info">
                <text class="name">{{item.parrot_name}}</text>
                <text class="type-badge">{{item.cleaning_type_text || item.cleaning_type}}</text>
              </view>
              <view class="head-right">
                <view class="time">{{item.cleaning_time_formatted}}</view>
                <!-- ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’® -->
                <view class="action-buttons" wx:if="{{hasOperationPermission}}">
                  <view class="action-btn edit-btn" catchtap="editRecord" data-id="{{item.id}}" data-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}" data-cleaning-type-ids="{{item.cleaning_type_ids}}">
                    <image src="/images/remix/edit-line-white.png" class="action-icon-img" mode="aspectFit" />
                  </view>
                  <view class="action-btn delete-btn" catchtap="deleteRecord" data-id="{{item.id}}">
                    <image src="/images/remix/delete-bin-line-white.png" class="action-icon-img" mode="aspectFit" />
                  </view>
                </view>
              </view>
            </view>

            <view class="card-body">
        <view class="detail" wx:if="{{item.description}}">
          <text class="value">{{item.description}}</text>
        </view>
        <view class="detail" wx:if="{{item.notes}}">
          <text class="value">{{item.notes}}</text>
        </view>
        <view class="detail" wx:if="{{isTeamMode && item.created_by_username}}">
          <text class="value">{{item.created_by_username}}</text>
        </view>
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{displayRecords.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ§¹</view>
      <text class="empty-text">æš‚æ— æ¸…æ´è®°å½•</text>
        <view class="empty-subtitle">å¼€å§‹è®°å½•æ‚¨çš„æ¸…æ´è¿‡ç¨‹</view>
      <view class="btn-primary" bindtap="addCleaningRecord">æ·»åŠ æ¸…æ´è®°å½•</view>
    </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{loading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
  </scroll-view>
</view>
