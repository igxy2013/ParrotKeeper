<!--pages/records/feeding/feeding.wxml-->
<view class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-yellow-50 pb-6">
  <!-- 通用头部组件 -->
  <app-header title="喂食记录" subtitle="记录每次喂食情况" showBack="{{true}}" theme="orange">
    <view slot="actions" class="header-btn" bindtap="showAddForm">
      <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" />
    </view>
  </app-header>

  <!-- Main Content -->
  <view class="pt-6 px-4 space-y-6">
    <!-- Filter Chips (aligned with health page design) -->
    <view class="filter-section">
      <scroll-view class="chip-scroll" scroll-x="true">
        <view
          bindtap="selectParrot"
          data-parrot="全部"
          class="chip {{selectedParrot === '全部' ? 'active' : ''}}"
        >
          <text>全部</text>
        </view>
        <view
          wx:for="{{parrots}}"
          wx:key="id"
          bindtap="selectParrot"
          data-parrot="{{item.name}}"
          class="chip {{selectedParrot === item.name ? 'active' : ''}}"
        >
          <text>{{item.name}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- Today's Summary -->
    <view class="bg-gradient-header rounded-3xl p-6 text-white shadow-xl">
      <text class="text-lg font-bold mb-4 block">今日喂食统计</text>
      <view class="grid grid-cols-3 gap-4">
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.totalCount}}</view>
          <view class="text-white-80 text-sm">总次数</view>
        </view>
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.parrotCount}}</view>
          <view class="text-white-80 text-sm">鹦鹉数</view>
        </view>
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.totalAmount}}g</view>
          <view class="text-white-80 text-sm">总食量</view>
        </view>
      </view>
    </view>

    <!-- Feeding Records -->
    <view class="space-y-4">
      <view 
        wx:for="{{filteredRecords}}" 
        wx:key="key" 
        class="bg-white-80 backdrop-blur-sm rounded-2xl p-5 shadow-lg border border-white-50"
      >
        <view class="flex items-start space-x-4">
          <view class="flex items-center flex-shrink-0">
            <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
              <!-- 合并头像为单个圆形，最多显示3个 -->
              <view class="avatar-cluster">
                <block wx:for="{{item.parrot_avatars}}" wx:for-index="idx" wx:for-item="avatar" wx:key="idx">
                  <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                    <image src="{{avatar.url || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFit" />
                  </view>
                </block>
              </view>
            </block>
            <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
              <view class="single-avatar">
                <image 
                  src="{{item.parrot_avatar || '/images/default-parrot.png'}}" 
                  class="w-full h-full object-cover"
                  mode="aspectFit"
                />
              </view>
            </block>
            <block wx:else>
              <view class="single-avatar">
                <image 
                  src="/images/default-parrot.png" 
                  class="w-full h-full object-cover"
                  mode="aspectFit"
                />
              </view>
            </block>
          </view>
          <view class="flex-1">
            <view class="flex items-center justify-between mb-2">
              <view>
                <text class="font-semibold text-gray-800 block">{{item.parrot_names_display}}</text>
                <text class="text-xs text-gray-500">共{{item.parrot_count}}只鹦鹉</text>
              </view>
              <view class="flex items-center space-x-2">
                <view class="text-right mr-3">
                  <view class="text-sm font-medium text-gray-800">{{item.formatted_time}}</view>
                  <view class="text-xs text-gray-500">{{item.formatted_date}}</view>
                </view>
                <!-- 编辑和删除按钮 -->
                <view class="flex items-center space-x-1">
                  <view class="action-btn edit-btn" bindtap="editRecord" data-id="{{item.id}}" data-record-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}" data-feed-type-ids="{{item.feed_type_ids}}">
                    <image src="/images/remix/edit-line-white.png" class="action-icon-img" mode="aspectFit" />
                  </view>
                  <view class="action-btn delete-btn" bindtap="deleteRecord" data-id="{{item.id}}">
                    <image src="/images/remix/delete-bin-line-white.png" class="action-icon-img" mode="aspectFit" />
                  </view>
                </view>
              </view>
            </view>
            <view class="bg-gradient-soft rounded-xl p-3 mb-3">
              <view class="flex items-center justify-between mb-2" wx:if="{{item.food_types.length === 1}}">
                <text class="text-sm font-medium text-gray-700">食物类型</text>
                <text class="text-sm text-orange-600 font-semibold">{{item.food_types[0].name}}</text>
              </view>
              <view class="flex items-center justify-between" wx:if="{{item.food_types.length === 1}}">
                <text class="text-sm font-medium text-gray-700">食用量</text>
                <text class="text-sm text-orange-600 font-semibold">{{item.food_types[0].amount}}g</text>
              </view>
              <!-- Multiple food types -->
              <view wx:if="{{item.food_types.length > 1}}">
                <text class="text-sm font-medium text-gray-700 block mb-2">食物类型</text>
                <view wx:for="{{item.food_types}}" wx:key="id" wx:for-item="food" class="flex items-center justify-between mb-1">
                  <text class="text-sm text-orange-600">{{food.name}}</text>
                  <text class="text-sm text-orange-600 font-semibold">{{food.amount}}g</text>
                </view>
              </view>
            </view>
            <view class="bg-gray-50 rounded-lg p-3" wx:if="{{item.notes}}">
              <text class="text-sm text-gray-600">{{item.notes}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>


</view>
