<!--pages/records/feeding/feeding.wxml-->
<view class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-yellow-50 pb-6">
  <!-- 通用头部组件 -->
  <app-header title="喂食记录" subtitle="记录每次喂食情况" showBack="{{true}}" theme="orange">
    <view slot="actions" class="header-btn" bindtap="showAddForm">
      <text class="header-btn-icon">+</text>
    </view>
  </app-header>

  <!-- Main Content -->
  <view class="pt-6 px-4 space-y-6">
    <!-- Filter Tabs -->
    <view class="bg-white-80 backdrop-blur-sm rounded-2xl p-4 shadow-lg border border-white-50">
      <scroll-view class="flex space-x-2 overflow-x-auto" scroll-x="true">
        <button
          bindtap="selectParrot"
          data-parrot="全部"
          class="inline-flex btn-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-300 {{selectedParrot === '全部' ? 'bg-orange-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover-bg-gray-200'}}"
        >
          全部
        </button>
        <button
          wx:for="{{parrots}}"
          wx:key="id"
          bindtap="selectParrot"
          data-parrot="{{item.name}}"
          class="inline-flex btn-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-300 {{selectedParrot === item.name ? 'bg-orange-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover-bg-gray-200'}}"
        >
          <text>{{item.name}}</text>
        </button>
      </scroll-view>
    </view>

    <!-- Today's Summary -->
    <view class="bg-gradient-header rounded-3xl p-6 text-white shadow-xl">
      <text class="text-lg font-bold mb-4 block">今日喂食统计</text>
      <view class="grid grid-cols-3 gap-4">
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.totalCount}}</view>
          <view class="text-white-80 text-sm">总次数</view>
        </view>
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.parrotCount}}</view>
          <view class="text-white-80 text-sm">鹦鹉数</view>
        </view>
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.totalAmount}}g</view>
          <view class="text-white-80 text-sm">总食量</view>
        </view>
      </view>
    </view>

    <!-- Feeding Records -->
    <view class="space-y-4">
      <view 
        wx:for="{{filteredRecords}}" 
        wx:key="id" 
        class="bg-white-80 backdrop-blur-sm rounded-2xl p-5 shadow-lg border border-white-50"
      >
        <view class="flex items-start space-x-4">
          <view class="w-12 h-12 rounded-full overflow-hidden bg-gray-100 flex-shrink-0">
            <image 
              src="{{item.parrot_avatar || '/images/default-parrot.png'}}" 
              class="w-full h-full object-cover"
              mode="aspectFill"
            />
          </view>
          <view class="flex-1">
            <view class="flex items-center justify-between mb-2">
              <view>
                <text class="font-semibold text-gray-800 block">{{item.parrot_name}}</text>
                <text class="text-xs text-gray-500">{{item.parrot_type || '鹦鹉'}}</text>
              </view>
              <view class="text-right">
                <view class="text-sm font-medium text-gray-800">{{item.formatted_time}}</view>
                <view class="text-xs text-gray-500">{{item.formatted_date}}</view>
              </view>
            </view>
            <view class="bg-gradient-soft rounded-xl p-3 mb-3">
              <view class="flex items-center justify-between mb-2" wx:if="{{item.food_types.length === 1}}">
                <text class="text-sm font-medium text-gray-700">食物类型</text>
                <text class="text-sm text-orange-600 font-semibold">{{item.food_types[0].name}}</text>
              </view>
              <view class="flex items-center justify-between" wx:if="{{item.food_types.length === 1}}">
                <text class="text-sm font-medium text-gray-700">食用量</text>
                <text class="text-sm text-orange-600 font-semibold">{{item.amount}}g</text>
              </view>
              <!-- Multiple food types -->
              <view wx:if="{{item.food_types.length > 1}}">
                <text class="text-sm font-medium text-gray-700 block mb-2">食物类型</text>
                <view wx:for="{{item.food_types}}" wx:key="id" wx:for-item="food" class="flex items-center justify-between mb-1">
                  <text class="text-sm text-orange-600">{{food.name}}</text>
                  <text class="text-sm text-orange-600 font-semibold">{{food.amount}}g</text>
                </view>
              </view>
            </view>
            <view class="bg-gray-50 rounded-lg p-3" wx:if="{{item.notes}}">
              <text class="text-sm text-gray-600">{{item.notes}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- Add Record Modal -->
  <view class="fixed inset-0 bg-black-50 backdrop-blur-sm flex items-center justify-center z-50 p-4" wx:if="{{showAddModal}}" bindtap="hideAddForm">
    <view class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl modal-content modal-card" bindtap="stopPropagation">
      <view class="flex items-center justify-between mb-6 modal-header">
        <text class="text-lg font-bold text-gray-800">添加喂食记录</text>
        <button 
          bindtap="hideAddForm"
          class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center"
        >
          <text class="ri-close-line text-gray-600">×</text>
        </button>
      </view>
      
      <view class="space-y-4">
        <!-- 选择鹦鹉 -->
        <view>
          <text class="block text-sm font-medium text-gray-700 mb-2">选择鹦鹉</text>
          <button 
            bindtap="showParrotPicker"
            class="w-full p-3 border border-gray-200 rounded-xl focus-ring-2 focus-ring-orange-500 focus-border-transparent text-left bg-white"
          >
            <text class="{{selectedParrotNames ? 'text-gray-900' : 'text-gray-400'}}">
              {{selectedParrotNames || '请选择鹦鹉'}}
            </text>
          </button>
        </view>
        
        <!-- 食物类型 -->
        <view>
          <text class="block text-sm font-medium text-gray-700 mb-2">食物类型</text>
          <button 
            bindtap="showFoodTypePicker"
            class="w-full p-3 border border-gray-200 rounded-xl focus-ring-2 focus-ring-orange-500 focus-border-transparent text-left bg-white"
          >
            <text class="{{selectedFoodTypeNames ? 'text-gray-900' : 'text-gray-400'}}">
              {{selectedFoodTypeNames || '请选择食物'}}
            </text>
          </button>
        </view>
        
        <!-- 食用量 -->
        <view wx:if="{{newRecord.foodTypes.length === 1}}">
          <text class="block text-sm font-medium text-gray-700 mb-2">食用量</text>
          <input 
            type="digit"
            value="{{newRecord.amount}}"
            bindinput="onAmountInput"
            placeholder="例如：15（g）"
            class="w-full p-3 border border-gray-200 rounded-xl focus-ring-2 focus-ring-orange-500 focus-border-transparent"
          />
        </view>
        
        <!-- 多种食物的分别用量 -->
        <view wx:if="{{newRecord.foodTypes.length > 1}}">
          <text class="block text-sm font-medium text-gray-700 mb-2">各食物用量</text>
          <view wx:for="{{selectedFoodTypes}}" wx:key="id" class="mb-2">
            <text class="text-sm text-gray-600 mb-1 block">{{item.name}}</text>
            <input 
              type="digit"
              value="{{newRecord.foodAmounts[item.id]}}"
              bindinput="onFoodAmountInput"
              data-food-id="{{item.id}}"
              placeholder="用量(g)"
              class="w-full p-2 border border-gray-200 rounded-lg focus-ring-2 focus-ring-orange-500 focus-border-transparent"
            />
          </view>
        </view>
        
        <!-- 喂食日期 -->
        <view>
          <text class="block text-sm font-medium text-gray-700 mb-2">喂食日期</text>
          <picker 
            mode="date"
            value="{{newRecord.date}}"
            bindchange="onDateChange"
            class="w-full"
          >
            <view class="w-full p-3 border border-gray-200 rounded-xl focus-ring-2 focus-ring-orange-500 focus-border-transparent bg-white">
              <text class="{{newRecord.date ? 'text-gray-900' : 'text-gray-400'}}">
                {{newRecord.date || '选择日期'}}
              </text>
            </view>
          </picker>
        </view>
        
        <!-- 喂食时间 -->
        <view>
          <text class="block text-sm font-medium text-gray-700 mb-2">喂食时间</text>
          <picker 
            mode="time"
            value="{{newRecord.time}}"
            bindchange="onTimeChange"
            class="w-full"
          >
            <view class="w-full p-3 border border-gray-200 rounded-xl focus-ring-2 focus-ring-orange-500 focus-border-transparent bg-white">
              <text class="{{newRecord.time ? 'text-gray-900' : 'text-gray-400'}}">
                {{newRecord.time || '选择时间'}}
              </text>
            </view>
          </picker>
        </view>
        
        <!-- 备注 -->
        <view>
          <text class="block text-sm font-medium text-gray-700 mb-2">备注</text>
          <textarea 
            value="{{newRecord.notes}}"
            bindinput="onNotesInput"
            placeholder="记录鹦鹉的食欲状况..."
            class="w-full p-3 border border-gray-200 rounded-xl focus-ring-2 focus-ring-orange-500 focus-border-transparent resize-none"
            maxlength="200"
            show-count
          />
        </view>
        
        <!-- 照片上传 -->
        <view>
          <text class="block text-sm font-medium text-gray-700 mb-2">照片</text>
          <view class="photo-list">
            <view wx:for="{{newRecord.photos}}" wx:key="*this" class="photo-item">
              <image src="{{item}}" class="photo-preview" mode="aspectFill"/>
              <button class="photo-delete" bindtap="deletePhoto" data-index="{{index}}">×</button>
            </view>
            <button class="photo-add" bindtap="choosePhoto" wx:if="{{newRecord.photos.length < 3}}">
              <text class="photo-add-text">+</text>
            </button>
          </view>
        </view>
      </view>
      
      <view class="flex space-x-3 mt-6">
        <button 
          bindtap="hideAddForm"
          class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover-bg-gray-200 transition-colors"
        >
          取消
        </button>
        <button 
          bindtap="saveRecord"
          class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-xl font-medium hover-shadow-lg transition-all duration-300"
        >
          保存
        </button>
      </view>
    </view>
  </view>

  <!-- 鹦鹉选择器 -->
  <view class="picker-overlay" wx:if="{{showParrotPicker}}" bindtap="hideParrotPicker">
    <view class="picker-content" bindtap="stopPropagation">
      <view class="picker-header">
        <text class="picker-title">选择鹦鹉</text>
        <button class="picker-close" bindtap="hideParrotPicker">×</button>
      </view>
      <view class="picker-body">
        <view 
          wx:for="{{parrots}}" 
          wx:key="id" 
          class="picker-item" 
          bindtap="toggleParrot" 
          data-parrot-id="{{item.id}}"
        >
          <text class="picker-item-text">{{item.name}}</text>
          <text class="picker-check" wx:if="{{newRecord.parrotIds.includes(item.id)}}">✓</text>
        </view>
      </view>
      <view class="picker-footer">
        <button class="picker-confirm" bindtap="confirmParrotSelection">确定</button>
      </view>
    </view>
  </view>

  <!-- 食物类型选择器 -->
  <view class="picker-overlay" wx:if="{{showFoodTypePicker}}" bindtap="hideFoodTypePicker">
    <view class="picker-content" bindtap="stopPropagation">
      <view class="picker-header">
        <text class="picker-title">选择食物类型</text>
        <button class="picker-close" bindtap="hideFoodTypePicker">×</button>
      </view>
      <view class="picker-body">
        <view 
          wx:for="{{foodTypeList}}" 
          wx:key="id" 
          class="picker-item" 
          bindtap="toggleFoodType" 
          data-food-id="{{item.id}}"
        >
          <text class="picker-item-text">{{item.name}}</text>
          <text class="picker-check" wx:if="{{newRecord.foodTypes.includes(item.id)}}">✓</text>
        </view>
      </view>
      <view class="picker-footer">
        <button class="picker-confirm" bindtap="confirmFoodTypeSelection">确定</button>
      </view>
    </view>
  </view>
</view>
