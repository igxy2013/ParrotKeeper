<!--pages/records/feeding/feeding.wxml-->
<view class="feeding-page min-h-screen pb-6">
  <!-- é€šç”¨å¤´éƒ¨ç»„ä»¶ -->
  <app-header title="å–‚é£Ÿè®°å½•" subtitle="è®°å½•æ¯æ¬¡å–‚é£Ÿæƒ…å†µ" showBack="{{true}}" theme="orange">
    <view slot="actions" class="header-btn" bindtap="showAddForm">
      <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" />
    </view>
  </app-header>

  <!-- Main Content -->
  <scroll-view class="pt-6 px-4 space-y-6" scroll-y="true" bindscrolltolower="onListScrollLower" lower-threshold="50">
    <!-- Filter Chips (aligned with health page design) -->
    <view class="filter-section space-item">
      <scroll-view class="chip-scroll" scroll-x="true">
        <view
          bindtap="selectParrot"
          data-parrot="å…¨éƒ¨"
          class="chip {{selectedParrot === 'å…¨éƒ¨' ? 'active' : ''}}"
        >
          <text>å…¨éƒ¨</text>
        </view>
        <view
          wx:for="{{parrots}}"
          wx:key="id"
          bindtap="selectParrot"
          data-parrot="{{item.name}}"
          class="chip {{selectedParrot === item.name ? 'active' : ''}}"
        >
          <text>{{item.name}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- Today's Summary -->
    <view class="bg-gradient-header rounded-3xl p-6 text-white shadow-xl space-item">
      <text class="text-lg font-bold mb-4 block">ä»Šæ—¥å–‚é£Ÿç»Ÿè®¡</text>
      <view class="grid grid-cols-3 gap-4">
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.totalCount}}</view>
          <view class="text-white-80 text-sm">æ€»æ¬¡æ•°</view>
        </view>
        <view class="text-center">
          <view class="text-2xl font-bold">{{todayStats.parrotCount}}</view>
          <view class="text-white-80 text-sm">é¹¦é¹‰æ•°</view>
        </view>
        <view class="text-center">
          <view class="text-2xl font-bold stat-amount nowrap">
            <text class="stat-num">{{todayStats.totalAmountG}}</text>
            <text class="stat-unit">g</text>
            <text class="stat-sep">/</text>
            <text class="stat-num">{{todayStats.totalAmountML}}</text>
            <text class="stat-unit">ml</text>
          </view>
          <view class="text-white-80 text-sm">æ€»é£Ÿé‡</view>
        </view>
      </view>
    </view>

    <!-- æœç´¢ä¸æ—¥æœŸç­›é€‰ -->
    <view class="search-filter space-item">
      <input class="search-input" placeholder="æœç´¢ï¼ˆé¹¦é¹‰/é£Ÿç‰©/å¤‡æ³¨ï¼‰" value="{{searchQuery}}" bindinput="onSearchInput" confirm-type="search" />
      <view class="date-filter-row">
        <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
          <view class="date-picker">{{startDate || 'å¼€å§‹æ—¥æœŸ'}}</view>
        </picker>
        <text class="range-sep">â€”</text>
        <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
          <view class="date-picker">{{endDate || 'ç»“æŸæ—¥æœŸ'}}</view>
        </picker>
        <view class="clear-date" bindtap="clearDateFilter">æ¸…é™¤</view>
      </view>
    </view>

    <!-- Feeding Records -->
    <view class="space-y-4 space-item">
      <view 
        wx:for="{{virtualDisplayRecords}}" 
        wx:key="key" 
        class="bg-white-80 backdrop-blur-sm rounded-2xl p-5 shadow-lg border border-white-50 record-card"
        bindtap="viewRecordDetail" data-id="{{item.id}}" data-record-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}"
      >
        <view class="flex items-start space-x-4">
          <view class="flex items-center flex-shrink-0 x-space-item">
            <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
              <!-- åˆå¹¶å¤´åƒä¸ºå•ä¸ªåœ†å½¢ï¼Œæœ€å¤šæ˜¾ç¤º3ä¸ª -->
              <view class="avatar-cluster">
                <block wx:for="{{item.parrot_avatars}}" wx:for-index="idx" wx:for-item="avatar" wx:key="idx">
                  <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                    <image src="{{avatar.thumb || avatar.url || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" lazy-load="true" />
                  </view>
                </block>
              </view>
            </block>
            <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
              <view class="single-avatar">
                <image 
                  src="{{item.parrot_avatar || '/images/default-parrot.png'}}" 
                  class="w-full h-full object-cover"
                  mode="aspectFill"
                  lazy-load="true"
                />
              </view>
            </block>
            <block wx:else>
              <view class="single-avatar">
                <image 
                  src="/images/default-parrot.png" 
                  class="w-full h-full object-cover"
                  mode="aspectFill"
                />
              </view>
            </block>
          </view>
          <view class="flex-1 x-space-item">
            <view class="flex items-center justify-between mb-2">
              <view>
                <text class="font-semibold text-gray-800 block">{{item.parrot_names_display}}</text>
                <text class="text-xs text-gray-500">å…±{{item.parrot_count}}åªé¹¦é¹‰</text>
              </view>
              <view class="flex items-center space-x-2">
                <view class="text-right mr-3 x-space-item">
                  <view class="text-sm font-medium text-gray-800">{{item.formatted_time}}</view>
                  <view class="text-xs text-gray-500">{{item.formatted_date}}</view>
                </view>
                <!-- ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’® -->
                <view class="flex items-center space-x-1 x-space-item">
                  <view class="action-btn edit-btn x-space-item" catchtap="editRecord" data-id="{{item.id}}" data-record-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}" data-feed-type-ids="{{item.feed_type_ids}}">
                    <image src="/images/remix/edit-line-white.png" class="action-icon-img" mode="aspectFit" />
                  </view>
                  <view class="action-btn delete-btn x-space-item" catchtap="deleteRecord" data-id="{{item.id}}">
                    <image src="/images/remix/delete-bin-line-white.png" class="action-icon-img" mode="aspectFit" />
                  </view>
                </view>
              </view>
            </view>
            <view class="bg-gradient-soft rounded-xl p-3 mb-3">
              <view class="flex items-center justify-between mb-2" wx:if="{{item.food_types.length === 1}}">
                <text class="text-sm font-medium text-gray-700">é£Ÿç‰©ç±»å‹</text>
                <text class="text-sm text-orange-600 font-semibold">{{item.food_types[0].name}}</text>
              </view>
              <view class="flex items-center justify-between" wx:if="{{item.food_types.length === 1}}">
                <text class="text-sm font-medium text-gray-700">é£Ÿç”¨é‡</text>
                <text class="text-sm text-orange-600 font-semibold">{{item.food_types[0].amount}}{{item.food_types[0].unit}}</text>
              </view>
              <!-- Multiple food types -->
              <view wx:if="{{item.food_types.length > 1}}">
                <text class="text-sm font-medium text-gray-700 block mb-2">é£Ÿç‰©ç±»å‹</text>
                <view wx:for="{{item.food_types}}" wx:key="id" wx:for-item="food" class="flex items-center justify-between mb-1">
                  <text class="text-sm text-orange-600">{{food.name}}</text>
                  <text class="text-sm text-orange-600 font-semibold">{{food.amount}}{{food.unit}}</text>
                </view>
              </view>
            </view>
            <view class="bg-gray-50 rounded-lg p-3" wx:if="{{item.notes}}">
              <text class="text-sm text-gray-600">{{item.notes}}</text>
            </view>
          </view>
        </view>
      </view>
      <!-- ç©ºçŠ¶æ€ï¼ˆå‚è€ƒå¥åº·æ£€æŸ¥è®°å½•é¡µé¢ï¼‰ -->
      <view class="empty-state space-item" wx:if="{{virtualDisplayRecords.length === 0}}">
        <view class="empty-icon">ğŸ½ï¸</view>
        <view class="empty-text">æš‚æ— å–‚é£Ÿè®°å½•</view>
        <view class="empty-subtitle">å¼€å§‹è®°å½•æ‚¨çš„å–‚é£Ÿæƒ…å†µ</view>
        <view class="btn-primary" bindtap="showAddForm">æ·»åŠ å–‚é£Ÿè®°å½•</view>
      </view>
    </view>
  </scroll-view>


</view>
