<!--pages/health-check/health-check.wxml-->
<view class="page-container">
  <app-header title="å¥åº·æ£€æŸ¥è®°å½•" subtitle="è®°å½•é¹¦é¹‰å¥åº·çŠ¶å†µ" showBack="true" theme="purple">
    <view slot="actions" class="header-btn" bindtap="addHealthRecord">
      <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" lazy-load="true" />
    </view>
  </app-header>

  <view class="page-content">
    <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
    <view wx:if="{{!isLogin}}" class="guest-tip">
      <text class="tip-text">ğŸ¥ å¥åº·æ£€æŸ¥éœ€è¦ç™»å½•ä½¿ç”¨</text>
      <text class="tip-subtitle">ç™»å½•åå¯ä»¥è®°å½•å’ŒæŸ¥çœ‹æ‚¨çš„å¥åº·è®°å½•</text>
    </view>

    <!-- å·²ç™»å½•å†…å®¹ -->
    <view wx:if="{{isLogin}}">
      <!-- ç­›é€‰ï¼šé¹¦é¹‰æ ‡ç­¾ -->
      <view class="filter-section">
        <scroll-view scroll-x="true" class="chip-scroll" show-scrollbar="false">
          <view class="chip {{selectedParrotId === '' ? 'active' : ''}}" bindtap="switchParrot" data-id="" data-name="å…¨éƒ¨">
            <text>å…¨éƒ¨</text>
          </view>
          <view class="chip {{selectedParrotId === item.id ? 'active' : ''}}" wx:for="{{parrotsList}}" wx:key="id" bindtap="switchParrot" data-id="{{item.id}}" data-name="{{item.name}}">
            <text>{{item.name}}</text>
          </view>
        </scroll-view>
      </view>

      <!-- å¥åº·æ¦‚è§ˆå¡ç‰‡ -->
      <view class="overview-card rounded-3xl p-6 shadow-xl">
        <text class="overview-title text-lg font-bold">å¥åº·æ¦‚è§ˆ</text>
        <!-- å½“å‰ç­›é€‰æ ‡ç­¾æç¤º -->
        <view wx:if="{{activeOverviewFilter}}" class="overview-filter-tag" bindtap="clearOverviewFilter">
          <text class="tag-text">{{activeOverviewFilter === 'healthy' ? 'ç­›é€‰ï¼šå¥åº·é¹¦é¹‰' : (activeOverviewFilter === 'attention' ? 'ç­›é€‰ï¼šéœ€å…³æ³¨' : '')}}</text>
          <text class="tag-close">Ã—</text>
        </view>
        <view class="overview-grid">
          <view class="metric {{activeOverviewFilter === 'healthy' ? 'selected' : ''}}">
            <text class="metric-value text-2xl font-bold clickable" bindtap="onOverviewTap" data-filter="healthy">{{overview.healthyCount}}</text>
            <text class="metric-label text-sm text-white-80" bindtap="onOverviewTap" data-filter="healthy">å¥åº·é¹¦é¹‰</text>
          </view>
          <view class="metric {{activeOverviewFilter === 'attention' ? 'selected' : ''}}">
            <text class="metric-value text-2xl font-bold clickable" bindtap="onOverviewTap" data-filter="attention">{{overview.attentionCount}}</text>
            <text class="metric-label text-sm text-white-80" bindtap="onOverviewTap" data-filter="attention">éœ€å…³æ³¨</text>
          </view>
          <view class="metric">
            <text class="metric-value text-2xl font-bold">{{overview.checkCount}}</text>
            <text class="metric-label text-sm text-white-80">æ£€æŸ¥æ¬¡æ•°</text>
          </view>
        </view>
      </view>

      <!-- æœç´¢ä¸æ—¥æœŸç­›é€‰ï¼ˆä¸æ¸…æ´é¡µä¸€è‡´ï¼‰ -->
      <view class="search-filter">
        <input class="search-input" placeholder="æœç´¢ï¼ˆåç§°/ç—‡çŠ¶/æ²»ç–—/å¤‡æ³¨ï¼‰" value="{{searchQuery}}" bindinput="onSearchInput" confirm-type="search" />
        <view class="date-filter-row">
          <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
            <view class="date-picker">{{startDate || 'å¼€å§‹æ—¥æœŸ'}}</view>
          </picker>
          <text class="range-sep">â€”</text>
          <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
            <view class="date-picker">{{endDate || 'ç»“æŸæ—¥æœŸ'}}</view>
          </picker>
          <view class="clear-date" bindtap="clearDateFilter">æ¸…é™¤</view>
        </view>
      </view>

      <!-- è®°å½•åˆ—è¡¨ï¼ˆè™šæ‹ŸåŒ–ï¼‰ -->
      <scroll-view class="records-scroll" scroll-y="true" lower-threshold="50" bindscrolltolower="onListScrollLower">
        <view class="record-list" wx:if="{{virtualDisplayRecords.length > 0}}">
          <view class="record-card" wx:for="{{virtualDisplayRecords}}" wx:key="id" bindtap="viewRecordDetail" data-type="health" data-id="{{item.id}}">
          <view class="record-header">
            <view class="avatar-cell">
              <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
                <view class="avatar-cluster">
                  <block wx:for="{{item.parrot_avatars}}" wx:for-index="idx" wx:for-item="avatar" wx:key="*this">
                    <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                      <image src="{{avatar || '/images/parrot-avatar-green.svg'}}" class="cluster-img" mode="aspectFill" lazy-load="true" />
                    </view>
                  </block>
                </view>
              </block>
              <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
                <view class="single-avatar">
                  <image src="{{item.parrot_avatar || '/images/parrot-avatar-green.svg'}}" class="cluster-img" mode="aspectFill" lazy-load="true" />
                </view>
              </block>
              <block wx:else>
                <view class="single-avatar">
                  <image src="/images/parrot-avatar-green.svg" class="cluster-img" mode="aspectFill" lazy-load="true" />
                </view>
              </block>
            </view>
            <view class="record-info">
              <text class="record-title">{{item.parrot_name}}</text>
              <view class="record-meta">
                <text class="record-time">{{item.record_date_formatted}}</text>
                <text class="record-weight" wx:if="{{item.weight}}">ä½“é‡ï¼š{{item.weight}} g</text>
              </view>
              </view>
                <view class="header-right">
                  <view class="health-status-badge status-{{item.health_status}}">
                    {{item.health_status_text || 'å¥åº·'}}
                  </view>
                  <!-- ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’® -->
                  <view class="action-buttons">
                  <view class="action-btn edit-btn" catchtap="editRecord" data-id="{{item.id}}">
                    <image src="/images/remix/edit-line-white.png" class="action-icon-img" mode="aspectFit" lazy-load="true" />
                  </view>
                  <view class="action-btn delete-btn" catchtap="deleteRecord" data-id="{{item.id}}">
                    <image src="/images/remix/delete-bin-line-white.png" class="action-icon-img" mode="aspectFit" lazy-load="true" />
                  </view>
                </view>
              </view>
            </view>
          <view class="record-notes" wx:if="{{item.notes}}">
            <text class="notes-label">å¤‡æ³¨ï¼š</text>
            <text class="notes-value">{{item.notes}}</text>
          </view>
          </view>
        </view>
      </scroll-view>
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{virtualDisplayRecords.length === 0 && !loading}}">
        <view class="empty-icon">ğŸ¥</view>
        <view class="empty-text">æš‚æ— å¥åº·è®°å½•</view>
        <view class="empty-subtitle">å¼€å§‹è®°å½•æ‚¨çš„å¥åº·æ£€æŸ¥è¿‡ç¨‹</view>
        <view class="btn-primary" bindtap="addHealthRecord">æ·»åŠ å¥åº·è®°å½•</view>
      </view>
    </view>
  </view>
</view>
