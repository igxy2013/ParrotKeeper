<!--pages/records/add-record/add-record.wxml-->
<view class="page-container">
  <form bindsubmit="submitForm">
    <!-- è®°å½•ç±»å‹ -->
    <view class="form-section">
      <view class="section-title">è®°å½•ç±»å‹</view>
      
      <view class="type-selector">
        <view 
          class="type-item {{recordType === 'feeding' ? 'active' : ''}}"
          bindtap="selectType"
          data-type="feeding"
        >
          <view class="type-icon">ğŸ½ï¸</view>
          <text class="type-text">å–‚é£Ÿè®°å½•</text>
        </view>
        <view 
          class="type-item {{recordType === 'cleaning' ? 'active' : ''}}"
          bindtap="selectType"
          data-type="cleaning"
        >
          <view class="type-icon">ğŸ§¹</view>
          <text class="type-text">æ¸…æ´è®°å½•</text>
        </view>
        <view 
          class="type-item {{recordType === 'health_check' ? 'active' : ''}}"
          bindtap="selectType"
          data-type="health_check"
        >
          <view class="type-icon">ğŸ¥</view>
          <text class="type-text">å¥åº·æ£€æŸ¥</text>
        </view>
      </view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      
      <view class="form-item">
        <text class="form-label required">é€‰æ‹©é¹¦é¹‰</text>
        <view class="form-picker" bindtap="showParrotPicker">
          <text class="picker-text {{formData.parrot_id ? '' : 'placeholder'}}">
            {{selectedParrotName || 'è¯·é€‰æ‹©é¹¦é¹‰'}}
          </text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </view>
      
      <view class="form-item">
        <text class="form-label required">è®°å½•æ—¶é—´</text>
        <view class="datetime-picker">
          <picker 
            mode="date" 
            value="{{formData.record_date}}" 
            bindchange="onDateChange"
            end="{{today}}"
          >
            <view class="picker-item">
              <text class="picker-text {{formData.record_date ? '' : 'placeholder'}}">
                {{formData.record_date || 'é€‰æ‹©æ—¥æœŸ'}}
              </text>
            </view>
          </picker>
          <picker 
            mode="time" 
            value="{{formData.record_time}}" 
            bindchange="onTimeChange"
          >
            <view class="picker-item">
              <text class="picker-text {{formData.record_time ? '' : 'placeholder'}}">
                {{formData.record_time || 'é€‰æ‹©æ—¶é—´'}}
              </text>
            </view>
          </picker>
        </view>
      </view>
    </view>

    <!-- å–‚é£Ÿè®°å½•ç‰¹æœ‰å­—æ®µ -->
    <view class="form-section" wx:if="{{recordType === 'feeding'}}">
      <view class="section-title">å–‚é£Ÿè¯¦æƒ…</view>
      
      <view class="form-item">
        <text class="form-label">é£Ÿç‰©ç±»å‹</text>
        <input 
          class="form-input" 
          placeholder="å¦‚ï¼šç§å­ã€æ°´æœã€è”¬èœç­‰" 
          value="{{formData.food_type}}"
          bindinput="onInputChange"
          data-field="food_type"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">é£Ÿç‰©é‡ (g)</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥é£Ÿç‰©é‡é‡" 
          value="{{formData.amount}}"
          bindinput="onInputChange"
          data-field="amount"
          type="digit"
        />
      </view>
    </view>

    <!-- å¥åº·æ£€æŸ¥ç‰¹æœ‰å­—æ®µ -->
    <view class="form-section" wx:if="{{recordType === 'health_check'}}">
      <view class="section-title">å¥åº·è¯¦æƒ…</view>
      
      <view class="form-item">
        <text class="form-label">ä½“é‡ (g)</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥å½“å‰ä½“é‡" 
          value="{{formData.weight}}"
          bindinput="onInputChange"
          data-field="weight"
          type="digit"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">ä½“æ¸© (Â°C)</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥ä½“æ¸©" 
          value="{{formData.temperature}}"
          bindinput="onInputChange"
          data-field="temperature"
          type="digit"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">å¥åº·çŠ¶æ€</text>
        <view class="form-picker" bindtap="showHealthStatusPicker">
          <text class="picker-text {{formData.health_status ? '' : 'placeholder'}}">
            {{healthStatusText || 'è¯·é€‰æ‹©å¥åº·çŠ¶æ€'}}
          </text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </view>
    </view>

    <!-- ç…§ç‰‡ä¸Šä¼  -->
    <view class="form-section">
      <view class="section-title">è®°å½•ç…§ç‰‡ (å¯é€‰)</view>
      
      <view class="photo-upload">
        <view class="photo-list" wx:if="{{formData.photos.length > 0}}">
          <view 
            class="photo-item" 
            wx:for="{{formData.photos}}" 
            wx:key="*this"
          >
            <image 
              class="photo-image" 
              src="{{item}}" 
              mode="aspectFill"
              bindtap="previewPhoto"
              data-url="{{item}}"
            />
            <view 
              class="photo-delete" 
              bindtap="deletePhoto"
              data-index="{{index}}"
            >Ã—</view>
          </view>
          
          <view 
            class="add-photo-btn" 
            wx:if="{{formData.photos.length < 3}}"
            bindtap="choosePhoto"
          >
            <text class="add-icon">+</text>
          </view>
        </view>
        
        <view class="upload-area" wx:else bindtap="choosePhoto">
          <view class="upload-icon">ğŸ“·</view>
          <text class="upload-text">æ·»åŠ ç…§ç‰‡</text>
          <text class="upload-tip">æœ€å¤šå¯æ·»åŠ 3å¼ ç…§ç‰‡</text>
        </view>
      </view>
    </view>

    <!-- å¤‡æ³¨ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
      
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea 
          class="form-textarea" 
          placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰" 
          value="{{formData.notes}}"
          bindinput="onInputChange"
          data-field="notes"
          maxlength="500"
          show-confirm-bar="{{false}}"
        />
        <view class="char-count">{{formData.notes.length}}/500</view>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view class="form-actions">
      <button class="btn btn-secondary" bindtap="goBack">å–æ¶ˆ</button>
      <button 
        class="btn btn-primary" 
        formType="submit"
        disabled="{{!canSubmit || submitting}}"
        loading="{{submitting}}"
      >
        {{submitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜è®°å½•'}}
      </button>
    </view>
  </form>
</view>

<!-- é¹¦é¹‰é€‰æ‹©å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showParrotModal}}" bindtap="hideParrotPicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©é¹¦é¹‰</text>
      <view class="modal-close" bindtap="hideParrotPicker">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="parrot-list">
        <view 
          class="parrot-item" 
          wx:for="{{parrotList}}" 
          wx:key="id"
          bindtap="selectParrot"
          data-id="{{item.id}}"
          data-name="{{item.name}}"
        >
          <image 
            class="parrot-avatar" 
            src="{{item.photo_url || '/images/default-parrot.png'}}" 
            mode="aspectFill"
          />
          <view class="parrot-info">
            <text class="parrot-name">{{item.name}}</text>
            <text class="parrot-species">{{item.species_name}}</text>
          </view>
          <view class="status-badge status-{{item.health_status}}">
            {{item.health_status === 'healthy' ? 'å¥åº·' : item.health_status === 'sick' ? 'ç”Ÿç—…' : item.health_status === 'recovering' ? 'åº·å¤ä¸­' : 'è§‚å¯Ÿä¸­'}}
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å¥åº·çŠ¶æ€é€‰æ‹©å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showHealthStatusModal}}" bindtap="hideHealthStatusPicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å¥åº·çŠ¶æ€</text>
      <view class="modal-close" bindtap="hideHealthStatusPicker">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="status-list">
        <view 
          class="status-item" 
          bindtap="selectHealthStatus"
          data-status="healthy"
        >
          <view class="status-indicator healthy"></view>
          <text class="status-text">å¥åº·</text>
        </view>
        <view 
          class="status-item" 
          bindtap="selectHealthStatus"
          data-status="sick"
        >
          <view class="status-indicator sick"></view>
          <text class="status-text">ç”Ÿç—…</text>
        </view>
        <view 
          class="status-item" 
          bindtap="selectHealthStatus"
          data-status="recovering"
        >
          <view class="status-indicator recovering"></view>
          <text class="status-text">åº·å¤ä¸­</text>
        </view>
        <view 
          class="status-item" 
          bindtap="selectHealthStatus"
          data-status="observation"
        >
          <view class="status-indicator observation"></view>
          <text class="status-text">è§‚å¯Ÿä¸­</text>
        </view>
      </view>
    </view>
  </view>
</view>