<!--pages/records/add-record/add-record.wxml-->
<view class="page-container">
  <!-- 使用项目通用顶部导航组件 -->
  <app-header title="{{(recordId ? '编辑' : '添加') + (recordType === 'feeding' ? '喂食' : recordType === 'cleaning' ? '清洁' : recordType === 'health' ? '健康' : recordType === 'breeding' ? '繁殖' : '') + '记录'}}" subtitle="记录鹦鹉的日常护理" showBack="{{true}}" theme="blue">
  </app-header>

  <view class="form-content">
    <form bindsubmit="submitForm">
      <!-- 记录类型 -->
      <view class="form-section">
        <view class="section-title">记录类型</view>
        
        <view class="type-selector">
          <view 
            class="type-item feeding {{recordType === 'feeding' ? 'active' : ''}}"
            bindtap="selectType"
            data-type="feeding"
          >
            <image class="type-icon-img" src="/images/remix/ri-restaurant-fill-orange.png" mode="aspectFit"></image>
            <text class="type-text">喂食记录</text>
          </view>
          <view 
            class="type-item cleaning {{recordType === 'cleaning' ? 'active' : ''}}"
            bindtap="selectType"
            data-type="cleaning"
          >
            <image class="type-icon-img" src="/images/remix/ri-calendar-fill-blue.png" mode="aspectFit"></image>
            <text class="type-text">清洁记录</text>
          </view>
          <view 
            class="type-item health {{recordType === 'health' ? 'active' : ''}}"
            bindtap="selectType"
            data-type="health"
          >
            <image class="type-icon-img" src="/images/remix/ri-heart-fill-purple.png" mode="aspectFit"></image>
            <text class="type-text">健康检查</text>
          </view>
          <view 
            class="type-item breeding {{recordType === 'breeding' ? 'active' : ''}}"
            bindtap="selectType"
            data-type="breeding"
          >
            <image class="type-icon-img" src="/images/remix/ri-book-fill-green.png" mode="aspectFit"></image>
            <text class="type-text">繁殖记录</text>
          </view>
        </view>
      </view>

      <!-- 基本信息 -->
      <view class="form-section">
        <view class="section-title">基本信息</view>
        
        <view class="form-item">
          <text class="form-label required">选择鹦鹉</text>
          <view class="form-picker" bindtap="showParrotPicker">
            <text class="picker-text {{formData.parrot_ids.length > 0 ? '' : 'placeholder'}}">
              {{selectedParrotNames || (recordType === 'health' ? '请选择鹦鹉（单选）' : '请选择鹦鹉（可多选）')}}
            </text>
            <image class="picker-arrow-img" src="/images/remix/ri-arrow-down-s-fill-gray.png" mode="aspectFit"></image>
          </view>
        </view>
        
        <view class="form-item">
          <text class="form-label required">记录时间</text>
          <view class="datetime-picker">
            <picker 
              mode="date" 
              value="{{formData.record_date}}" 
              bindchange="onDateChange"
              end="{{today}}"
            >
              <view class="picker-item">
                <text class="picker-text {{formData.record_date ? '' : 'placeholder'}}">
                  {{formData.record_date || '选择日期'}}
                </text>
              </view>
            </picker>
            <picker 
              mode="time" 
              value="{{formData.record_time}}" 
              bindchange="onTimeChange"
            >
              <view class="picker-item">
                <text class="picker-text {{formData.record_time ? '' : 'placeholder'}}">
                  {{formData.record_time || '选择时间'}}
                </text>
                <image class="picker-arrow-img" src="/images/remix/ri-arrow-down-s-fill-gray.png" mode="aspectFit"></image>
              </view>
            </picker>
          </view>
        </view>
      </view>

      <!-- 喂食记录特有字段 -->
      <view class="form-section" wx:if="{{recordType === 'feeding'}}">
        <view class="section-title">喂食详情</view>
        
        <view class="form-item">
          <text class="form-label">食物类型</text>
          <view class="form-picker" bindtap="showFeedTypePicker">
            <text class="picker-text {{formData.food_types.length > 0 ? '' : 'placeholder'}}">
              {{selectedFeedTypeNames || '选择食物类型（可多选）'}}
          </text>
          <image class="picker-arrow-img" src="/images/remix/ri-arrow-down-s-fill-gray.png" mode="aspectFit"></image>
        </view>
      </view>
      
      <!-- 当选择 0 或 1 个食物类型时，使用单个食物量输入 -->
      <view class="form-item" wx:if="{{formData.food_types.length <= 1}}">
        <text class="form-label">食物量 (g)</text>
        <input 
          class="form-input" 
          placeholder="请输入食物重量" 
          value="{{formData.amount}}"
          bindinput="onInputChange"
          data-field="amount"
          type="digit"
        />
      </view>

      <!-- 当选择多个食物类型时，分别展示每个类型的食物量输入 -->
      <view class="form-item" wx:if="{{formData.food_types.length > 1}}">
        <text class="form-label">各食物类型的食物量 (g)</text>
        <block wx:for="{{selectedFeedTypes}}" wx:key="id">
          <view class="form-item">
            <text class="form-label">{{item.name}}</text>
            <input 
              class="form-input" 
              placeholder="请输入{{item.name}}的重量" 
              value="{{formData.food_amounts && formData.food_amounts[item.id] || ''}}"
              data-id="{{item.id}}"
              bindinput="onFoodAmountInput"
              type="digit"
            />
          </view>
        </block>
      </view>
    </view>

    <!-- 清洁记录特有字段 -->
    <view class="form-section" wx:if="{{recordType === 'cleaning'}}">
      <view class="section-title">清洁详情</view>
      
      <view class="form-item">
        <text class="form-label required">清洁类型</text>
        <view class="form-picker" bindtap="showCleaningTypePicker">
          <text class="picker-text {{selectedCleaningTypeNames ? '' : 'placeholder'}}">
            {{selectedCleaningTypeNames || '请选择清洁类型'}}
          </text>
          <image class="picker-arrow-img" src="/images/remix/ri-arrow-down-s-fill-gray.png" mode="aspectFit"></image>
        </view>
      </view>
      
      <view class="form-item">
        <text class="form-label">清洁描述</text>
        <textarea 
          class="form-textarea" 
          placeholder="请输入清洁的详细描述" 
          value="{{formData.description}}"
          bindinput="onInputChange"
          data-field="description"
          maxlength="500"
        />
      </view>
    </view>

    <!-- 健康检查特有字段 -->
    <view class="form-section" wx:if="{{recordType === 'health'}}">
      <view class="section-title">健康详情</view>
      
      <view class="form-item">
        <text class="form-label">体重 (g)</text>
        <input 
          class="form-input" 
          placeholder="请输入当前体重" 
          value="{{formData.weight}}"
          bindinput="onInputChange"
          data-field="weight"
          type="digit"
        />
      </view>
      

      
      <view class="form-item">
        <text class="form-label">健康状态</text>
        <view class="form-picker" bindtap="showHealthStatusPicker">
          <text class="picker-text {{formData.health_status ? '' : 'placeholder'}}">
            {{healthStatusText || '请选择健康状态'}}
          </text>
          <image class="picker-arrow-img" src="/images/remix/ri-arrow-down-s-fill-gray.png" mode="aspectFit"></image>
        </view>
      </view>
    </view>

    <!-- 繁殖记录特有字段 -->
    <view class="form-section" wx:if="{{recordType === 'breeding'}}">
      <view class="section-title">繁殖详情</view>
      
      <view class="form-item">
        <text class="form-label required">雄性鹦鹉</text>
        <view class="form-picker" bindtap="showMaleParrotPicker">
          <text class="picker-text {{formData.male_parrot_id ? '' : 'placeholder'}}">
            {{selectedMaleParrotName || '请选择雄性鹦鹉'}}
          </text>
          <text class="picker-arrow">▼</text>
        </view>
      </view>
      
      <view class="form-item">
        <text class="form-label required">雌性鹦鹉</text>
        <view class="form-picker" bindtap="showFemaleParrotPicker">
          <text class="picker-text {{formData.female_parrot_id ? '' : 'placeholder'}}">
            {{selectedFemaleParrotName || '请选择雌性鹦鹉'}}
          </text>
          <text class="picker-arrow">▼</text>
        </view>
      </view>
      
      <view class="form-item">
        <text class="form-label required">交配日期</text>
        <picker 
          mode="date" 
          value="{{formData.mating_date}}" 
          bindchange="onMatingDateChange"
          end="{{today}}"
        >
          <view class="picker-item">
            <text class="picker-text {{formData.mating_date ? '' : 'placeholder'}}">
              {{formData.mating_date || '选择交配日期'}}
            </text>
          </view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">产蛋日期</text>
        <picker 
          mode="date" 
          value="{{formData.egg_laying_date}}" 
          bindchange="onEggLayingDateChange"
          end="{{today}}"
        >
          <view class="picker-item">
            <text class="picker-text {{formData.egg_laying_date ? '' : 'placeholder'}}">
              {{formData.egg_laying_date || '选择产蛋日期'}}
            </text>
          </view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">蛋数量</text>
        <input 
          class="form-input" 
          placeholder="请输入蛋的数量" 
          value="{{formData.egg_count}}"
          bindinput="onInputChange"
          data-field="egg_count"
          type="number"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">孵化日期</text>
        <picker 
          mode="date" 
          value="{{formData.hatching_date}}" 
          bindchange="onHatchingDateChange"
          end="{{today}}"
        >
          <view class="picker-item">
            <text class="picker-text {{formData.hatching_date ? '' : 'placeholder'}}">
              {{formData.hatching_date || '选择孵化日期'}}
            </text>
          </view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">幼鸟数量</text>
        <input 
          class="form-input" 
          placeholder="请输入成功孵化的幼鸟数量" 
          value="{{formData.chick_count}}"
          bindinput="onInputChange"
          data-field="chick_count"
          type="number"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">成功率 (%)</text>
        <input 
          class="form-input" 
          placeholder="请输入繁殖成功率" 
          value="{{formData.success_rate}}"
          bindinput="onInputChange"
          data-field="success_rate"
          type="digit"
        />
      </view>
    </view>

    <!-- 照片上传 -->
    <view class="form-section">
      <view class="section-title">记录照片 (可选)</view>
      
      <view class="photo-upload">
        <view class="photo-list" wx:if="{{formData.photos.length > 0}}">
          <view 
            class="photo-item" 
            wx:for="{{formData.photos}}" 
            wx:key="*this"
          >
            <image 
              class="photo-image" 
              src="{{item}}" 
              mode="aspectFill"
              bindtap="previewPhoto"
              data-url="{{item}}"
            />
            <view 
              class="photo-delete" 
              bindtap="deletePhoto"
              data-index="{{index}}"
            >
              <image class="photo-delete-icon" src="/images/remix/delete-bin-line-gray.png" mode="aspectFit"></image>
            </view>
          </view>
          
          <view 
            class="add-photo-btn" 
            wx:if="{{formData.photos.length < 3}}"
            bindtap="choosePhoto"
          >
            <image class="add-photo-icon" src="/images/remix/ri-add-fill-emerald.png" mode="aspectFit"></image>
          </view>
        </view>
        
        <view class="upload-area" wx:else bindtap="choosePhoto">
          <image class="upload-icon-img" src="/images/remix/ri-camera-line-gray.png" mode="aspectFit"></image>
          <text class="upload-text">添加照片</text>
          <text class="upload-tip">最多可添加3张照片</text>
        </view>
      </view>
    </view>

    <!-- 备注信息 -->
    <view class="form-section">
      <view class="section-title">备注信息</view>
      
      <view class="form-item">
        <text class="form-label">备注</text>
        <textarea 
          class="form-textarea" 
          placeholder="请输入备注信息（可选）" 
          value="{{formData.notes}}"
          bindinput="onInputChange"
          data-field="notes"
          maxlength="500"
          show-confirm-bar="{{false}}"
        />
        <view class="char-count">{{formData.notes.length}}/500</view>
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="form-actions">
      <button class="btn btn-secondary" bindtap="goBack">取消</button>
      <button 
        class="btn btn-primary" 
        formType="submit"
        disabled="{{!canSubmit || submitting}}"
        loading="{{submitting}}"
      >
        {{submitting ? '保存中...' : '保存记录'}}
      </button>
    </view>
  </form>
</view>

<!-- 鹦鹉选择弹窗 -->
<view class="modal-overlay" wx:if="{{showParrotModal}}" bindtap="hideParrotPicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择鹦鹉</text>
      <view class="modal-close" bindtap="hideParrotPicker">×</view>
    </view>
    <view class="modal-body">
      <!-- 健康记录：单选 -->
      <radio-group wx:if="{{recordType === 'health'}}" bindchange="onParrotRadioChange">
        <label class="parrot-item {{item.selected ? 'selected' : ''}}" wx:for="{{parrotList}}" wx:key="id">
          <view class="parrot-left">
            <view class="parrot-avatar">
              <image class="parrot-image" src="{{item.photo_url || item.avatar_url || '/images/default-parrot.png'}}" mode="aspectFill" />
            </view>
            <view class="parrot-info">
              <view class="name-section">
                <text class="parrot-name">{{item.name}}</text>
                <text class="parrot-gender {{item.gender}}">{{item.gender === 'male' ? '♂' : item.gender === 'female' ? '♀' : '？'}}</text>
              </view>
              <text class="parrot-species">{{item.species_name}}</text>
            </view>
            <view class="status-pills">
              <view class="status-pill pill-{{item.current_health_status || 'healthy'}}">
                <text class="pill-icon">{{(item.current_health_status || 'healthy') === 'healthy' ? '✓' : (item.current_health_status || 'healthy') === 'sick' ? '!' : (item.current_health_status || 'healthy') === 'recovering' ? '↗' : '👁'}}</text>
                <text class="pill-text">{{(item.current_health_status || 'healthy') === 'healthy' ? '健康' : (item.current_health_status || 'healthy') === 'sick' ? '生病' : (item.current_health_status || 'healthy') === 'recovering' ? '康复中' : '观察中'}}</text>
              </view>
            </view>
          </view>
          <view class="parrot-right">
            <radio class="parrot-radio" value="{{item.id}}" checked="{{item.selected}}" />
            <image class="check-icon-img" wx:if="{{item.selected}}" src="{{checkIconSrc}}" mode="aspectFit" />
          </view>
        </label>
      </radio-group>

      <!-- 其他记录类型：多选 -->
      <checkbox-group wx:else bindchange="onParrotChange">
        <label class="parrot-item {{item.selected ? 'selected' : ''}}" wx:for="{{parrotList}}" wx:key="id">
          <view class="parrot-left">
            <view class="parrot-avatar">
              <image class="parrot-image" src="{{item.photo_url || item.avatar_url || '/images/default-parrot.png'}}" mode="aspectFill" />
            </view>
            <view class="parrot-info">
              <view class="name-section">
                <text class="parrot-name">{{item.name}}</text>
                <text class="parrot-gender {{item.gender}}">{{item.gender === 'male' ? '♂' : item.gender === 'female' ? '♀' : '？'}}</text>
              </view>
              <text class="parrot-species">{{item.species_name}}</text>
            </view>
            <view class="status-pills">
              <view class="status-pill pill-{{item.current_health_status || 'healthy'}}">
                <text class="pill-icon">{{(item.current_health_status || 'healthy') === 'healthy' ? '✓' : (item.current_health_status || 'healthy') === 'sick' ? '!' : (item.current_health_status || 'healthy') === 'recovering' ? '↗' : '👁'}}</text>
                <text class="pill-text">{{(item.current_health_status || 'healthy') === 'healthy' ? '健康' : (item.current_health_status || 'healthy') === 'sick' ? '生病' : (item.current_health_status || 'healthy') === 'recovering' ? '康复中' : '观察中'}}</text>
              </view>
            </view>
          </view>
          <view class="parrot-right">
            <checkbox class="parrot-checkbox" value="{{item.id}}" checked="{{item.selected}}" />
            <image class="check-icon-img" wx:if="{{item.selected}}" src="{{checkIconSrc}}" mode="aspectFit" />
          </view>
        </label>
      </checkbox-group>
    </view>
    <view class="modal-footer" wx:if="{{recordType !== 'health'}}">
      <button class="confirm-btn" bindtap="confirmParrotSelection">确定</button>
    </view>
  </view>
</view>

<!-- 清洁类型选择器模态框 -->
<view class="modal-overlay" wx:if="{{showCleaningTypeModal}}" bindtap="hideCleaningTypePicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择清洁类型</text>
      <text class="modal-close" bindtap="hideCleaningTypePicker">×</text>
    </view>
    <view class="modal-body">
      <checkbox-group bindchange="onCleaningTypeChange">
        <label class="cleaning-type-item" wx:for="{{cleaningTypeList}}" wx:key="id">
          <text class="cleaning-type-name">{{item.name}}</text>
          <checkbox class="cleaning-checkbox" value="{{item.id}}" checked="{{item.selected}}" />
          <image class="check-icon-img" wx:if="{{item.selected}}" src="{{checkIconSrc}}" mode="aspectFit" />
        </label>
      </checkbox-group>
    </view>
    <view class="modal-footer">
      <button class="confirm-btn" bindtap="confirmCleaningTypeSelection">确定</button>
    </view>
  </view>
</view>

<!-- 食物类型选择器模态框 -->
<view class="modal-overlay" wx:if="{{showFeedTypeModal}}" bindtap="hideFeedTypePicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择食物类型</text>
      <text class="modal-close" bindtap="hideFeedTypePicker">×</text>
    </view>
    <view class="modal-body">
      <view 
        class="feed-type-item {{item.selected ? 'selected' : ''}}" 
        wx:for="{{feedTypeList}}" 
        wx:key="id"
        bindtap="selectFeedType"
        data-id="{{item.id}}"
        data-name="{{item.displayName || item.name}}"
      >
        <view class="feed-type-info">
          <text class="feed-type-name">{{item.displayName || item.name}}</text>
          <view class="feed-type-details">
            <text class="feed-type-brand">{{item.brand}}</text>
            <text class="feed-type-type">{{item.typeText}}</text>
          </view>
        </view>
        <view class="selection-indicator" wx:if="{{item.selected}}">✓</view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="confirm-btn" bindtap="confirmFeedTypeSelection">确定</button>
    </view>
  </view>
</view>

<!-- 健康状态选择弹窗 -->
<view class="modal-overlay" wx:if="{{showHealthStatusModal}}" bindtap="hideHealthStatusPicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择健康状态</text>
      <view class="modal-close" bindtap="hideHealthStatusPicker">×</view>
    </view>
    <view class="modal-body">
      <radio-group bindchange="onHealthStatusChange">
        <label class="status-item">
          <view class="status-left">
            <view class="status-indicator healthy"></view>
            <text class="status-text">健康</text>
          </view>
          <radio class="status-radio" value="healthy" checked="{{formData.health_status === 'healthy'}}" />
        </label>
        <label class="status-item">
          <view class="status-left">
            <view class="status-indicator sick"></view>
            <text class="status-text">生病</text>
          </view>
          <radio class="status-radio" value="sick" checked="{{formData.health_status === 'sick'}}" />
        </label>
        <label class="status-item">
          <view class="status-left">
            <view class="status-indicator recovering"></view>
            <text class="status-text">康复中</text>
          </view>
          <radio class="status-radio" value="recovering" checked="{{formData.health_status === 'recovering'}}" />
        </label>
        <label class="status-item">
          <view class="status-left">
            <view class="status-indicator observation"></view>
            <text class="status-text">观察中</text>
          </view>
          <radio class="status-radio" value="observation" checked="{{formData.health_status === 'observation'}}" />
        </label>
      </radio-group>
    </view>
  </view>
</view>

<!-- 雄性鹦鹉选择弹窗 -->
<view class="modal-overlay" wx:if="{{showMaleParrotModal}}" bindtap="hideMaleParrotPicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择雄性鹦鹉</text>
      <text class="modal-close" bindtap="hideMaleParrotPicker">×</text>
    </view>
    <view class="modal-body">
      <view class="parrot-list">
        <view 
          class="parrot-item" 
          wx:for="{{maleParrotList}}" 
          wx:key="id"
          data-id="{{item.id}}"
          data-name="{{item.name}}"
          bindtap="selectMaleParrot"
        >
          <view class="parrot-avatar">
            <image class="parrot-image" src="{{item.photo_url || item.avatar_url || '/images/default-parrot.png'}}" />
          </view>
          <view class="parrot-info">
            <view class="name-section">
              <text class="parrot-name">{{item.name}}</text>
              <text class="parrot-gender {{item.gender}}">{{item.gender === 'male' ? '♂' : item.gender === 'female' ? '♀' : '？'}}</text>
            </view>
            <text class="parrot-species">{{item.species_name}}</text>
          </view>
          <view class="status-pills">
            <view class="status-pill pill-{{item.current_health_status || 'healthy'}}">
              <text class="pill-icon">{{(item.current_health_status || 'healthy') === 'healthy' ? '✓' : (item.current_health_status || 'healthy') === 'sick' ? '!' : (item.current_health_status || 'healthy') === 'recovering' ? '↗' : '👁'}}</text>
              <text class="pill-text">{{(item.current_health_status || 'healthy') === 'healthy' ? '健康' : (item.current_health_status || 'healthy') === 'sick' ? '生病' : (item.current_health_status || 'healthy') === 'recovering' ? '康复中' : '观察中'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
</view>

<!-- 雌性鹦鹉选择弹窗 -->
<view class="modal-overlay" wx:if="{{showFemaleParrotModal}}" bindtap="hideFemaleParrotPicker">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择雌性鹦鹉</text>
      <text class="modal-close" bindtap="hideFemaleParrotPicker">×</text>
    </view>
    <view class="modal-body">
      <view class="parrot-list">
        <view 
          class="parrot-item" 
          wx:for="{{femaleParrotList}}" 
          wx:key="id"
          data-id="{{item.id}}"
          data-name="{{item.name}}"
          bindtap="selectFemaleParrot"
        >
          <view class="parrot-avatar">
            <image class="parrot-image" src="{{item.photo_url || item.avatar_url || '/images/default-parrot.png'}}" />
          </view>
          <view class="parrot-info">
            <view class="name-section">
              <text class="parrot-name">{{item.name}}</text>
              <text class="parrot-gender {{item.gender}}">{{item.gender === 'male' ? '♂' : item.gender === 'female' ? '♀' : '？'}}</text>
            </view>
            <text class="parrot-species">{{item.species_name}}</text>
          </view>
          <view class="status-pills">
            <view class="status-pill pill-{{item.current_health_status || 'healthy'}}">
              <text class="pill-icon">{{(item.current_health_status || 'healthy') === 'healthy' ? '✓' : (item.current_health_status || 'healthy') === 'sick' ? '!' : (item.current_health_status || 'healthy') === 'recovering' ? '↗' : '👁'}}</text>
              <text class="pill-text">{{(item.current_health_status || 'healthy') === 'healthy' ? '健康' : (item.current_health_status || 'healthy') === 'sick' ? '生病' : (item.current_health_status || 'healthy') === 'recovering' ? '康复中' : '观察中'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
