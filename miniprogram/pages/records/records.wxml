<!--pages/records/records.wxml-->
<view class="page-container">
  <app-header title="å…»æ®–è®°å½•" subtitle="ä¸“ä¸šé¹¦é¹‰æŠ¤ç†åŠ©æ‰‹">
    <view slot="actions" wx:if="{{isLogin && hasOperationPermission}}" class="header-btn" bindtap="addRecord">
      <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" />
    </view>
  </app-header>
  <view class="page-content">
    <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
    <view wx:if="{{!isLogin}}" class="guest-tip">
      <text class="tip-text">ğŸ“ è®°å½•åŠŸèƒ½éœ€è¦ç™»å½•ä½¿ç”¨</text>
      <text class="tip-subtitle">ç™»å½•åå¯ä»¥è®°å½•å’ŒæŸ¥çœ‹æ‚¨çš„é¹¦é¹‰æŠ¤ç†è®°å½•</text>
    </view>

  <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'feeding' ? 'active' : ''}}" bindtap="switchTab" data-tab="feeding">
      <text class="tab-text">å–‚é£Ÿè®°å½•</text>
    </view>
    <view class="tab-item {{activeTab === 'health' ? 'active' : ''}}" bindtap="switchTab" data-tab="health">
      <text class="tab-text">å¥åº·è®°å½•</text>
    </view>
    <view class="tab-item {{activeTab === 'cleaning' ? 'active' : ''}}" bindtap="switchTab" data-tab="cleaning">
      <text class="tab-text">æ¸…æ´è®°å½•</text>
    </view>
    <view class="tab-item {{activeTab === 'breeding' ? 'active' : ''}}" bindtap="switchTab" data-tab="breeding">
      <text class="tab-text">ç¹æ®–è®°å½•</text>
    </view>
  </view>

  <!-- ç­›é€‰æ  -->
  <view wx:if="{{isLogin}}" class="filter-section">
    <view class="filter-bar">
      <view class="filter-item" bindtap="showParrotFilter">
        <text class="filter-text">{{selectedParrot ? selectedParrot : 'å…¨éƒ¨é¹¦é¹‰'}}</text>
        <text class="filter-arrow">â–¼</text>
      </view>
      <view class="filter-item" bindtap="showDateFilter">
        <text class="filter-text">{{dateFilterText || 'å…¨éƒ¨æ—¶é—´'}}</text>
        <text class="filter-arrow">â–¼</text>
      </view>
    </view>
  </view>

  <!-- å–‚é£Ÿè®°å½• -->
  <view class="records-container" wx:if="{{activeTab === 'feeding'}}">
    <view class="record-list" wx:if="{{feedingRecords.length > 0}}">
      <view class="record-card" wx:for="{{feedingRecords}}" wx:key="id">
        <view class="record-header">
          <view class="record-info">
            <text class="record-title">{{item.parrot_name}}</text>
            <text class="record-time">{{item.feeding_time_formatted}}</text>
            <!-- å›¢é˜Ÿæ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ›å»ºè€… -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">è®°å½•è€…ï¼š{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="feeding" data-id="{{item.id}}" data-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}" data-feed-type-ids="{{item.feed_type_ids}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/edit-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="feeding" data-id="{{item.id}}" data-ids="{{item.record_ids}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/delete-bin-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
          </view>
        </view>
        
        <view class="record-content">
          <view class="record-detail">
            <text class="detail-label">é£Ÿç‰©ç±»å‹ï¼š</text>
            <text class="detail-value">{{item.feed_type_names_text || item.feed_type_name || 'æœªæŒ‡å®š'}}</text>
          </view>
          <view class="record-detail">
            <text class="detail-label">æ•°é‡ï¼š</text>
            <text class="detail-value">{{item.amount}}{{item.unit}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">å¤‡æ³¨ï¼š</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:if="{{feedingRecords.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ</view>
      <view class="empty-text" wx:if="{{isLogin}}">æš‚æ— å–‚é£Ÿè®°å½•</view>
      <view class="empty-text" wx:else>è¯·å…ˆç™»å½•æŸ¥çœ‹è®°å½•</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addFeedingRecord">æ·»åŠ å–‚é£Ÿè®°å½•</button>
    </view>
  </view>

  <!-- å¥åº·è®°å½• -->
  <view class="records-container" wx:if="{{activeTab === 'health'}}">
    <view class="record-list" wx:if="{{healthRecords.length > 0}}">
      <view class="record-card" wx:for="{{healthRecords}}" wx:key="id">
        <view class="record-header">
          <view class="avatar-cell">
            <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
              <view class="avatar-cluster">
                <block wx:for="{{item.parrot_avatars}}" wx:for-index="idx" wx:for-item="avatar" wx:key="*this">
                  <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                    <image src="{{avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" />
                  </view>
                </block>
              </view>
            </block>
            <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
              <view class="single-avatar">
                <image src="{{item.parrot_avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" />
              </view>
            </block>
            <block wx:else>
              <view class="single-avatar">
                <image src="/images/default-parrot.png" class="cluster-img" mode="aspectFill" />
              </view>
            </block>
          </view>
          <view class="record-info">
            <text class="record-title">{{item.parrot_name}}</text>
            <text class="record-time">{{item.record_date_formatted}}</text>
            <!-- å›¢é˜Ÿæ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ›å»ºè€… -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">è®°å½•è€…ï¼š{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="health" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/edit-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="health" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/delete-bin-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
          </view>
        </view>
        
        <view class="record-content">
          <view class="record-detail">
            <text class="detail-label">å¥åº·çŠ¶æ€ï¼š</text>
            <text class="detail-value">{{item.health_status_text || item.health_status}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.weight}}">
            <text class="detail-label">ä½“é‡ï¼š</text>
            <text class="detail-value">{{item.weight}} g</text>
          </view>
          
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">å¤‡æ³¨ï¼š</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>

    <view class="empty-state" wx:if="{{healthRecords.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ¥</view>
      <view class="empty-text" wx:if="{{isLogin}}">æš‚æ— å¥åº·è®°å½•</view>
      <view class="empty-text" wx:else>è¯·å…ˆç™»å½•æŸ¥çœ‹è®°å½•</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addHealthRecord">æ·»åŠ å¥åº·è®°å½•</button>
    </view>
  </view>

  <!-- æ¸…æ´è®°å½• -->
  <view class="records-container" wx:if="{{activeTab === 'cleaning'}}">
    <view class="record-list" wx:if="{{cleaningRecords.length > 0}}">
      <view class="record-card" wx:for="{{cleaningRecords}}" wx:key="id">
        <view class="record-header">
          <view class="avatar-cell">
            <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
              <view class="avatar-cluster">
                <block wx:for="{{item.parrot_avatars}}" wx:for-index="idx" wx:for-item="avatar" wx:key="*this">
                  <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                    <image src="{{avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" />
                  </view>
                </block>
              </view>
            </block>
            <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
              <view class="single-avatar">
                <image src="{{item.parrot_avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" />
              </view>
            </block>
            <block wx:else>
              <view class="single-avatar">
                <image src="/images/default-parrot.png" class="cluster-img" mode="aspectFill" />
              </view>
            </block>
          </view>
          <view class="record-info">
            <text class="record-title">{{item.parrot_name}}</text>
            <text class="record-time">{{item.cleaning_time_formatted}}</text>
            <!-- å›¢é˜Ÿæ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ›å»ºè€… -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">è®°å½•è€…ï¼š{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="cleaning" data-id="{{item.id}}" data-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}" data-cleaning-type-ids="{{item.cleaning_type_ids}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/edit-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="cleaning" data-id="{{item.id}}" data-ids="{{item.record_ids}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/delete-bin-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
          </view>
        </view>
        
        <view class="record-content">
          <view class="record-detail">
            <text class="detail-label">æ¸…æ´ç±»å‹ï¼š</text>
            <text class="detail-value">{{item.cleaning_type_text || item.cleaning_type}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.description}}">
            <text class="detail-label">æè¿°ï¼š</text>
            <text class="detail-value">{{item.description}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">å¤‡æ³¨ï¼š</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:if="{{cleaningRecords.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ§¹</view>
      <view class="empty-text" wx:if="{{isLogin}}">æš‚æ— æ¸…æ´è®°å½•</view>
      <view class="empty-text" wx:else>è¯·å…ˆç™»å½•æŸ¥çœ‹è®°å½•</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addCleaningRecord">æ·»åŠ æ¸…æ´è®°å½•</button>
    </view>
  </view>

  <!-- ç¹æ®–è®°å½• -->
  <view class="records-container" wx:if="{{activeTab === 'breeding'}}">
    <view class="record-list" wx:if="{{breedingRecords.length > 0}}">
      <view class="record-card" wx:for="{{breedingRecords}}" wx:key="id">
        <view class="record-header">
          <view class="avatar-cell">
            <block wx:if="{{item.parrot_avatars && item.parrot_avatars.length > 1}}">
              <view class="avatar-cluster">
                <block wx:for="{{item.parrot_avatars}}" wx:for-index="idx" wx:for-item="avatar" wx:key="*this">
                  <view wx:if="{{idx < 3}}" class="cluster-item pos-{{idx}} count-{{item.parrot_avatars.length >= 3 ? 3 : item.parrot_avatars.length}}">
                    <image src="{{avatar || '/images/default-parrot.png'}}" class="cluster-img" mode="aspectFill" />
                  </view>
                </block>
              </view>
            </block>
            <block wx:elif="{{item.parrot_avatars && item.parrot_avatars.length === 1}}">
              <view class="single-avatar">
                <image src="{{item.parrot_avatar || '/images/default-parrot.png'}}" class="w-full h-full object-cover" mode="aspectFill" />
              </view>
            </block>
            <block wx:else>
              <view class="single-avatar">
                <image src="/images/default-parrot.png" class="w-full h-full object-cover" mode="aspectFill" />
              </view>
            </block>
          </view>
          <view class="record-info">
            <text class="record-title">{{item.male_parrot_name}} Ã— {{item.female_parrot_name}}</text>
            <text class="record-time">{{item.mating_date_formatted}}</text>
            <!-- å›¢é˜Ÿæ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ›å»ºè€… -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">è®°å½•è€…ï¼š{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="breeding" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/edit-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="breeding" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <image src="/images/remix/delete-bin-line-gray.png" class="action-icon-img" mode="aspectFit" />
            </view>
          </view>
        </view>
      
        <view class="record-content">
          <view class="record-detail" wx:if="{{item.mating_date}}">
            <text class="detail-label">äº¤é…æ—¥æœŸï¼š</text>
            <text class="detail-value">{{item.mating_date_formatted}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.egg_laying_date}}">
            <text class="detail-label">äº§è›‹æ—¥æœŸï¼š</text>
            <text class="detail-value">{{item.egg_laying_date_formatted}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.hatching_date}}">
            <text class="detail-label">å­µåŒ–æ—¥æœŸï¼š</text>
            <text class="detail-value">{{item.hatching_date_formatted}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.egg_count}}">
            <text class="detail-label">äº§è›‹æ•°é‡ï¼š</text>
            <text class="detail-value">{{item.egg_count}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.chick_count}}">
            <text class="detail-label">è‚²é›æ•°é‡ï¼š</text>
            <text class="detail-value">{{item.chick_count}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.success_rate}}">
            <text class="detail-label">æˆåŠŸç‡ï¼š</text>
            <text class="detail-value">{{item.success_rate}}%</text>
          </view>
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">å¤‡æ³¨ï¼š</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  
    <view class="empty-state" wx:if="{{breedingRecords.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ¥š</view>
      <view class="empty-text" wx:if="{{isLogin}}">æš‚æ— ç¹æ®–è®°å½•</view>
      <view class="empty-text" wx:else>è¯·å…ˆç™»å½•æŸ¥çœ‹è®°å½•</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addBreedingRecord">æ·»åŠ ç¹æ®–è®°å½•</button>
    </view>
  </view>
</view>

<!-- é¹¦é¹‰ç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showParrotModal}}" bindtap="hideParrotFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©é¹¦é¹‰</text>
      <view class="modal-close" bindtap="hideParrotFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectParrot" data-parrot="">
        <text class="option-text">å…¨éƒ¨é¹¦é¹‰</text>
      </view>
      <view class="filter-option" wx:for="{{parrotsList}}" wx:key="id" bindtap="selectParrot" data-parrot="{{item.name}}" data-id="{{item.id}}">
        <text class="option-text">{{item.name}}</text>
      </view>
    </view>
  </view>
</view>

<!-- é¹¦é¹‰ç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showParrotModal}}" bindtap="hideParrotFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©é¹¦é¹‰</text>
      <view class="modal-close" bindtap="hideParrotFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option {{selectedParrot === '' ? 'selected' : ''}}" bindtap="selectParrot" data-parrot="">
        <text class="option-text">å…¨éƒ¨é¹¦é¹‰</text>
        <text class="option-check" wx:if="{{selectedParrot === ''}}">âœ“</text>
      </view>
      <view class="filter-option {{selectedParrot === item.name ? 'selected' : ''}}" wx:for="{{parrots}}" wx:key="id" bindtap="selectParrot" data-parrot="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
        <text class="option-check" wx:if="{{selectedParrot === item.name}}">âœ“</text>
      </view>
    </view>
  </view>
</view>

<!-- æ·»åŠ è®°å½•æ¨¡æ€å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showAddRecordModal}}" bindtap="hideAddRecordModal">
  <view class="modal-content add-record-modal" catchtap="stopModalPropagation">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ {{modalRecordType === 'feeding' ? 'å–‚é£Ÿ' : modalRecordType === 'health' ? 'å¥åº·' : modalRecordType === 'cleaning' ? 'æ¸…æ´' : 'ç¹æ®–'}}è®°å½•</text>
      <view class="modal-close" bindtap="hideAddRecordModal">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="quick-add-options">
        <view class="quick-option" bindtap="quickAddRecord">
          <view class="option-icon">âš¡</view>
          <view class="option-content">
            <text class="option-title">å¿«é€Ÿè®°å½•</text>
            <text class="option-desc">ä½¿ç”¨é»˜è®¤è®¾ç½®å¿«é€Ÿæ·»åŠ è®°å½•</text>
          </view>
        </view>
        <view class="quick-option" bindtap="navigateToAddRecord">
          <view class="option-icon">ğŸ“</view>
          <view class="option-content">
            <text class="option-title">è¯¦ç»†è®°å½•</text>
            <text class="option-desc">å¡«å†™å®Œæ•´çš„è®°å½•ä¿¡æ¯</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- é¹¦é¹‰ç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showParrotModal}}" bindtap="hideParrotFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©é¹¦é¹‰</text>
      <view class="modal-close" bindtap="hideParrotFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option {{!selectedParrotId ? 'selected' : ''}}" bindtap="selectParrot" data-id="" data-name="">
        <text class="option-text">å…¨éƒ¨é¹¦é¹‰</text>
        <text class="option-check" wx:if="{{!selectedParrotId}}">âœ“</text>
      </view>
      <view class="filter-option {{selectedParrotId === item.id ? 'selected' : ''}}" wx:for="{{parrotsList}}" wx:key="id" bindtap="selectParrot" data-id="{{item.id}}" data-name="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
        <text class="option-check" wx:if="{{selectedParrotId === item.id}}">âœ“</text>
      </view>
    </view>
  </view>
</view>

<!-- æ—¥æœŸç­›é€‰å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showDateModal}}" bindtap="hideDateFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©æ—¶é—´èŒƒå›´</text>
      <view class="modal-close" bindtap="hideDateFilter">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="filter-option {{dateRange === 'all' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="all">
        <text class="option-text">å…¨éƒ¨æ—¶é—´</text>
        <text class="option-check" wx:if="{{dateRange === 'all'}}">âœ“</text>
      </view>
      <view class="filter-option {{dateRange === 'today' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="today">
        <text class="option-text">ä»Šå¤©</text>
        <text class="option-check" wx:if="{{dateRange === 'today'}}">âœ“</text>
      </view>
      <view class="filter-option {{dateRange === 'week' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="week">
        <text class="option-text">æœ€è¿‘ä¸€å‘¨</text>
        <text class="option-check" wx:if="{{dateRange === 'week'}}">âœ“</text>
      </view>
      <view class="filter-option {{dateRange === 'month' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="month">
        <text class="option-text">æœ€è¿‘ä¸€æœˆ</text>
        <text class="option-check" wx:if="{{dateRange === 'month'}}">âœ“</text>
      </view>
    </view>
  </view>
</view>
  </view>
