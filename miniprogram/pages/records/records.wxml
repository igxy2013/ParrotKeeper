<!--pages/records/records.wxml-->
<view class="page-container">
  <!-- 自定义页头 -->
  <view class="custom-header">
    <view class="header-content">
      <view class="header-left">
        <view class="header-icon"></view>
        <view class="header-title-section">
          <text class="header-title">鹦鹉管家</text>
          <text class="header-subtitle">专业鹦鹉护理助手</text>
        </view>
      </view>
      <view class="header-right" style="margin-right: {{menuRightPadding}}px;">
        <button class="header-btn notification"></button>
        <button class="header-btn more"></button>
      </view>
    </view>
  </view>

  <!-- 内容区域需要增加顶部间距 -->
  <view style="padding-top: 240rpx;">
    <!-- 游客模式提示 -->
    <view wx:if="{{!isLogin}}" class="guest-tip">
      <text class="tip-text">📝 记录功能需要登录使用</text>
      <text class="tip-subtitle">登录后可以记录和查看您的鹦鹉护理记录</text>
    </view>

  <!-- 标签页切换 -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'feeding' ? 'active' : ''}}" bindtap="switchTab" data-tab="feeding">
      <text class="tab-text">喂食记录</text>
    </view>
    <view class="tab-item {{activeTab === 'health' ? 'active' : ''}}" bindtap="switchTab" data-tab="health">
      <text class="tab-text">健康记录</text>
    </view>
    <view class="tab-item {{activeTab === 'cleaning' ? 'active' : ''}}" bindtap="switchTab" data-tab="cleaning">
      <text class="tab-text">清洁记录</text>
    </view>
    <view class="tab-item {{activeTab === 'breeding' ? 'active' : ''}}" bindtap="switchTab" data-tab="breeding">
      <text class="tab-text">繁殖记录</text>
    </view>
  </view>

  <!-- 筛选栏 -->
  <view wx:if="{{isLogin}}" class="filter-section">
    <view class="filter-bar">
      <view class="filter-item" bindtap="showParrotFilter">
        <text class="filter-text">{{selectedParrot ? selectedParrot : '全部鹦鹉'}}</text>
        <text class="filter-arrow">▼</text>
      </view>
      <view class="filter-item" bindtap="showDateFilter">
        <text class="filter-text">{{dateFilterText || '全部时间'}}</text>
        <text class="filter-arrow">▼</text>
      </view>
    </view>
  </view>

  <!-- 喂食记录 -->
  <view class="records-container" wx:if="{{activeTab === 'feeding'}}">
    <view class="record-list" wx:if="{{feedingRecords.length > 0}}">
      <view class="record-card" wx:for="{{feedingRecords}}" wx:key="id">
        <view class="record-header">
          <view class="record-info">
            <text class="record-title">{{item.parrot_name}}</text>
            <text class="record-time">{{item.feeding_time_formatted}}</text>
            <!-- 团队模式下显示创建者 -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">记录者：{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="feeding" data-id="{{item.id}}" data-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}" data-feed-type-ids="{{item.feed_type_ids}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">✏️</text>
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="feeding" data-id="{{item.id}}" data-ids="{{item.record_ids}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">🗑️</text>
            </view>
          </view>
        </view>
        
        <view class="record-content">
          <view class="record-detail">
            <text class="detail-label">食物类型：</text>
            <text class="detail-value">{{item.feed_type_names_text || item.feed_type_name || '未指定'}}</text>
          </view>
          <view class="record-detail">
            <text class="detail-label">数量：</text>
            <text class="detail-value">{{item.amount}}{{item.unit}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">备注：</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:if="{{feedingRecords.length === 0 && !loading}}">
      <view class="empty-icon">🍎</view>
      <view class="empty-text" wx:if="{{isLogin}}">暂无喂食记录</view>
      <view class="empty-text" wx:else>请先登录查看记录</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addFeedingRecord">添加喂食记录</button>
    </view>
  </view>

  <!-- 健康记录 -->
  <view class="records-container" wx:if="{{activeTab === 'health'}}">
    <view class="record-list" wx:if="{{healthRecords.length > 0}}">
      <view class="record-card" wx:for="{{healthRecords}}" wx:key="id">
        <view class="record-header">
          <view class="record-info">
            <text class="record-title">{{item.parrot_name}}</text>
            <text class="record-time">{{item.record_date_formatted}}</text>
            <!-- 团队模式下显示创建者 -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">记录者：{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="health" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">✏️</text>
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="health" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">🗑️</text>
            </view>
          </view>
        </view>
        
        <view class="record-content">
          <view class="record-detail">
            <text class="detail-label">健康状态：</text>
            <text class="detail-value">{{item.health_status_text || item.health_status}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.weight}}">
            <text class="detail-label">体重：</text>
            <text class="detail-value">{{item.weight}} g</text>
          </view>
          <view class="record-detail" wx:if="{{item.temperature}}">
            <text class="detail-label">体温：</text>
            <text class="detail-value">{{item.temperature}} °C</text>
          </view>
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">备注：</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>

    <view class="empty-state" wx:if="{{healthRecords.length === 0 && !loading}}">
      <view class="empty-icon">🏥</view>
      <view class="empty-text" wx:if="{{isLogin}}">暂无健康记录</view>
      <view class="empty-text" wx:else>请先登录查看记录</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addHealthRecord">添加健康记录</button>
    </view>
  </view>

  <!-- 清洁记录 -->
  <view class="records-container" wx:if="{{activeTab === 'cleaning'}}">
    <view class="record-list" wx:if="{{cleaningRecords.length > 0}}">
      <view class="record-card" wx:for="{{cleaningRecords}}" wx:key="id">
        <view class="record-header">
          <view class="record-info">
            <text class="record-title">{{item.parrot_name}}</text>
            <text class="record-time">{{item.cleaning_time_formatted}}</text>
            <!-- 团队模式下显示创建者 -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">记录者：{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="cleaning" data-id="{{item.id}}" data-ids="{{item.record_ids}}" data-parrot-ids="{{item.parrot_ids}}" data-cleaning-type-ids="{{item.cleaning_type_ids}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">✏️</text>
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="cleaning" data-id="{{item.id}}" data-ids="{{item.record_ids}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">🗑️</text>
            </view>
          </view>
        </view>
        
        <view class="record-content">
          <view class="record-detail">
            <text class="detail-label">清洁类型：</text>
            <text class="detail-value">{{item.cleaning_type_text || item.cleaning_type}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.description}}">
            <text class="detail-label">描述：</text>
            <text class="detail-value">{{item.description}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">备注：</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:if="{{cleaningRecords.length === 0 && !loading}}">
      <view class="empty-icon">🧹</view>
      <view class="empty-text" wx:if="{{isLogin}}">暂无清洁记录</view>
      <view class="empty-text" wx:else>请先登录查看记录</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addCleaningRecord">添加清洁记录</button>
    </view>
  </view>

  <!-- 繁殖记录 -->
  <view class="records-container" wx:if="{{activeTab === 'breeding'}}">
    <view class="record-list" wx:if="{{breedingRecords.length > 0}}">
      <view class="record-card" wx:for="{{breedingRecords}}" wx:key="id">
        <view class="record-header">
          <view class="record-info">
            <text class="record-title">{{item.male_parrot_name}} × {{item.female_parrot_name}}</text>
            <text class="record-time">{{item.mating_date_formatted}}</text>
            <!-- 团队模式下显示创建者 -->
            <text wx:if="{{isTeamMode && item.created_by_username}}" class="record-creator">记录者：{{item.created_by_username}}</text>
          </view>
          <view class="record-actions">
            <view class="action-btn" bindtap="editRecord" data-type="breeding" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">✏️</text>
            </view>
            <view class="action-btn" bindtap="deleteRecord" data-type="breeding" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
              <text class="action-icon">🗑️</text>
            </view>
          </view>
        </view>
      
        <view class="record-content">
          <view class="record-detail" wx:if="{{item.mating_date}}">
            <text class="detail-label">交配日期：</text>
            <text class="detail-value">{{item.mating_date_formatted}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.egg_laying_date}}">
            <text class="detail-label">产蛋日期：</text>
            <text class="detail-value">{{item.egg_laying_date_formatted}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.hatching_date}}">
            <text class="detail-label">孵化日期：</text>
            <text class="detail-value">{{item.hatching_date_formatted}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.egg_count}}">
            <text class="detail-label">产蛋数量：</text>
            <text class="detail-value">{{item.egg_count}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.chick_count}}">
            <text class="detail-label">育雏数量：</text>
            <text class="detail-value">{{item.chick_count}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.success_rate}}">
            <text class="detail-label">成功率：</text>
            <text class="detail-value">{{item.success_rate}}%</text>
          </view>
          <view class="record-detail" wx:if="{{item.notes}}">
            <text class="detail-label">备注：</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  
    <view class="empty-state" wx:if="{{breedingRecords.length === 0 && !loading}}">
      <view class="empty-icon">🥚</view>
      <view class="empty-text" wx:if="{{isLogin}}">暂无繁殖记录</view>
      <view class="empty-text" wx:else>请先登录查看记录</view>
      <button wx:if="{{isLogin && hasOperationPermission}}" class="btn btn-primary btn-large mt-30" bindtap="addBreedingRecord">添加繁殖记录</button>
    </view>
  </view>
</view>

<!-- 鹦鹉筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showParrotModal}}" bindtap="hideParrotFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择鹦鹉</text>
      <view class="modal-close" bindtap="hideParrotFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option" bindtap="selectParrot" data-parrot="">
        <text class="option-text">全部鹦鹉</text>
      </view>
      <view class="filter-option" wx:for="{{parrotsList}}" wx:key="id" bindtap="selectParrot" data-parrot="{{item.name}}" data-id="{{item.id}}">
        <text class="option-text">{{item.name}}</text>
      </view>
    </view>
  </view>
</view>

<!-- 鹦鹉筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showParrotModal}}" bindtap="hideParrotFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择鹦鹉</text>
      <view class="modal-close" bindtap="hideParrotFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option {{selectedParrot === '' ? 'selected' : ''}}" bindtap="selectParrot" data-parrot="">
        <text class="option-text">全部鹦鹉</text>
        <text class="option-check" wx:if="{{selectedParrot === ''}}">✓</text>
      </view>
      <view class="filter-option {{selectedParrot === item.name ? 'selected' : ''}}" wx:for="{{parrots}}" wx:key="id" bindtap="selectParrot" data-parrot="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
        <text class="option-check" wx:if="{{selectedParrot === item.name}}">✓</text>
      </view>
    </view>
  </view>
</view>

<!-- 日期筛选弹窗 -->
<view class="modal-overlay" wx:if="{{showDateModal}}" bindtap="hideDateFilter">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">选择时间范围</text>
      <view class="modal-close" bindtap="hideDateFilter">×</view>
    </view>
    <view class="modal-body">
      <view class="filter-option {{dateRange === 'all' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="all">
        <text class="option-text">全部时间</text>
        <text class="option-check" wx:if="{{dateRange === 'all'}}">✓</text>
      </view>
      <view class="filter-option {{dateRange === 'today' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="today">
        <text class="option-text">今天</text>
        <text class="option-check" wx:if="{{dateRange === 'today'}}">✓</text>
      </view>
      <view class="filter-option {{dateRange === 'week' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="week">
        <text class="option-text">最近一周</text>
        <text class="option-check" wx:if="{{dateRange === 'week'}}">✓</text>
      </view>
      <view class="filter-option {{dateRange === 'month' ? 'selected' : ''}}" bindtap="selectDateRange" data-range="month">
        <text class="option-text">最近一月</text>
        <text class="option-check" wx:if="{{dateRange === 'month'}}">✓</text>
      </view>
    </view>
  </view>
</view>
  </view>