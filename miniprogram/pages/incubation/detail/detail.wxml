<view class="page-container">
  <app-header title="孵化详情" subtitle="记录孵化详细信息" showBack="true">
    <view slot="actions" class="header-action" wx:if="{{hasOperationPermission}}" bindtap="openPlusMenu">
      <image class="header-icon" src="/images/remix/add-circle-fill.png" mode="widthFix" />
    </view>
  </app-header>
  <view class="page-content">
    <block wx:if="{{loading}}"><view class="loading">加载中...</view></block>
    <block wx:else>
      <view class="egg-card">
        <view class="row">
            <view class="label-wrap">
              <image class="icon-md" src="/images/remix/ri-heart-fill-red.png" />
              <text class="label">{{egg.label || ('蛋 ' + egg.id)}}</text>
            </view>
            <view class="status-wrap">
              <text class="status">{{statusText}}</text>
              <view class="hatch-badge-wrap" wx:if="{{hasHatched && egg.hatch_date_text === selectedDate}}">
                <image class="icon-sm" src="/images/remix/ri-home-5-fill-green.png" />
                <text class="hatch-badge-text">今日出壳</text>
              </view>
            </view>
          </view>
          <view class="meta">
            <view class="meta-item">
              <view class="meta-label-wrap">
                <image class="icon-xs" src="/images/remix/ri-calendar-fill-blue.png" />
                <text class="meta-label">开始</text>
              </view>
              <text class="meta-value">{{egg.incubator_start_datetime_text || egg.incubator_start_date_text || '未设置'}}</text>
            </view>
            <view class="meta-item">
              <view class="meta-label-wrap">
                <image class="icon-xs" src="/images/remix/ri-time-line.png" />
                <text class="meta-label">天数</text>
              </view>
              <text class="meta-value">{{egg.day_since_start_text}}</text>
            </view>
            <view class="meta-item">
              <view class="meta-label-wrap">
                <image class="icon-xs" src="/images/remix/ri-book-fill-green.png" />
                <text class="meta-label">品种</text>
              </view>
              <text class="meta-value">{{egg.species_name || '未设置'}}</text>
            </view>
            <view class="meta-item" wx:if="{{egg.hatch_date_text}}">
              <view class="meta-label-wrap">
                <image class="icon-xs" src="/images/remix/ri-home-5-fill-green.png" />
                <text class="meta-label">出壳</text>
              </view>
              <text class="meta-value">{{egg.hatch_date_text}}</text>
            </view>
          </view>
      </view>

      <view class="calendar" wx:if="{{calendarDays.length > 0}}">
        <view class="cal-header">
          <view class="cal-nav">
            <view class="nav-btn" bindtap="goPrevMonth">‹</view>
            <text class="month-text">{{currentMonthText}}</text>
            <view class="nav-btn" bindtap="goNextMonth">›</view>
          </view>
        </view>
        <view class="cal-weekdays">
          <view class="weekday">日</view>
          <view class="weekday">一</view>
          <view class="weekday">二</view>
          <view class="weekday">三</view>
          <view class="weekday">四</view>
          <view class="weekday">五</view>
          <view class="weekday">六</view>
        </view>
        <view class="cal-grid">
          <view class="cal-cell {{item.hasLog ? 'has-log' : ''}} {{item.isIncubating ? 'incubating' : ''}} {{item.isHatchDay ? 'hatch' : ''}} {{item.isToday ? 'today' : ''}} {{item.date === selectedDate ? 'selected' : ''}}" wx:for="{{calendarDays}}" wx:key="date" catchtap="onTapDay" data-date="{{item.date}}" data-dayindex="{{item.dayIndex}}">
            <text class="day">{{item.day}}</text>
            <text class="day-index" wx:if="{{item.dayIndex && item.isIncubating}}">第{{item.dayIndex}}天</text>
            <view class="dots-row">
              <view class="turning-dot" wx:if="{{item.isTurningDay}}"></view>
              <view class="candling-dot" wx:if="{{item.isCandlingDay}}"></view>
            </view>
          </view>
        </view>
        <view class="cal-legend">
          <view class="legend-item"><view class="legend-dot dot-incubating"></view><text>孵化期</text></view>
          <view class="legend-item"><view class="legend-dot dot-haslog"></view><text>有记录</text></view>
          <view class="legend-item"><view class="legend-swatch swatch-today"></view><text>今天</text></view>
          <view class="legend-item"><view class="legend-dot dot-turning"></view><text>翻蛋日</text></view>
          <view class="legend-item"><view class="legend-dot dot-candling"></view><text>照蛋日</text></view>
          <view class="legend-item"><view class="legend-swatch swatch-hatch"></view><text>出壳日</text></view>
        </view>
      </view>

      <view class="logs-section" wx:if="{{selectedLogs && selectedLogs.length > 0}}">
        <view class="logs-title-wrap">
          <image class="icon-md" src="/images/remix/edit-fill-orange.png" />
          <text class="logs-title">孵化日志</text>
        </view>
        <view class="logs-list">
          <view class="log-card" wx:for="{{selectedLogs}}" wx:key="id">
            <view class="log-header">
              <text class="log-date">{{item.log_date_text || item.log_date}}</text>
              <text class="log-candling" wx:if="{{item.candling || item.is_candling}}">照蛋</text>
              <view class="log-actions">
                <text class="log-action edit" data-id="{{item.id}}" bindtap="onEditLogTap">编辑</text>
                <text class="log-action delete" data-id="{{item.id}}" bindtap="onDeleteLogTap">删除</text>
              </view>
            </view>
            <view class="log-meta">
              <view wx:if="{{item.temperature_c || item.temperature}}" class="log-chip">温度 {{item.temperature_c || item.temperature}}℃</view>
              <view wx:if="{{item.humidity_pct || item.humidity}}" class="log-chip">湿度 {{item.humidity_pct || item.humidity}}%</view>
            </view>
            <view class="log-notes" wx:if="{{item.notes}}">{{item.notes}}</view>
          </view>
        </view>
      </view>

      <view class="hatch-mask" wx:if="{{showEditLogPanel}}" catchtouchmove="noop">
        <view class="action-modal">
          <view class="modal-title">编辑孵化日志</view>
          <view class="modal-content">
            <view class="section">
              <view class="form-row">
                <text class="field-label">记录日期</text>
                <picker mode="date" value="{{editLogDate}}" bindchange="onEditLogDateChange">
                  <view class="picker-display">{{editLogDate || '选择日期'}}</view>
                </picker>
              </view>
              <view class="form-row">
                <input class="form-input large" type="digit" placeholder="温度℃" value="{{editLogTemp}}" bindinput="onEditLogTempInput"/>
                <input class="form-input large" type="digit" placeholder="湿度%" value="{{editLogHum}}" bindinput="onEditLogHumInput"/>
              </view>
              <view class="form-row">
                <input class="form-input large" placeholder="备注" value="{{editLogNotes}}" bindinput="onEditLogNotesInput"/>
              </view>
            </view>
          </view>
          <view class="modal-actions">
            <button class="btn-cancel lg" bindtap="closeEditLogPanel">取消</button>
            <button class="btn-primary lg" bindtap="submitEditLog">保存</button>
          </view>
        </view>
      </view>

      <view class="suggest-card" wx:if="{{selectedDayIndex}}">
        <view class="suggest-heading">
          <image class="icon-md" src="/images/remix/ri-information-fill-amber.png" />
          <text>孵化建议</text>
        </view>
        <view class="suggest-title">
          <text class="title-day">第{{selectedDayIndex}}天</text>
          <text class="title-date">{{selectedDateText}}</text>
        </view>
        <view class="support-tip" wx:if="{{!speciesSupported}}">
          <text>当前孵化建议仅支持：玄凤鹦鹉、牡丹鹦鹉、亚马逊鹦鹉、金刚鹦鹉、非洲灰鹦鹉、折衷鹦鹉</text>
        </view>
        <view class="hatched-info" wx:if="{{hasHatched && afterHatch}}">
          <text>已出雏，无需孵化建议。</text>
        </view>
        <view class="suggest-grid" wx:if="{{!(hasHatched && afterHatch)}}">
          <view class="sg-box temp">
            <view class="sg-label-wrap">
              <image class="icon-sm" src="/images/remix/ri-bar-chart-fill-orange.png" />
              <text class="sg-label">温度</text>
            </view>
            <text class="sg-value">{{selectedTempRangeText}}</text>
          </view>
          <view class="sg-box hum">
            <view class="sg-label-wrap">
              <image class="icon-sm" src="/images/remix/ri-pie-chart-2-fill-blue.png" />
              <text class="sg-label">湿度</text>
            </view>
            <text class="sg-value">{{selectedHumRangeText}}</text>
          </view>
        </view>
        <view class="suggest-meta" wx:if="{{!(hasHatched && afterHatch)}}">
          <view class="meta-chip turning">{{selectedTurningText}}</view>
          <view class="meta-chip candling">{{selectedCandlingText}}</view>
        </view>
        <view class="suggest-tips" wx:if="{{selectedTips && selectedTips.length}}">
          <view class="tip-item" wx:for="{{selectedTips}}" wx:key="index">{{item}}</view>
        </view>
      </view>

      

      <view class="hatch-mask" wx:if="{{showHatchPanel}}" catchtouchmove="noop">
        <view class="hatch-modal">
          <view class="modal-title">设置出壳日期</view>
          <view class="modal-content">
            <picker mode="date" value="{{hatchDate}}" bindchange="onHatchDateChange">
              <view class="picker-display">{{hatchDate || '选择日期'}}</view>
            </picker>
          </view>
          <view class="modal-actions">
            <button class="btn-cancel" bindtap="closeHatchPanel">取消</button>
            <button class="btn-primary" bindtap="submitHatchDate">保存</button>
          </view>
        </view>
      </view>

      <view class="hatch-mask" wx:if="{{showUnifiedPanel}}" catchtouchmove="noop">
        <view class="action-modal unified-modal">
          <view class="modal-header-gradient">
            <view class="modal-header-row">
              <text class="modal-title">孵化记录</text>
              <view class="modal-close-btn" bindtap="closeUnifiedPanel"><text class="modal-close-icon">✕</text></view>
            </view>
          </view>
          <scroll-view scroll-y="true" class="modal-scroll">
            <view class="section">
              <view class="form-row">
                <text class="field-label">记录日期</text>
                <picker class="picker-flex" mode="date" value="{{logDate}}" bindchange="onLogDateChange">
                  <view class="picker-display">{{logDate || '选择日期'}}</view>
                </picker>
              </view>
              <view class="form-row">
                <input class="form-input large" type="digit" placeholder="温度℃" value="{{logTemp}}" bindinput="onLogTempInput"/>
                <input class="form-input large" type="digit" placeholder="湿度%" value="{{logHum}}" bindinput="onLogHumInput"/>
              </view>
              <view class="form-row switch-row">
                <text class="switch-label">是否照蛋</text>
                <switch checked="{{logCandling}}" bindchange="toggleLogCandling"/>
              </view>
              <view class="form-row">
                <input class="form-input large" placeholder="备注" value="{{logNotes}}" bindinput="onLogNotesInput"/>
              </view>
            </view>

            <view class="section">
              <view class="form-row switch-row">
                <text class="switch-label">今日出壳</text>
                <switch checked="{{hatchToday}}" bindchange="toggleHatchToday"/>
              </view>
            </view>
          </scroll-view>
          <view class="modal-footer">
            <button class="btn-secondary lg" bindtap="closeUnifiedPanel">取消</button>
            <button class="btn-primary lg" bindtap="submitUnifiedForm">保存</button>
          </view>
        </view>
      </view>

    </block>
  </view>
</view>
