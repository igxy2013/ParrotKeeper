<view class="page-container">
  <app-header title="鹦鹉配对计算器" subtitle="专业版基因预测" showBack="true" />
  <view class="page-content">
    <view class="switch-bar">
      <view class="switch-thumb {{activeTab === 'calculator' ? 'left' : 'right'}}"></view>
      <view class="switch-item {{activeTab === 'calculator' ? 'active' : ''}}" bindtap="switchTab" data-tab="calculator"><text class="switch-text">计算器</text></view>
      <view class="switch-item {{activeTab === 'records' ? 'active' : ''}}" bindtap="switchTab" data-tab="records"><text class="switch-text">配对记录</text></view>
    </view>
    <block wx:if="{{activeTab === 'calculator'}}">
    <view class="card">
      <view class="section-title">
        <text>配对设置</text>
      </view>
      <view class="form-row">
        <view class="form-label">物种</view>
        <picker mode="selector" range="{{speciesOptions}}" value="{{speciesIndex}}" bindchange="onSpeciesChange">
          <view class="picker-value">{{speciesOptions[speciesIndex]}}</view>
        </picker>
      </view>
      
      <!-- 母鸟设置 -->
      <plumage-selector 
        label="母鸟 (Hen)" 
        gender="female"
        colors="{{colorOptions}}"
        splits="{{availableSplits}}"
        colorIndex="{{motherColorIndex}}"
        splitIds="{{motherSplits}}"
        bind:change="onMotherPlumageChange"
      >
        <view slot="suggestion" class="suggestion-card" wx:if="{{bestFatherSuggestion}}">
          <view class="suggestion-title">最佳公鸟配对建议</view>
          <view class="suggestion-detail">{{bestFatherSuggestion.colorName}} · 预计均价 ¥{{bestFatherSuggestion.expectedValue}}</view>
        </view>
      </plumage-selector>

      <!-- 公鸟设置 -->
      <plumage-selector 
        label="公鸟 (Cock)" 
        gender="male"
        colors="{{colorOptions}}"
        splits="{{availableSplits}}"
        colorIndex="{{fatherColorIndex}}"
        splitIds="{{fatherSplits}}"
        bind:change="onFatherPlumageChange"
      >
        <view slot="suggestion" class="suggestion-card" wx:if="{{bestMotherSuggestion}}">
          <view class="suggestion-title">最佳母鸟配对建议</view>
          <view class="suggestion-detail">{{bestMotherSuggestion.colorName}} · 预计均价 ¥{{bestMotherSuggestion.expectedValue}}</view>
        </view>
      </plumage-selector>

      <view class="hint">提示：勾选“携带基因”可模拟隐性基因携带情况。部分复杂突变可能未完全覆盖。</view>
    </view>

    <view class="card">
      <view class="section-title">
        <text>预测结果</text>
      </view>
      <view wx:if="{{results && results.length > 0}}" class="results">
        <block wx:for="{{results}}" wx:key="index">
          <view class="result-item">
            <view class="result-info">
              <view class="result-label">{{item.label}}</view>
            </view>
            <view class="result-prob">{{item.prob}}%</view>
          </view>
        </block>
      </view>
      <view wx:else class="empty">请选择上方选项以计算</view>
    </view>

    <view wx:if="{{sexBreakdown && (sexBreakdown.male.length || sexBreakdown.female.length)}}" class="card">
      <view class="section-title">
        <text>按性别分布详情</text>
      </view>
      
      <view class="sex-section">
        <view class="sex-title male">
          <image class="gender-icon-img" src="/images/remix/men-line.png" mode="widthFix" />
          <text>公雏 (Males)</text>
        </view>
        <block wx:for="{{sexBreakdown.male}}" wx:key="index">
          <view class="result-item sm">
            <view class="result-label">{{item.label}}</view>
            <view class="result-prob">{{item.prob}}%</view>
          </view>
        </block>
        <view wx:if="{{sexBreakdown.male.length === 0}}" class="empty-sm">无公雏</view>
      </view>

      <view class="sex-section">
        <view class="sex-title female">
          <image class="gender-icon-img" src="/images/remix/women-line.png" mode="widthFix" />
          <text>母雏 (Females)</text>
        </view>
        <block wx:for="{{sexBreakdown.female}}" wx:key="index">
          <view class="result-item sm">
            <view class="result-label">{{item.label}}</view>
            <view class="result-prob">{{item.prob}}%</view>
          </view>
        </block>
        <view wx:if="{{sexBreakdown.female.length === 0}}" class="empty-sm">无母雏</view>
      </view>
    </view>

    <view class="card">
      <view class="section-title">
        <text>预计均价</text>
      </view>
      <view class="avg-box">
        <text class="avg-value">¥{{expectedAveragePrice}}</text>
        <text class="avg-hint">基于当前配对结果与参考价估算</text>
      </view>
    </view>

    <view class="save-pair-section">
      <view class="save-pair-btn" bindtap="savePairing">
        <view class="save-pair-btn-text">保存配对</view>
      </view>
    </view>
    </block>

    <block wx:if="{{activeTab === 'records'}}">
      <view wx:if="{{!records || records.length === 0}}" class="empty">暂无配对记录</view>
      <block wx:else>
        <block wx:for="{{records}}" wx:key="createdAt">
          <view class="card">
            <view class="section-title"><text>{{item.species}} · {{formatTime(item.createdAt)}}</text></view>
            <view class="form-row">
              <view class="form-label">母鸟</view>
              <view class="picker-value">{{item.motherColor}}{{item.motherSplits && item.motherSplits.length ? (' · ' + item.motherSplits.join('、')) : ''}}</view>
            </view>
            <view class="form-row">
              <view class="form-label">公鸟</view>
              <view class="picker-value">{{item.fatherColor}}{{item.fatherSplits && item.fatherSplits.length ? (' · ' + item.fatherSplits.join('、')) : ''}}</view>
            </view>
            <view class="avg-box">
              <text class="avg-value">¥{{item.expectedAveragePrice}}</text>
              <text class="avg-hint">预计均价</text>
            </view>
            <view wx:if="{{item.results && item.results.length}}" class="results">
              <block wx:for="{{item.results}}" wx:key="index">
                <view class="result-item">
                  <view class="result-label">{{item.label || item.name}}</view>
                  <view class="result-prob">{{item.prob}}%</view>
                </view>
              </block>
            </view>
            <view class="save-pair-section">
              <view class="save-pair-btn" catchtap="deleteRecord" data-index="{{index}}">
                <view class="save-pair-btn-text">删除该记录</view>
              </view>
            </view>
          </view>
        </block>
        <view class="save-pair-section">
          <view class="save-pair-btn" bindtap="clearAll">
            <view class="save-pair-btn-text">清空所有</view>
          </view>
        </view>
      </block>
    </block>
  </view>
</view>
