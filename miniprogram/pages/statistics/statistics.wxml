<!--pages/statistics/statistics.wxml-->
<view class="page-container" bindtap="{{showParrotDropdown ? 'toggleParrotDropdown' : ''}}">
  <app-header title="æ•°æ®ç»Ÿè®¡" subtitle="å…¨å±€æ•°æ®æ¦‚è§ˆ"></app-header>
  <view class="page-content">
  <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
  <view wx:if="{{!isLogin}}" class="guest-tip-card">
    <view class="tip-icon">ğŸ¯</view>
    <view class="tip-content">
      <text class="tip-text">æ‚¨æ­£åœ¨ä»¥æ¸¸å®¢èº«ä»½æµè§ˆç¤ºä¾‹æ•°æ®</text>
      <text class="tip-subtitle">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„çœŸå®ç»Ÿè®¡æ•°æ®</text>
    </view>
  </view>
  <!-- é¡¶éƒ¨æ—¶é—´æ®µé€‰æ‹©å™¨ -->
  <view class="period-selector-card">
    <view class="period-btn {{selectedPeriod === 'ä»Šå¤©' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="ä»Šå¤©">ä»Šå¤©</view>
    <view class="period-btn {{selectedPeriod === 'æœ¬å‘¨' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="æœ¬å‘¨">æœ¬å‘¨</view>
    <view class="period-btn {{selectedPeriod === 'æœ¬æœˆ' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="æœ¬æœˆ">æœ¬æœˆ</view>
    <view class="period-btn {{selectedPeriod === 'æœ¬å¹´' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="æœ¬å¹´">æœ¬å¹´</view>
  </view>

  <!-- æ¦‚è§ˆç»Ÿè®¡ï¼ˆAPPé£æ ¼2Ã—2æ¸å˜å¡ï¼‰ -->
  <view class="overview-grid">
    <view class="overview-card emerald">
      <view class="overview-header">
        <text class="overview-icon">â¤ï¸</text>
        <text class="label-chip">æ€»æ•°</text>
      </view>
      <text class="overview-value">{{overview.total_parrots || 0}}</text>
      <text class="overview-label">æˆ‘çš„é¹¦é¹‰</text>
    </view>

    <view class="overview-card blue">
      <view class="overview-header">
        <text class="overview-icon">ğŸ›¡ï¸</text>
        <text class="label-chip">å¥åº·</text>
      </view>
      <text class="overview-value">{{overview.health_status.healthy || 0}}</text>
      <text class="overview-label">å¥åº·çŠ¶æ€</text>
    </view>

    <view class="overview-card orange">
      <view class="overview-header">
        <text class="overview-icon">ğŸ½ï¸</text>
        <text class="label-chip">ä»Šæ—¥</text>
      </view>
      <text class="overview-value">{{overview.today_feeding || 0}}</text>
      <text class="overview-label">å–‚é£Ÿæ¬¡æ•°</text>
    </view>

    <view class="overview-card purple">
      <view class="overview-header">
        <text class="overview-icon">âš–ï¸</text>
        <text class="label-chip">å¹³å‡</text>
      </view>
      <text class="overview-value">{{avgWeight || '--'}}</text>
      <text class="overview-label">ä½“é‡</text>
    </view>
  </view>
  <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
  <view wx:if="{{!isLogin}}" class="guest-tip-card">
    <view class="tip-icon">ğŸ¯</view>
    <view class="tip-content">
      <text class="tip-text">æ‚¨æ­£åœ¨ä»¥æ¸¸å®¢èº«ä»½æµè§ˆç¤ºä¾‹æ•°æ®</text>
      <text class="tip-subtitle">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„çœŸå®ç»Ÿè®¡æ•°æ®</text>
    </view>
  </view>

  <!-- ä½“é‡è¶‹åŠ¿æ›²çº¿ -->
  <view class="health-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon">âš–ï¸</view>
          <text class="card-title">ä½“é‡è¶‹åŠ¿æ›²çº¿</text>
        </view>
        <view class="parrot-selector">
          <view class="selector-wrapper" bindtap="toggleParrotDropdown">
            <text class="selector-text">{{selectedParrotName || 'å…¨éƒ¨é¹¦é¹‰'}}</text>
            <text class="selector-arrow {{showParrotDropdown ? 'rotate' : ''}}">â–¼</text>
          </view>
          <view class="dropdown-menu {{showParrotDropdown ? 'show' : ''}}">
            <view class="dropdown-item" bindtap="selectWeightParrot" data-id="">
              <text>å…¨éƒ¨é¹¦é¹‰</text>
              <text class="check-icon">{{!selectedParrotId ? 'âœ“' : ''}}</text>
            </view>
            <view class="dropdown-item" wx:for="{{weightSeries}}" wx:key="parrot_id" bindtap="selectWeightParrot" data-id="{{item.parrot_id}}">
              <text>{{item.parrot_name}}</text>
              <text class="check-icon">{{selectedParrotId == item.parrot_id ? 'âœ“' : ''}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="card-content">
        <view class="legend-container" wx:if="{{weightLegend.length > 0}}">
          <view class="legend-item" wx:for="{{weightLegend}}" wx:key="parrot_id">
            <view class="legend-dot" style="background: {{item.color}};"></view>
            <text class="legend-name">{{item.parrot_name}}</text>
          </view>
        </view>
        <view class="weight-chart-container">
          <canvas type="2d" id="weightCanvas" style="width: 100%; height: 280rpx;"></canvas>
        </view>
      </view>
    </view>
  </view>

  <!-- å–‚é£Ÿè¶‹åŠ¿ï¼šå·²æŒ‰éœ€æ±‚ç§»é™¤ -->

  <!-- æ”¯å‡ºåˆ†æ -->
  <view class="expense-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon">ğŸ’°</view>
          <text class="card-title">æ”¯å‡ºåˆ†æ</text>
        </view>
        <view class="view-all-btn" bindtap="navigateToExpenses">
          <text>æŸ¥çœ‹å…¨éƒ¨</text>
          <view class="arrow-icon">â†’</view>
        </view>
      </view>
      <view class="card-content">
        <view wx:if="{{expenseAnalysis.length > 0}}">
          <view class="expense-legend-list">
            <view class="expense-legend-item" wx:for="{{expenseAnalysis}}" wx:key="category">
              <view class="expense-indicator" style="background-color: {{item.color}}"></view>
              <text class="expense-category-name">{{item.category}}</text>
              <view class="expense-amount-wrapper">
                <text class="expense-amount">Â¥{{item.amount}}</text>
              </view>
            </view>
          </view>
          <view class="chart-container">
            <canvas id="expensePieCanvas" type="2d" style="width: 100%; height: 360rpx;"></canvas>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <view class="placeholder-icon">ğŸ’°</view>
          <text class="placeholder-text">æš‚æ— æ”¯å‡ºè®°å½•</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æŠ¤ç†é¢‘ç‡ç»Ÿè®¡ï¼šå·²æŒ‰éœ€æ±‚ç§»é™¤ -->

  <!-- é£Ÿç‰©åå¥½åˆ†æ -->
  <view class="food-pref-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon">ğŸ½ï¸</view>
          <text class="card-title">é£Ÿç‰©åå¥½åˆ†æ</text>
        </view>
      </view>
      <view class="card-content">
        <view wx:if="{{foodPreference.length > 0}}">
          <view class="pref-list">
            <view class="pref-item" wx:for="{{foodPreference}}" wx:key="type">
              <text class="pref-name">{{item.label}}</text>
              <view class="pref-bar">
                <view class="pref-fill" style="width: {{item.percentage}}%;"></view>
              </view>
              <text class="pref-count">{{item.count}}</text>
              <text class="pref-percent">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <view class="placeholder-icon">ğŸ½ï¸</view>
          <text class="placeholder-text">æš‚æ— æ•°æ®</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å“ç§åˆ†å¸ƒ -->
  <view class="species-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon">ğŸ¦œ</view>
          <text class="card-title">å“ç§åˆ†å¸ƒ</text>
        </view>
      </view>
      <view class="card-content">
        <view class="species-list" wx:if="{{speciesDistribution.length > 0}}">
          <view class="species-item" wx:for="{{speciesDistribution}}" wx:key="species">
            <view class="species-indicator" style="background-color: {{item.color}}"></view>
            <text class="species-name">{{item.species}}</text>
            <view class="species-count-wrapper">
              <text class="species-count">{{item.count}}</text>
              <text class="species-unit">åª</text>
            </view>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <view class="placeholder-icon">ğŸ¦œ</view>
          <text class="placeholder-text">æš‚æ— æ•°æ®</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  </view>
</view>



