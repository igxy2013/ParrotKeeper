<!--pages/statistics/statistics.wxml-->
<view class="page-container" bindtap="{{showParrotDropdown ? 'toggleParrotDropdown' : ''}}">
  <app-header title="数据统计" subtitle="全局数据概览"></app-header>
  <view class="page-content">
  <!-- 游客模式提示 -->
  <view wx:if="{{!isLogin}}" class="guest-tip-card">
    <view class="tip-icon"><image class="tip-icon-img" src="{{iconPaths.tipInfoBlue}}" mode="widthFix" binderror="onStatIconError" data-key="tipInfoBlue"/></view>
    <view class="tip-content">
      <text class="tip-text">您正在以游客身份浏览示例数据</text>
      <text class="tip-subtitle">登录后可查看您的真实统计数据</text>
    </view>
  </view>
  <!-- 顶部时间段选择器 -->
  <view class="period-selector-card">
    <view class="period-btn {{selectedPeriod === '今天' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="今天">今天</view>
    <view class="period-btn {{selectedPeriod === '本周' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="本周">本周</view>
    <view class="period-btn {{selectedPeriod === '本月' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="本月">本月</view>
    <view class="period-btn {{selectedPeriod === '本年' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="本年">本年</view>
    <view class="period-btn {{selectedPeriod === '全部' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="全部">全部</view>
  </view>

  <!-- 概览统计（APP风格2×2渐变卡） -->
  <view class="overview-grid">
    <view class="overview-card emerald">
      <view class="overview-header">
        <view class="overview-icon-container">
          <image class="overview-icon-img" src="{{iconPaths.overview.heartWhite}}" mode="scaleToFill" binderror="onStatIconError" data-key="overview.heartWhite"/>
        </view>
        <text class="label-chip">总数</text>
      </view>
      <text class="overview-value">{{overview.total_parrots || 0}}</text>
      <text class="overview-label">我的鹦鹉</text>
    </view>

    <view class="overview-card blue">
      <view class="overview-header">
        <view class="overview-icon-container">
          <image class="overview-icon-img" src="{{iconPaths.overview.shieldWhite}}" mode="scaleToFill" binderror="onStatIconError" data-key="overview.shieldWhite"/>
        </view>
        <text class="label-chip">健康</text>
      </view>
      <text class="overview-value">{{overview.health_status.healthy || 0}}</text>
      <text class="overview-label">健康状态</text>
    </view>

    <view class="overview-card orange">
      <view class="overview-header">
        <view class="overview-icon-container">
          <image class="overview-icon-img" src="{{iconPaths.overview.restaurantWhite}}" mode="scaleToFill" binderror="onStatIconError" data-key="overview.restaurantWhite"/>
        </view>
        <text class="label-chip">今日</text>
      </view>
      <text class="overview-value">{{overview.today_feeding || 0}}</text>
      <text class="overview-label">喂食次数</text>
    </view>

    <view class="overview-card purple">
      <view class="overview-header">
        <view class="overview-icon-container">
          <image class="overview-icon-img" src="{{iconPaths.overview.scalesWhite}}" mode="scaleToFill" binderror="onStatIconError" data-key="overview.scalesWhite"/>
        </view>
        <text class="label-chip">平均</text>
      </view>
      <text class="overview-value">{{avgWeight || '--'}}</text>
      <text class="overview-label">体重</text>
    </view>
  </view>
  <!-- 游客模式提示 -->
  <view wx:if="{{!isLogin}}" class="guest-tip-card">
    <view class="tip-icon"><image class="tip-icon-img" src="{{iconPaths.tipInfoBlue}}" mode="widthFix" binderror="onStatIconError" data-key="tipInfoBlue"/></view>
    <view class="tip-content">
      <text class="tip-text">您正在以游客身份浏览示例数据</text>
      <text class="tip-subtitle">登录后可查看您的真实统计数据</text>
    </view>
  </view>

  <!-- 体重趋势曲线 -->
  <view class="health-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon"><image class="card-icon-img" src="{{iconPaths.lineChartPurple}}" mode="widthFix" binderror="onStatIconError" data-key="lineChartPurple"/></view>
          <text class="card-title">体重趋势曲线</text>
        </view>
        <view class="parrot-selector">
          <view class="selector-wrapper" bindtap="toggleParrotDropdown">
            <text class="selector-text">{{selectedParrotName || '全部鹦鹉'}}</text>
            <image class="selector-arrow-img {{showParrotDropdown ? 'rotate' : ''}}" src="/images/remix/ri-arrow-down-s-fill-gray.svg" mode="widthFix"/>
          </view>
          <view class="dropdown-menu {{showParrotDropdown ? 'show' : ''}}">
            <view class="dropdown-item" bindtap="selectWeightParrot" data-id="">
              <text>全部鹦鹉</text>
              <text class="check-icon">{{!selectedParrotId ? '✓' : ''}}</text>
            </view>
            <view class="dropdown-item" wx:for="{{weightSeries}}" wx:key="parrot_id" bindtap="selectWeightParrot" data-id="{{item.parrot_id}}">
              <text>{{item.parrot_name}}</text>
              <text class="check-icon">{{selectedParrotId == item.parrot_id ? '✓' : ''}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="card-content">
        <view class="legend-container" wx:if="{{weightLegend.length > 0}}">
          <view class="legend-item" wx:for="{{weightLegend}}" wx:key="parrot_id">
            <view class="legend-dot" style="background: {{item.color}};"></view>
            <text class="legend-name">{{item.parrot_name}}</text>
          </view>
        </view>
        <!-- 平均体重显示（当前筛选范围与鹦鹉选择下的均值） -->
        <view class="chart-meta">
          <text class="meta-label">平均体重</text>
          <text class="meta-value">{{weightAvgChart || '--'}}</text>
        </view>
        <view class="weight-chart-container">
          <canvas type="2d" id="weightCanvas" style="width: 100%; height: 280rpx;" bindtouchstart="onWeightCanvasTap"></canvas>
        </view>
        <!-- 自定义时间范围滑块 -->
        <view class="weight-range-control" wx:if="{{weightRangeDates.length > 1}}">
          <view class="range-labels">
            <text class="range-start">{{weightStartDate}}</text>
            <text class="range-end">{{weightEndDate}}</text>
          </view>
          <view class="range-sliders">
            <slider min="0" max="{{weightRangeDates.length - 1}}" step="1" value="{{weightStartIndex}}" show-value="{{false}}" bindchange="onWeightRangeStartChange" bindchanging="onWeightRangeStartChange" class="range-slider"/>
            <slider min="0" max="{{weightRangeDates.length - 1}}" step="1" value="{{weightEndIndex}}" show-value="{{false}}" bindchange="onWeightRangeEndChange" bindchanging="onWeightRangeEndChange" class="range-slider"/>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 喂食趋势：已按需求移除 -->

  <!-- 支出分析 -->
  <view class="expense-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon"><image class="card-icon-img" src="{{iconPaths.walletPurple}}" mode="widthFix" binderror="onStatIconError" data-key="walletPurple"/></view>
          <text class="card-title">支出分析</text>
        </view>
        <view class="view-all-btn" bindtap="navigateToExpenses">
          <text>查看全部</text>
          <image class="arrow-icon-img" src="{{iconPaths.arrowRightGray}}" mode="widthFix" binderror="onStatIconError" data-key="arrowRightGray"/>
        </view>
      </view>
      <view class="card-content">
        <view wx:if="{{expenseAnalysis.length > 0}}">
          <view class="expense-legend-list">
            <view class="expense-legend-item" wx:for="{{expenseAnalysis}}" wx:key="category">
              <view class="expense-indicator" style="background-color: {{item.color}}"></view>
              <text class="expense-category-name">{{item.category}}</text>
              <view class="expense-amount-wrapper">
                <text class="expense-amount">¥{{item.amount}}</text>
                <text class="expense-percent">{{item.percentage}}%</text>
              </view>
            </view>
          </view>
          <view class="chart-container">
            <canvas id="expensePieCanvas" type="2d" style="width: 100%; height: 360rpx;"></canvas>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <view class="placeholder-icon"><image class="placeholder-icon-img" src="{{iconPaths.walletPurple}}" mode="widthFix" binderror="onStatIconError" data-key="walletPurple"/></view>
          <text class="placeholder-text">暂无支出记录</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 护理频率统计：已按需求移除 -->

  <!-- 食物偏好分析 -->
  <view class="food-pref-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon"><image class="card-icon-img" src="{{iconPaths.restaurantOrange}}" mode="widthFix" binderror="onStatIconError" data-key="restaurantOrange"/></view>
          <text class="card-title">食物偏好分析</text>
        </view>
      </view>
      <view class="card-content">
        <view wx:if="{{foodPreference.length > 0}}">
          <view class="pref-list">
            <view class="pref-item" wx:for="{{foodPreference}}" wx:key="type">
              <text class="pref-name">{{item.label}}</text>
              <view class="pref-bar">
                <view class="pref-fill" style="width: {{item.percentage}}%;"></view>
              </view>
              <text class="pref-count">{{item.count}}</text>
              <text class="pref-percent">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <view class="placeholder-icon"><image class="placeholder-icon-img" src="{{iconPaths.restaurantOrange}}" mode="widthFix" binderror="onStatIconError" data-key="restaurantOrange"/></view>
          <text class="placeholder-text">暂无数据</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 品种分布 -->
  <view class="species-section">
    <view class="info-card">
      <view class="card-header">
        <view class="header-left">
          <view class="card-icon"><image class="card-icon-img" src="{{iconPaths.pieChartBlue}}" mode="widthFix" binderror="onStatIconError" data-key="pieChartBlue"/></view>
          <text class="card-title">品种分布</text>
        </view>
      </view>
      <view class="card-content">
        <view class="species-list" wx:if="{{speciesDistribution.length > 0}}">
          <view class="species-item" wx:for="{{speciesDistribution}}" wx:key="species">
            <view class="species-indicator" style="background-color: {{item.color}}"></view>
            <text class="species-name">{{item.species}}</text>
            <view class="species-count-wrapper">
              <text class="species-count">{{item.count}}</text>
              <text class="species-unit">只</text>
            </view>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <view class="placeholder-icon"><image class="placeholder-icon-img" src="{{iconPaths.pieChartBlue}}" mode="widthFix" binderror="onStatIconError" data-key="pieChartBlue"/></view>
          <text class="placeholder-text">暂无数据</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  </view>
</view>

<!-- 自定义底部导航 -->
<bottom-nav active="statistics" />
