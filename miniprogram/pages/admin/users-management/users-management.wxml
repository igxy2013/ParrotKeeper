<view class="page-container">
  <app-header title="用户管理" subtitle="统计与管理用户" showBack="{{true}}"></app-header>
  <view class="page-content">
    <block wx:if="{{!isSuperAdmin}}">
      <view class="no-access">仅超级管理员可访问该页面</view>
    </block>
    <block wx:else>
      <block wx:if="{{loading}}">
        <view class="loading">加载中...</view>
      </block>
      <block wx:else>
        <view class="card stats-card">
          <view class="stats-grid">
            <view class="stat-item">
              <view class="stat-icon bg-green">
                <image class="stat-icon-img" src="/images/remix/user-line-white.png" mode="aspectFit" />
              </view>
              <view class="stat-content">
                <text class="stat-value">{{stats.totalUsers}}</text>
                <text class="stat-label">总用户数</text>
              </view>
            </view>
            <view class="stat-item">
              <view class="stat-icon bg-indigo">
                <image class="stat-icon-img" src="/images/remix/group-line-white.png" mode="aspectFit" />
              </view>
              <view class="stat-content">
                <text class="stat-value">{{stats.teamCount}}</text>
                <text class="stat-label">团队数量</text>
              </view>
            </view>
          </view>
        </view>

        <!-- Search Bar -->
        <view class="search-container">
           <view class="search-box">
             <image class="search-icon" src="/images/remix/ri-search-line-gray.png" mode="aspectFit" />
             <input class="search-input" placeholder="搜索昵称/ID/手机号" value="{{keyword}}" bindinput="onSearchInput" />
             <view class="search-clear-btn" bindtap="clearSearch" wx:if="{{keyword}}">
               <image src="/images/remix/close-line.png" style="width:32rpx;height:32rpx;display:block;" />
             </view>
           </view>
        </view>

        <!-- Filters -->
        <view class="filter-dropdowns-row">
            <picker class="filter-picker" mode="selector" range="{{modeOptions}}" value="{{modeIndex}}" bindchange="onModeChange">
               <view class="dropdown-item">
                  <text>{{modeOptions[modeIndex]}}</text>
                  <image class="dropdown-icon" src="/images/remix/arrow-down-s-line.png" />
               </view>
            </picker>
            <picker class="filter-picker" mode="selector" range="{{sortOptions}}" value="{{sortIndex}}" bindchange="onSortChange">
               <view class="dropdown-item">
                  <text>{{sortOptions[sortIndex]}}</text>
                  <image class="dropdown-icon" src="/images/remix/arrow-down-s-line.png" />
               </view>
            </picker>
        </view>

        <!-- User List -->
        <view class="user-list">
          <block wx:for="{{users}}" wx:key="id">
            <view class="user-card-item">
              <image class="avatar" src="{{item.avatar_url || '/images/default-avatar.png'}}" mode="aspectFill" />
              <view class="user-main">
                <view class="row">
                  <text class="name">{{item.nickname || ('用户' + item.id)}}</text>
                  <text class="tag role {{item.role}}">{{item.role === 'super_admin' ? '超级管理员' : (item.role === 'admin' ? '管理员' : '普通用户')}}</text>
                  <text class="tag mode {{item.user_mode}}">{{item.user_mode === 'team' ? '团队模式' : '个人模式'}}</text>
                </view>
                <view class="meta">
                  <text class="meta-text">ID {{item.id}}</text>
                  <text class="meta-text">鹦鹉: {{item.parrot_count || 0}}</text>
                  <text class="meta-text">积分: {{item.points || 0}}</text>
                  <text class="meta-text">注册时间：{{item.created_at_display || ''}}</text>
                </view>
              </view>
            </view>
          </block>
          <view class="empty" wx:if="{{!users.length && !listLoading}}">暂无数据</view>
          <view class="loading-more" wx:if="{{hasMore && listLoading}}">
            <text>加载中...</text>
          </view>
          <view class="no-more" wx:if="{{!hasMore && users.length > 0}}">
            <text>没有更多了</text>
          </view>
        </view>
      </block>
    </block>
  </view>
</view>
