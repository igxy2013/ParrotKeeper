<view class="page-container">
  <app-header title="ç”¨æˆ·ä¸è§’è‰²ç®¡ç†" subtitle="æŸ¥çœ‹ç”¨æˆ·ä¸åˆ†é…è§’è‰²" showBack="true"></app-header>
  <view class="page-content">
    <block wx:if="{{!isSuperAdmin}}">
      <view class="no-access">è¯¥é¡µé¢ä»…é™è¶…çº§ç®¡ç†å‘˜è®¿é—®</view>
    </block>
    <block wx:else>
      <view class="stats-grid" wx:if="{{!loading}}">
        <view class="stat-card total">
          <view class="stat-icon"><text>ğŸ‘¥</text></view>
          <view class="stat-value">{{totalCount || 0}}</view>
          <view class="stat-label">æ€»ç”¨æˆ·</view>
        </view>
        <view class="stat-card admin">
          <view class="stat-icon"><text>ğŸ›¡ï¸</text></view>
          <view class="stat-value">{{adminCount || 0}}</view>
          <view class="stat-label">ç®¡ç†å‘˜</view>
        </view>
        <view class="stat-card user">
          <view class="stat-icon"><text>ğŸ‘¤</text></view>
          <view class="stat-value">{{userCount || 0}}</view>
          <view class="stat-label">æ™®é€šç”¨æˆ·</view>
        </view>
        <view class="stat-card team">
          <view class="stat-icon"><text>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</text></view>
          <view class="stat-value">{{teamUserCount || 0}}</view>
          <view class="stat-label">å›¢é˜Ÿç”¨æˆ·</view>
        </view>
      </view>
      <view class="search-bar">
        <input class="search-input" placeholder="æŒ‰æ˜µç§°/ç”¨æˆ·å/æ‰‹æœºå· æœç´¢" placeholder-class="search-placeholder" value="{{q}}" bindinput="onSearchInput" />
        <view class="search-actions">
          <button class="btn btn-primary" size="mini" bindtap="doSearch">æœç´¢</button>
          <button class="btn btn-secondary" size="mini" bindtap="clearSearch">æ¸…ç©º</button>
        </view>
      </view>

      <!-- æ’åºæ§ä»¶ -->
      <view class="sort-bar">
        <picker mode="selector" range="{{sortOptions}}" value="{{sortIndex}}" bindchange="onSortChange">
          <view class="sort-picker">
            <text class="sort-label">æ’åº</text>
            <text class="sort-chip">{{sortOptions[sortIndex]}}</text>
          </view>
        </picker>
        <view class="order-toggle" bindtap="toggleSortOrder">
          <text class="order-label">{{sortOrder === 'desc' ? 'é™åº' : 'å‡åº'}}</text>
        </view>
      </view>

      <view wx:if="{{loading}}" class="tips">åŠ è½½ä¸­...</view>



      <block wx:if="{{!loading && users.length === 0}}">
        <view class="empty">æš‚æ— ç”¨æˆ·</view>
      </block>

      <block wx:if="{{!loading && users.length > 0}}">
        <view class="user-list">
          <view class="user-item" wx:for="{{users}}" wx:key="id">
            <image class="avatar" src="{{item.avatar_url || '/images/remix/user-line.png'}}" mode="aspectFill"></image>
            <view class="info">
              <text class="name">{{item.nickname || item.username || ('ç”¨æˆ·' + item.id)}}</text>
              <text class="meta">ç§¯åˆ†: {{item.points || 0}}</text>
              <text class="meta">{{item.phone || ''}}</text>
              <text class="meta">é¹¦é¹‰æ•°é‡: {{item.parrot_count || 0}}</text>
              <text class="meta">æ€»æ”¯å‡º: Â¥{{item.total_expense || 0}}</text>
            </view>
            <picker mode="selector" range="{{roleDisplay}}" value="{{item.selectedIndex}}" bindchange="changeRole" data-index="{{index}}">
              <view class="role-picker">
                <text class="role-label">è§’è‰²</text>
                <text class="role-chip">{{item.displayRole}}</text>
              </view>
            </picker>
          </view>
        </view>
      </block>
    </block>
  </view>
</view>
