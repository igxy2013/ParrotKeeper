<view class="page-container">
  <app-header title="参考价格管理" subtitle="维护羽色市场参考价" showBack="true">
    <view slot="actions" class="header-btn" bindtap="openAddModal">
      <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" />
    </view>
  </app-header>
  <view class="page-content">
    <block wx:if="{{!isSuperAdmin}}">
      <view class="no-access">仅超级管理员可访问该页面</view>
    </block>
    <block wx:else>
      <view class="card">
        <view class="section-title">
          <text>物种筛选</text>
        </view>
        <view class="filter-row">
          <picker mode="selector" range="{{speciesNames}}" value="{{speciesIndex}}" bindchange="onSpeciesPickerChange">
            <view class="picker-value">{{speciesNames[speciesIndex] || '全部'}}</view>
          </picker>
          <view class="add-btn" bindtap="openAddModal">新增参考价</view>
        </view>
      </view>

      <view class="card">
        <view class="section-title">
          <text>参考价格列表</text>
        </view>
        <view wx:if="{{loading}}" class="loading">加载中...</view>
        <block wx:else>
          <view wx:if="{{!prices.length}}" class="empty">暂无数据</view>
          <block wx:else>
            <view class="price-list">
              <block wx:for="{{prices}}" wx:key="id">
                <view class="price-item">
                  <view class="price-info">
                    <text class="price-species">{{item.species}}</text>
                    <text class="price-color">{{item.color_name}}</text>
                    <text class="price-gender">{{item.gender_text}}</text>
                  </view>
                  <view class="price-value">¥{{item.reference_price}}</view>
                  <view class="item-actions">
                    <view class="action-btn edit" catchtap="openEditModal" data-index="{{index}}">
                      <image class="action-icon-img" src="/images/remix/edit-line-white.png" mode="aspectFit" />
                    </view>
                    <view class="action-btn delete" catchtap="deleteItem" data-index="{{index}}">
                      <image class="action-icon-img" src="/images/remix/delete-bin-line-white.png" mode="aspectFit" />
                    </view>
                  </view>
                </view>
              </block>
            </view>
          </block>
        </block>
      </view>

      <view wx:if="{{showAddModal}}" class="modal-overlay" catchtouchmove="true"></view>
      <view wx:if="{{showAddModal}}" class="modal-content">
        <view class="modal-header-gradient">
          <view class="modal-header-row">
            <text class="modal-title">{{editingIndex === null ? '新增参考价' : '编辑参考价'}}</text>
            <view class="modal-close-btn" bindtap="closeAddModal"><text class="modal-close-text">×</text></view>
          </view>
        </view>
        <scroll-view scroll-y="true" class="modal-scroll">
          <view class="form-section">
            <view class="form-grid">
              <view class="form-item">
                <text class="form-label">物种 *</text>
                <picker mode="selector" range="{{speciesNames}}" value="{{formSpeciesIndex}}" bindchange="onFormSpeciesChange">
                  <view class="picker-display">
                    <text>{{speciesNames[formSpeciesIndex] || addForm.species || '请选择'}}</text>
                    <text class="picker-arrow">▼</text>
                  </view>
                </picker>
              </view>
              <view class="form-item">
                <text class="form-label">羽色 *</text>
                <picker mode="selector" range="{{colorNames}}" value="{{formColorIndex}}" bindchange="onFormColorChange">
                  <view class="picker-display">
                    <text>{{colorNames[formColorIndex] || addForm.color_name || '请选择'}}</text>
                    <text class="picker-arrow">▼</text>
                  </view>
                </picker>
              </view>
            </view>

            <view class="form-item">
              <text class="form-label">性别</text>
              <picker mode="selector" range="{{genderOptions}}" value="{{formGenderIndex}}" bindchange="onFormGenderChange">
                <view class="picker-display">
                  <text>{{genderOptions[formGenderIndex]}}</text>
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>

            <view class="form-grid">
              <view class="form-item">
                <text class="form-label">价格 *</text>
                <input class="text-input" type="number" placeholder="如：1500" value="{{addForm.reference_price}}" bindinput="onFormInput" data-key="reference_price" />
              </view>
              <view class="form-item">
                <text class="form-label">来源</text>
                <input class="text-input" placeholder="可选，如平台或市场" value="{{addForm.source}}" bindinput="onFormInput" data-key="source" />
              </view>
            </view>
          </view>
        </scroll-view>
        <view class="modal-footer">
          <button class="btn-secondary" bindtap="closeAddModal">取消</button>
          <button class="btn-primary" bindtap="submitForm">提交</button>
        </view>
      </view>
    </block>
  </view>
</view>
