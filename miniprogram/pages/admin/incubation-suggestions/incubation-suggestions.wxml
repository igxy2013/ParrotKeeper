<wxs module="utils">
var isSelected = function(list, id) {
  if (!list) return false;
  // WXS 中的 indexOf 返回值判断
  return list.indexOf(id) > -1 || list.indexOf(parseInt(id)) > -1 || list.indexOf(id.toString()) > -1;
}
module.exports = {
  isSelected: isSelected
};
</wxs>
<view class="page-container">
  <app-header title="孵化建议管理" subtitle="按品种与天数范围配置" showBack="true">
    <view slot="actions" class="header-btn" bindtap="openCreateModal">
      <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" />
    </view>
  </app-header>
  <view class="page-content">
    <block wx:if="{{!isSuperAdmin}}"><view class="no-access">仅超级管理员可访问</view></block>
    <block wx:elif="{{loading}}"><view class="loading">加载中...</view></block>
    <block wx:else>
      
      <view class="list" wx:if="{{groupedItems && groupedItems.length}}">
        <view class="item" wx:for="{{groupedItems}}" wx:key="key">
          <view class="item-header">
            <text class="range">第{{item.sample.day_start}}-{{item.sample.day_end}}天</text>
            <view class="species-chips">
              <block wx:for="{{item.species_names}}" wx:key="index"><text class="species-chip">{{item}}</text></block>
            </view>
          <view class="actions">
            <text class="action" bindtap="openEditGroupModal" data-key="{{item.key}}">编辑</text>
            <text class="action delete" bindtap="batchDeleteGroup" data-key="{{item.key}}">删除</text>
            <text class="action" bindtap="toggleGroupExpand" data-key="{{item.key}}">{{groupExpanded[item.key] ? '收起' : '展开'}}</text>
          </view>
          </view>
          <view class="item-body">
            <view class="kv-row">
              <text class="kv-label">温度</text>
              <view class="kv-value"><text class="chip green">{{item.sample.temperature_low || '-'}}-{{item.sample.temperature_high || '-'}}℃</text><text class="chip blue">目标 {{item.sample.temperature_target || '-'}}℃</text></view>
            </view>
            <view class="kv-row">
              <text class="kv-label">湿度</text>
              <view class="kv-value"><text class="chip green">{{item.sample.humidity_low || '-'}}-{{item.sample.humidity_high || '-'}}%</text></view>
            </view>
            <view class="badge-group">
              <text class="badge {{item.sample.turning_required ? 'on' : 'off'}}">翻蛋{{item.sample.turning_required ? '✓' : '✕'}}</text>
              <text class="badge {{item.sample.candling_required ? 'on' : 'off'}}">照蛋{{item.sample.candling_required ? '✓' : '✕'}}</text>
            </view>
            <text wx:if="{{item.sample.tips}}" class="tips-text">{{item.sample.tips}}</text>
            <view class="group-details" wx:if="{{groupExpanded[item.key]}}">
              <view class="detail-row" wx:for="{{item.items}}" wx:key="id">
                <text class="detail-species">{{item.species_name}}</text>
                <view class="detail-actions">
                  <text class="action edit" data-id="{{item.id}}" bindtap="openEditModal">编辑</text>
                  <text class="action delete" data-id="{{item.id}}" bindtap="deleteItem">删除</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      <view wx:else class="empty">暂无配置</view>
    </block>

    <view class="modal-mask" wx:if="{{showModal}}" catchtouchmove="noop">
      <view class="modal">
        <view class="modal-header-gradient">
          <view class="modal-header-row">
            <text class="modal-title">{{modalTitle}}</text>
            <view class="modal-close-btn" bindtap="closeModal"><text class="modal-close-text">×</text></view>
          </view>
        </view>
        <view class="modal-content">
          <view class="picker-display" bindtap="openSpeciesSelector">{{formSpeciesDisplay || '选择品种（可多选）'}}</view>
          <view class="species-multi" wx:if="{{showSpeciesMulti}}">
            <view class="species-option {{(item.selected || utils.isSelected(formSpeciesIds, item.id)) ? 'selected' : ''}}" style="{{(item.selected || utils.isSelected(formSpeciesIds, item.id)) ? 'background:#10b981;color:#ffffff;border-color:#10b981;box-shadow:0 6rpx 14rpx rgba(16,185,129,0.35)' : ''}}" wx:for="{{speciesList}}" wx:key="id" bindtap="toggleSpecies" data-id="{{item.id}}" data-name="{{item.name}}">{{item.name}}</view>
          </view>
          <view class="form-row">
            <input class="form-input" type="number" placeholder="开始天数" value="{{form.day_start}}" bindinput="onFormInput" data-field="day_start" />
            <input class="form-input" type="number" placeholder="结束天数" value="{{form.day_end}}" bindinput="onFormInput" data-field="day_end" />
          </view>
          <view class="form-row">
            <input class="form-input" type="digit" placeholder="温度下限℃" value="{{form.temperature_low}}" bindinput="onFormInput" data-field="temperature_low" />
            <input class="form-input" type="digit" placeholder="温度上限℃" value="{{form.temperature_high}}" bindinput="onFormInput" data-field="temperature_high" />
          </view>
          <view class="form-row">
            <input class="form-input" type="digit" placeholder="目标温度℃(可选)" value="{{form.temperature_target}}" bindinput="onFormInput" data-field="temperature_target" />
          </view>
          <view class="form-row">
            <input class="form-input" type="digit" placeholder="湿度下限%" value="{{form.humidity_low}}" bindinput="onFormInput" data-field="humidity_low" />
            <input class="form-input" type="digit" placeholder="湿度上限%" value="{{form.humidity_high}}" bindinput="onFormInput" data-field="humidity_high" />
          </view>
          <view class="form-row">
            <view class="switch-row">
              <text class="switch-label">是否翻蛋</text>
              <switch checked="{{form.turning_required}}" bindchange="onFormSwitchChange" data-field="turning_required" />
            </view>
            <view class="switch-row">
              <text class="switch-label">是否照蛋</text>
              <switch checked="{{form.candling_required}}" bindchange="onFormSwitchChange" data-field="candling_required" />
            </view>
          </view>
          <view class="form-row">
            <input class="form-input" placeholder="建议文案(可选)" value="{{form.tips}}" bindinput="onFormInput" data-field="tips" />
          </view>
        </view>
        <view class="modal-actions">
          <button class="btn-secondary" bindtap="closeModal">取消</button>
          <button class="btn-primary" bindtap="submitForm">保存</button>
        </view>
      </view>
    </view>
  </view>
</view>
