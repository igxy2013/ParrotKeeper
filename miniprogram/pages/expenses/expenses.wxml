<!--pages/expenses/expenses.wxml-->
<view class="page-container">
  <app-header title="收支管理" subtitle="记录鹦鹉相关收入支出" showBack="{{true}}" theme="orange">
    <view slot="actions" class="header-actions">
      <view class="header-add-btn" bindtap="onShowAddRecord">
        <text class="add-icon">＋</text>
      </view>
    </view>
  </app-header>

  <view class="page-content">
    <!-- 统计卡片 -->
    <view class="stats-grid">
      <view class="stat-card income">
        <view class="stat-icon">⬆️</view>
        <view class="stat-value">¥{{stats.totalIncome}}</view>
        <view class="stat-label">当前筛选收入</view>
      </view>
      <view class="stat-card expense">
        <view class="stat-icon">⬇️</view>
        <view class="stat-value">¥{{stats.totalExpense}}</view>
        <view class="stat-label">当前筛选支出</view>
      </view>
    </view>

    <view class="stats-grid">
      <view class="stat-card net {{stats.netIncome >= 0 ? 'positive' : 'negative'}}">
        <view class="stat-icon">💼</view>
        <view class="stat-value">¥{{stats.netIncome}}</view>
        <view class="stat-label">净收入</view>
      </view>
      <view class="stat-card monthly">
        <view class="stat-icon">📅</view>
        <view class="stat-value">¥{{stats.monthlyNet}}</view>
        <view class="stat-label">本月净收入</view>
      </view>
    </view>

    <!-- 筛选条件 -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">筛选条件</text>
      </view>
      <view class="card-content">
        <view class="filter-section">
          <text class="filter-label">记录类型</text>
          <view class="chip-group chip-group-tight">
            <block wx:for="{{types}}" wx:key="*this">
              <button class="chip {{selectedType === item ? 'active ' + (item === '收入' ? 'income' : item === '支出' ? 'expense' : 'all') : ''}}" bindtap="onSelectType" data-type="{{item}}">{{item}}</button>
            </block>
          </view>
        </view>

        

        <view class="filter-section">
          <text class="filter-label">记录类别</text>
          <view class="chip-group">
            <block wx:for="{{filterCategories}}" wx:key="*this">
              <button class="chip {{selectedCategory === item ? 'active category' : ''}}" bindtap="onSelectCategory" data-category="{{item}}">{{item}}</button>
            </block>
          </view>
        </view>
      </view>
    </view>

    

    <!-- 记录列表 -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">记录列表</text>
        <text class="total-text">共 {{filteredRecords.length}} 条</text>
      </view>
      <view class="card-content">
        <view class="list-container">
      <block wx:for="{{filteredRecords}}" wx:key="id">
        <view class="list-item">
          <view class="list-item-content">
            <view class="list-item-main">
              <view class="list-item-title">
                <text class="type-tag {{item.type === '收入' ? 'income' : 'expense'}}">{{item.type}}</text>
                <text class="category-tag">{{item.category}}</text>
              </view>
              <view class="list-item-desc">{{item.description || '无描述'}}</view>
              <view class="list-item-meta">
                <text class="date-tag">{{item.date}} {{item.time}}</text>
                <text class="parrot-tag" wx:if="{{item.parrot}}">{{item.parrot}}</text>
              </view>
            </view>
            <view class="list-item-value {{item.type === '收入' ? 'income' : 'expense'}}">¥{{item.amount}}</view>
          </view>
        </view>
      </block>

      <!-- 加载状态 -->
      <view class="loading-state" wx:if="{{loading}}"><text>加载中...</text></view>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{!loading && filteredRecords.length === 0}}">
        <view class="empty-icon">💰</view>
        <text class="empty-text">暂无记录</text>
        <button class="btn btn-primary btn-small" bindtap="onShowAddRecord">添加第一条收支</button>
      </view>
        </view>
      </view>
    </view>

    <!-- 添加记录弹窗 -->
    <view class="modal-overlay" wx:if="{{showAddRecord}}">
      <view class="modal-content" style="margin-top: {{modalTopOffsetPx}}px; margin-bottom: {{modalBottomOffsetPx}}px;">
        <view class="modal-header">
          <text class="modal-title">添加收支记录</text>
          <button class="modal-close" bindtap="onHideAddRecord">✖</button>
        </view>
        <view class="modal-body">
          <view class="form-item">
            <text class="form-label">记录类型</text>
            <view class="toggle-group">
              <button class="toggle {{newRecord.type === '收入' ? 'active income' : ''}}" bindtap="onSetNewType" data-type="收入">收入</button>
              <button class="toggle {{newRecord.type === '支出' ? 'active expense' : ''}}" bindtap="onSetNewType" data-type="支出">支出</button>
            </view>
          </view>

          <view class="form-item">
            <!-- 已移除选择鹦鹉字段 -->
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}类别</text>
            <picker range="{{modalCategories}}" range-key="label" value="{{categoryIndex}}" bindchange="onNewCategoryChange">
              <view class="picker-view">
                <text class="picker-text">{{newRecord.category || modalCategories[0].label}}</text>
                <text class="picker-arrow">▼</text>
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}金额</text>
            <input type="number" value="{{newRecord.amount}}" bindinput="onNewAmountChange" placeholder="请输入金额" class="form-input" />
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}描述</text>
            <input type="text" value="{{newRecord.description}}" bindinput="onNewDescriptionChange" placeholder="请输入{{newRecord.type}}描述" class="form-input" />
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}日期</text>
            <picker mode="date" value="{{newRecord.date}}" bindchange="onNewDateChange">
              <view class="picker-view">
                <text class="picker-text">{{newRecord.date}}</text>
                <text class="picker-arrow">▼</text>
              </view>
            </picker>
          </view>
        </view>

        <view class="modal-actions">
          <button class="btn btn-secondary" bindtap="onHideAddRecord">取消</button>
          <button class="btn {{newRecord.type === '收入' ? 'btn-success' : 'btn-primary'}}" bindtap="onAddRecord">添加</button>
        </view>
      </view>
    </view>
  </view>
</view>
