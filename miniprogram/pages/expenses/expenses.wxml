<!--pages/expenses/expenses.wxml-->
<view class="page-container">
  <!-- æ±‡æ€»ä¿¡æ¯ -->
  <view class="card">
    <view class="card-header">
      <text class="card-title">æ”¯å‡ºæ±‡æ€»</text>
    </view>
    <view class="card-content">
      <view class="summary-grid">
        <view class="summary-item">
          <text class="summary-label">æœ¬æœˆæ”¯å‡º</text>
          <text class="summary-value">Â¥{{summary.monthly_total_display || '0.00'}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æœ¬å¹´æ”¯å‡º</text>
          <text class="summary-value">Â¥{{summary.yearly_total_display || '0.00'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæ  -->
  <view class="card">
    <view class="card-content">
      <view class="action-bar">
        <button class="btn btn-primary btn-small" bindtap="onAddExpense" wx:if="{{hasOperationPermission}}">
          <text class="action-icon">â•</text>
          æ·»åŠ æ”¯å‡º
        </button>
        <button class="btn btn-secondary btn-small" bindtap="onShowFilter">
          <text class="action-icon">ğŸ”</text>
          ç­›é€‰
        </button>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="card" wx:if="{{showFilter}}">
    <view class="card-header">
      <text class="card-title">ç­›é€‰æ¡ä»¶</text>
    </view>
    <view class="card-content">
      <!-- ç­›é€‰å¼¹å±‚ -->
      <view wx:if="{{showFilter}}" class="filter-overlay" catchtouchmove="true">
        <view class="filter-panel">
          <view class="filter-title">ç­›é€‰æ¡ä»¶</view>
      
          <!-- ç±»åˆ«ç­›é€‰ -->
          <view class="form-group">
            <view class="form-label">ç±»åˆ«ï¼š</view>
            <picker mode="selector" bindchange="onCategoryChange" range="{{categories}}" range-key="label" value="{{selectedCategoryIndex}}">
              <view class="form-picker">
                {{selectedCategoryLabel || 'å…¨éƒ¨ç±»åˆ«'}}
                <text class="arrow">></text>
              </view>
            </picker>
          </view>
      
          <!-- å¼€å§‹æ—¥æœŸ -->
          <view class="form-group">
            <view class="form-label">å¼€å§‹æ—¥æœŸï¼š</view>
            <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
              <view class="form-picker">
                {{startDate || 'é€‰æ‹©æ—¥æœŸ'}}
                <text class="arrow">></text>
              </view>
            </picker>
          </view>
      
          <!-- ç»“æŸæ—¥æœŸ -->
          <view class="form-group">
            <view class="form-label">ç»“æŸæ—¥æœŸï¼š</view>
            <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
              <view class="form-picker">
                {{endDate || 'é€‰æ‹©æ—¥æœŸ'}}
                <text class="arrow">></text>
              </view>
            </picker>
          </view>
      
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="filter-actions">
            <button class="btn secondary" bindtap="onResetFilter">é‡ç½®</button>
            <button class="btn primary" bindtap="onApplyFilter">åº”ç”¨</button>
          </view>
        </view>
      </view>
    </view>
  </view>
  <!-- æ”¯å‡ºåˆ—è¡¨ -->
  <view class="card">
    <view class="card-header">
      <text class="card-title">æ”¯å‡ºè®°å½•</text>
      <text class="total-text">å…± {{totalCount}} æ¡è®°å½•ï¼Œæ€»è®¡ Â¥{{totalAmount_display || '0.00'}}
      </text>
    </view>
  </view>
  
  <!-- æ”¯å‡ºè®°å½•åˆ—è¡¨ -->
  <view class="list-container">
    <view class="list-item" wx:for="{{expenses}}" wx:key="id">
      <view class="list-item-content" bindtap="onEditExpense" data-id="{{item.id}}">
        <view class="list-item-main">
          <view class="list-item-title">
            <text class="category-icon">{{item.categoryName || 'å…¶ä»–'}}</text>
          </view>
          <view class="list-item-desc">{{item.description || 'æ— æè¿°'}}</view>
          <view class="list-item-meta">
            <text class="date-tag">{{item.expense_date}}</text>
            <text class="parrot-tag" wx:if="{{item.parrot_name}}">{{item.parrot_name}}</text>
          </view>
        </view>
        <view class="list-item-value">Â¥{{item.amount_display || '0.00'}}
        </view>
      </view>
      <view class="list-item-actions">
        <view class="action-btn edit" bindtap="onEditExpense" data-id="{{item.id}}" wx:if="{{hasOperationPermission}}">
          <text class="action-icon">âœï¸</text>
        </view>
        <view class="action-btn delete" bindtap="onDeleteExpense" data-id="{{item.id}}" data-index="{{index}}" wx:if="{{hasOperationPermission}}">
          <text class="action-icon">ğŸ—‘ï¸</text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && expenses.length === 0}}">
      <view class="empty-icon">ğŸ’°</view>
      <text class="empty-text">æš‚æ— æ”¯å‡ºè®°å½•</text>
      <button class="btn btn-primary btn-small" bindtap="onAddExpense">æ·»åŠ ç¬¬ä¸€æ¡æ”¯å‡º</button>
    </view>

    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view class="no-more-state" wx:if="{{!hasMore && expenses.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
    </view>
  </view>
</view>