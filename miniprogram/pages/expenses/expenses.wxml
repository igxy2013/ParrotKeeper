<!--pages/expenses/expenses.wxml-->
<view class="page-container">
  <app-header title="æ”¶æ”¯ç®¡ç†" subtitle="è®°å½•é¹¦é¹‰ç›¸å…³æ”¶å…¥æ”¯å‡º" showBack="{{true}}" theme="orange">
    <view slot="actions" class="header-actions">
      <view class="header-add-btn" bindtap="onShowAddRecord">
        <text class="add-icon">ï¼‹</text>
      </view>
    </view>
  </app-header>

  <view class="page-content">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-grid">
      <view class="stat-card income">
        <view class="stat-icon">â¬†ï¸</view>
        <view class="stat-value">Â¥{{stats.totalIncome}}</view>
        <view class="stat-label">å½“å‰ç­›é€‰æ”¶å…¥</view>
      </view>
      <view class="stat-card expense">
        <view class="stat-icon">â¬‡ï¸</view>
        <view class="stat-value">Â¥{{stats.totalExpense}}</view>
        <view class="stat-label">å½“å‰ç­›é€‰æ”¯å‡º</view>
      </view>
    </view>

    <view class="stats-grid">
      <view class="stat-card net {{stats.netIncome >= 0 ? 'positive' : 'negative'}}">
        <view class="stat-icon">ğŸ’¼</view>
        <view class="stat-value">Â¥{{stats.netIncome}}</view>
        <view class="stat-label">å‡€æ”¶å…¥</view>
      </view>
      <view class="stat-card monthly">
        <view class="stat-icon">ğŸ“…</view>
        <view class="stat-value">Â¥{{stats.monthlyNet}}</view>
        <view class="stat-label">æœ¬æœˆå‡€æ”¶å…¥</view>
      </view>
    </view>

    <!-- ç­›é€‰æ¡ä»¶ -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">ç­›é€‰æ¡ä»¶</text>
      </view>
      <view class="card-content">
        <view class="filter-section">
          <text class="filter-label">è®°å½•ç±»å‹</text>
          <view class="chip-group chip-group-tight">
            <block wx:for="{{types}}" wx:key="*this">
              <button class="chip {{selectedType === item ? 'active ' + (item === 'æ”¶å…¥' ? 'income' : item === 'æ”¯å‡º' ? 'expense' : 'all') : ''}}" bindtap="onSelectType" data-type="{{item}}">{{item}}</button>
            </block>
          </view>
        </view>

        

        <view class="filter-section">
          <text class="filter-label">è®°å½•ç±»åˆ«</text>
          <view class="chip-group">
            <block wx:for="{{filterCategories}}" wx:key="*this">
              <button class="chip {{selectedCategory === item ? 'active category' : ''}}" bindtap="onSelectCategory" data-category="{{item}}">{{item}}</button>
            </block>
          </view>
        </view>
      </view>
    </view>

    

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">è®°å½•åˆ—è¡¨</text>
        <text class="total-text">å…± {{filteredRecords.length}} æ¡</text>
      </view>
      <view class="card-content">
        <view class="list-container">
      <block wx:for="{{filteredRecords}}" wx:key="id">
        <view class="list-item">
          <view class="list-item-content">
            <view class="list-item-main">
              <view class="list-item-title">
                <text class="type-tag {{item.type === 'æ”¶å…¥' ? 'income' : 'expense'}}">{{item.type}}</text>
                <text class="category-tag">{{item.category}}</text>
              </view>
              <view class="list-item-desc">{{item.description || 'æ— æè¿°'}}</view>
              <view class="list-item-meta">
                <text class="date-tag">{{item.date}} {{item.time}}</text>
                <text class="parrot-tag" wx:if="{{item.parrot}}">{{item.parrot}}</text>
              </view>
            </view>
            <view class="list-item-value {{item.type === 'æ”¶å…¥' ? 'income' : 'expense'}}">Â¥{{item.amount}}</view>
          </view>
        </view>
      </block>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{loading}}"><text>åŠ è½½ä¸­...</text></view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{!loading && filteredRecords.length === 0}}">
        <view class="empty-icon">ğŸ’°</view>
        <text class="empty-text">æš‚æ— è®°å½•</text>
        <button class="btn btn-primary btn-small" bindtap="onShowAddRecord">æ·»åŠ ç¬¬ä¸€æ¡æ”¶æ”¯</button>
      </view>
        </view>
      </view>
    </view>

    <!-- æ·»åŠ è®°å½•å¼¹çª— -->
    <view class="modal-overlay" wx:if="{{showAddRecord}}">
      <view class="modal-content" style="margin-top: {{modalTopOffsetPx}}px; margin-bottom: {{modalBottomOffsetPx}}px;">
        <view class="modal-header">
          <text class="modal-title">æ·»åŠ æ”¶æ”¯è®°å½•</text>
          <button class="modal-close" bindtap="onHideAddRecord">âœ–</button>
        </view>
        <view class="modal-body">
          <view class="form-item">
            <text class="form-label">è®°å½•ç±»å‹</text>
            <view class="toggle-group">
              <button class="toggle {{newRecord.type === 'æ”¶å…¥' ? 'active income' : ''}}" bindtap="onSetNewType" data-type="æ”¶å…¥">æ”¶å…¥</button>
              <button class="toggle {{newRecord.type === 'æ”¯å‡º' ? 'active expense' : ''}}" bindtap="onSetNewType" data-type="æ”¯å‡º">æ”¯å‡º</button>
            </view>
          </view>

          <view class="form-item">
            <!-- å·²ç§»é™¤é€‰æ‹©é¹¦é¹‰å­—æ®µ -->
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}ç±»åˆ«</text>
            <picker range="{{modalCategories}}" range-key="label" value="{{categoryIndex}}" bindchange="onNewCategoryChange">
              <view class="picker-view">
                <text class="picker-text">{{newRecord.category || modalCategories[0].label}}</text>
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}é‡‘é¢</text>
            <input type="number" value="{{newRecord.amount}}" bindinput="onNewAmountChange" placeholder="è¯·è¾“å…¥é‡‘é¢" class="form-input" />
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}æè¿°</text>
            <input type="text" value="{{newRecord.description}}" bindinput="onNewDescriptionChange" placeholder="è¯·è¾“å…¥{{newRecord.type}}æè¿°" class="form-input" />
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}æ—¥æœŸ</text>
            <picker mode="date" value="{{newRecord.date}}" bindchange="onNewDateChange">
              <view class="picker-view">
                <text class="picker-text">{{newRecord.date}}</text>
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </view>

        <view class="modal-actions">
          <button class="btn btn-secondary" bindtap="onHideAddRecord">å–æ¶ˆ</button>
          <button class="btn {{newRecord.type === 'æ”¶å…¥' ? 'btn-success' : 'btn-primary'}}" bindtap="onAddRecord">æ·»åŠ </button>
        </view>
      </view>
    </view>
  </view>
</view>
