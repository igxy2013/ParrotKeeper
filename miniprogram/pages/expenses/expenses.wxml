<!--pages/expenses/expenses.wxml-->
<view class="page-container">
  <app-header title="收支管理" subtitle="记录鹦鹉相关收入支出" showBack="{{true}}" theme="orange">
    <view slot="actions" class="header-actions">
      <view class="header-add-btn" bindtap="onShowAddRecord">
        <image class="header-btn-icon-img" src="/images/remix/add-circle-fill.png" mode="widthFix" />
      </view>
    </view>
  </app-header>

  <view class="page-content">
    <!-- 顶部时间段选择器 -->
    <view class="period-selector-card">
      <view class="period-btn {{selectedPeriod === '今天' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="今天">今天</view>
      <view class="period-btn {{selectedPeriod === '本周' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="本周">本周</view>
      <view class="period-btn {{selectedPeriod === '本月' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="本月">本月</view>
      <view class="period-btn {{selectedPeriod === '本年' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="本年">本年</view>
      <view class="period-btn {{selectedPeriod === '全部' ? 'active' : ''}}" bindtap="setSelectedPeriod" data-period="全部">全部</view>
    </view>

    <!-- 统计卡片 -->
    <view class="stats-grid two-columns">
      <view class="stat-card income">
        <view class="stat-icon">
          <image class="stat-icon-img" src="/images/remix/ri-money-dollar-circle-fill-green.png" mode="widthFix" />
        </view>
        <view class="stat-value">¥{{stats.localTotalIncome || 0}}</view>
        <view class="stat-label">收入</view>
      </view>
      <view class="stat-card expense">
        <view class="stat-icon">
          <image class="stat-icon-img" src="/images/remix/shopping-bag-fill-red.png" mode="widthFix" />
        </view>
        <view class="stat-value">¥{{stats.localTotalExpense || 0}}</view>
        <view class="stat-label">支出</view>
      </view>
    </view>



    <!-- 记录列表 -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">记录列表</text>
        <text class="total-text">共 {{displayTotalCount}} 条</text>
      </view>
      <!-- 记录列表上方筛选器 -->
      <view class="filter-controls">
        <picker mode="selector" range="{{recordTypeOptions}}" value="{{selectedRecordTypeIndex}}" bindchange="onRecordTypeChange">
          <view class="filter-picker">
            <text class="picker-label">记录类型</text>
            <text class="picker-text">{{recordTypeOptions[selectedRecordTypeIndex]}}</text>
            <text class="picker-arrow">▼</text>
          </view>
        </picker>
        <picker mode="selector" range="{{categoryOptions}}" value="{{selectedCategoryIndex}}" bindchange="onCategoryChange">
          <view class="filter-picker">
            <text class="picker-label">类别</text>
            <text class="picker-text">{{categoryOptions[selectedCategoryIndex]}}</text>
            <text class="picker-arrow">▼</text>
          </view>
        </picker>
      </view>
      <view class="card-content">
        <view class="list-container">
      <block wx:for="{{filteredRecords}}" wx:key="id">
        <view class="list-item">
          <view class="list-item-content">
            <view class="list-item-main">
              <view class="list-item-title">
                <text class="type-tag {{item.type === '收入' ? 'income' : 'expense'}}">{{item.type}}</text>
                <text class="category-tag">{{item.category}}</text>
              </view>
              <view class="list-item-desc">{{item.description || '无描述'}}</view>
              <view class="list-item-meta">
                <text class="date-tag">{{item.date}} {{item.time}}</text>
                <text class="parrot-tag" wx:if="{{item.parrot}}">{{item.parrot}}</text>
              </view>
            </view>
            <view class="list-item-right">
              <view class="list-item-value {{item.type === '收入' ? 'income' : 'expense'}}">¥{{item.amount}}</view>
              <view class="list-item-actions">
                <button class="action-btn edit-btn" bindtap="onEditRecord" data-record="{{item}}">
                  <image class="action-icon-img" src="/images/remix/edit-line-white.png" mode="widthFix" />
                </button>
                <button class="action-btn delete-btn" bindtap="onDeleteRecord" data-record="{{item}}">
                  <image class="action-icon-img" src="/images/remix/delete-bin-line-white.png" mode="widthFix" />
                </button>
              </view>
            </view>
          </view>
        </view>
      </block>

      <!-- 加载状态 -->
      <view class="loading-state" wx:if="{{loading}}"><text>加载中...</text></view>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{!loading && filteredRecords.length === 0}}">
        <image class="empty-icon-img" src="/images/remix/ri-wallet-fill-purple.png" mode="widthFix" />
        <text class="empty-text">暂无记录</text>
      </view>
        </view>
      </view>
    </view>

    <!-- 添加收支记录弹窗组件 -->
    <expense-modal 
      visible="{{showAddRecord}}" 
      modalTopOffsetPx="{{modalTopOffsetPx}}"
      modalBottomOffsetPx="{{modalBottomOffsetPx}}"
      bind:close="onHideAddRecord"
      bind:success="onExpenseSuccess"
    />

    <!-- 编辑收支记录弹窗组件 -->
    <expense-modal 
      visible="{{showEditRecord}}" 
      modalTopOffsetPx="{{modalTopOffsetPx}}"
      modalBottomOffsetPx="{{modalBottomOffsetPx}}"
      isEdit="{{true}}"
      editRecord="{{editRecord}}"
      bind:close="onHideEditRecord"
      bind:success="onExpenseSuccess"
    />
  </view>
</view>
