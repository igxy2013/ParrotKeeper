<!-- pages/expenses/transactions/transactions.wxml -->
<view class="page-container">
  <app-header title="æ”¶æ”¯ç®¡ç†" subtitle="è®°å½•é¹¦é¹‰ç›¸å…³æ”¶å…¥æ”¯å‡º" showBack="{{true}}">
    <view slot="actions" class="header-actions">
      <button class="btn btn-primary btn-small" bindtap="onShowAddRecord">
        <text class="action-icon">â•</text>
        æ·»åŠ æ”¶æ”¯
      </button>
    </view>
  </app-header>

  <view class="page-content">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-grid">
      <view class="stat-card income">
        <view class="stat-icon">â¬†ï¸</view>
        <view class="stat-value">Â¥{{stats.totalIncome}}</view>
        <view class="stat-label">å½“å‰ç­›é€‰æ”¶å…¥</view>
      </view>
      <view class="stat-card expense">
        <view class="stat-icon">â¬‡ï¸</view>
        <view class="stat-value">Â¥{{stats.totalExpense}}</view>
        <view class="stat-label">å½“å‰ç­›é€‰æ”¯å‡º</view>
      </view>
    </view>

    <view class="stats-grid">
      <view class="stat-card net" wx:class="{{stats.netIncome >= 0 ? 'positive' : 'negative'}}">
        <view class="stat-icon">ğŸ’¼</view>
        <view class="stat-value">Â¥{{stats.netIncome}}</view>
        <view class="stat-label">å‡€æ”¶å…¥</view>
      </view>
      <view class="stat-card monthly">
        <view class="stat-icon">ğŸ“…</view>
        <view class="stat-value">Â¥{{stats.monthlyNet}}</view>
        <view class="stat-label">æœ¬æœˆå‡€æ”¶å…¥</view>
      </view>
    </view>

    <!-- ç­›é€‰åŒº -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">ç­›é€‰æ¡ä»¶</text>
      </view>
      <view class="card-content">
        <view class="filter-section">
          <text class="filter-label">è®°å½•ç±»å‹</text>
          <view class="chip-group">
            <button class="chip {{selectedType === 'å…¨éƒ¨' ? 'active all' : ''}}" bindtap="onSelectType" data-type="å…¨éƒ¨">å…¨éƒ¨</button>
            <button class="chip {{selectedType === 'æ”¶å…¥' ? 'active income' : ''}}" bindtap="onSelectType" data-type="æ”¶å…¥">æ”¶å…¥</button>
            <button class="chip {{selectedType === 'æ”¯å‡º' ? 'active expense' : ''}}" bindtap="onSelectType" data-type="æ”¯å‡º">æ”¯å‡º</button>
          </view>
        </view>

        <view class="filter-section">
          <text class="filter-label">é€‰æ‹©é¹¦é¹‰</text>
          <view class="chip-group">
            <block wx:for="{{parrots}}" wx:key="name">
              <button class="chip {{selectedParrot === item ? 'active parrot' : ''}}" bindtap="onSelectParrot" data-parrot="{{item}}">{{item}}</button>
            </block>
          </view>
        </view>

        <view class="filter-section">
          <text class="filter-label">è®°å½•ç±»åˆ«</text>
          <view class="chip-group">
            <block wx:for="{{filterCategories}}" wx:key="name">
              <button class="chip {{selectedCategory === item ? 'active category' : ''}}" bindtap="onSelectCategory" data-category="{{item}}">{{item}}</button>
            </block>
          </view>
        </view>
      </view>
    </view>

    <!-- ç±»åˆ«ç½‘æ ¼ -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">æ”¶æ”¯ç±»åˆ«</text>
      </view>
      <view class="card-content">
        <view class="category-grid">
          <block wx:for="{{recordCategories}}" wx:key="name">
            <button class="category-item {{selectedCategory === item.name ? 'active' : ''}}" bindtap="onQuickSelectCategory" data-category="{{item.name}}">
              <view class="category-icon">{{item.iconText}}</view>
              <text class="category-name">{{item.name}}</text>
              <text class="category-type {{item.type === 'æ”¶å…¥' ? 'income' : 'expense'}}">{{item.type}}</text>
            </button>
          </block>
        </view>
      </view>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="card">
      <view class="card-header">
        <text class="card-title">è®°å½•åˆ—è¡¨</text>
        <text class="total-text">å…± {{filteredRecords.length}} æ¡</text>
      </view>
    </view>
    <view class="list-container">
      <block wx:for="{{filteredRecords}}" wx:key="id">
        <view class="list-item">
          <view class="list-item-content">
            <view class="list-item-main">
              <view class="list-item-title">
                <text class="type-tag {{item.type === 'æ”¶å…¥' ? 'income' : 'expense'}}">{{item.type}}</text>
                <text class="category-tag">{{item.category}}</text>
              </view>
              <view class="list-item-desc">{{item.description || 'æ— æè¿°'}}</view>
              <view class="list-item-meta">
                <text class="date-tag">{{item.date}} {{item.time}}</text>
                <text class="parrot-tag" wx:if="{{item.parrot}}">{{item.parrot}}</text>
              </view>
            </view>
            <view class="list-item-value {{item.type === 'æ”¶å…¥' ? 'income' : 'expense'}}">Â¥{{item.amount}}</view>
          </view>
        </view>
      </block>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{loading}}"><text>åŠ è½½ä¸­...</text></view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{!loading && filteredRecords.length === 0}}">
        <view class="empty-icon">ğŸ’°</view>
        <text class="empty-text">æš‚æ— è®°å½•</text>
        <button class="btn btn-primary btn-small" bindtap="onShowAddRecord">æ·»åŠ ç¬¬ä¸€æ¡æ”¶æ”¯</button>
      </view>
    </view>

    <!-- æ·»åŠ è®°å½•å¼¹çª— -->
    <view class="modal-mask" wx:if="{{showAddRecord}}">
      <view class="modal">
        <view class="modal-header">
          <text class="modal-title">æ·»åŠ æ”¶æ”¯è®°å½•</text>
          <button class="modal-close" bindtap="onHideAddRecord">âœ–</button>
        </view>
        <view class="modal-body">
          <view class="form-item">
            <text class="form-label">è®°å½•ç±»å‹</text>
            <view class="toggle-group">
              <button class="toggle {{newRecord.type === 'æ”¶å…¥' ? 'active income' : ''}}" bindtap="onSetNewType" data-type="æ”¶å…¥">æ”¶å…¥</button>
              <button class="toggle {{newRecord.type === 'æ”¯å‡º' ? 'active expense' : ''}}" bindtap="onSetNewType" data-type="æ”¯å‡º">æ”¯å‡º</button>
            </view>
          </view>

          <view class="form-item">
            <text class="form-label">é€‰æ‹©é¹¦é¹‰</text>
            <picker range="{{parrots}}" value="{{parrotIndex}}" bindchange="onNewParrotChange">
              <view class="picker-view">
                <text class="picker-text">{{newRecord.parrot || 'å°å½©'}}
                </text>
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}ç±»åˆ«</text>
            <picker range="{{modalCategories}}" range-key="label" value="{{categoryIndex}}" bindchange="onNewCategoryChange">
              <view class="picker-view">
                <text class="picker-text">{{newRecord.category || modalCategories[0].label}}</text>
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}é‡‘é¢</text>
            <input class="form-input" type="digit" placeholder="è¯·è¾“å…¥é‡‘é¢" value="{{newRecord.amount}}" bindinput="onNewAmountInput" />
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}æè¿°</text>
            <input class="form-input" placeholder="è¯·è¾“å…¥æè¿°" value="{{newRecord.description}}" bindinput="onNewDescriptionInput" />
          </view>

          <view class="form-item">
            <text class="form-label">{{newRecord.type}}æ—¥æœŸ</text>
            <picker mode="date" value="{{newRecord.date}}" bindchange="onNewDateChange">
              <view class="picker-view">
                <text class="picker-text">{{newRecord.date}}</text>
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </view>
        <view class="modal-actions">
          <button class="btn btn-secondary" bindtap="onHideAddRecord">å–æ¶ˆ</button>
          <button class="btn btn-primary" bindtap="onSubmitNewRecord">æ·»åŠ </button>
        </view>
      </view>
    </view>
  </view>
</view>
