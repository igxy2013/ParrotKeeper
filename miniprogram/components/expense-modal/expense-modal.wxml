<!-- 添加收支记录弹窗组件 -->
<view wx:if="{{visible}}" class="modal-overlay" catchtouchmove="true" bindtap="onOverlayTap">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-card">
      <!-- 渐变头部与关闭按钮 -->
      <view class="modal-header-gradient">
        <view class="modal-header-row">
          <text class="modal-title">{{isEdit ? '编辑收支记录' : '添加收支记录'}}</text>
          <view class="modal-close-btn" bindtap="onClose"><image class="modal-close-icon-img" src="/images/remix/close-line-white.png" mode="widthFix"/></view>
        </view>
      </view>

      <!-- 弹窗主体内容 -->
      <scroll-view scroll-y="true" class="modal-scroll">
        <view class="form-section">
        <!-- 类型切换：收入 / 支出 -->
        <view class="form-item">
          <text class="form-label">记录类型</text>
          <view class="type-switch-row">
            <view class="type-btn {{formData.type==='收入' ? 'type-income active' : 'type-income'}}" bindtap="setExpenseType" data-type="收入">收入</view>
            <view class="type-btn {{formData.type==='支出' ? 'type-expense active' : 'type-expense'}}" bindtap="setExpenseType" data-type="支出">支出</view>
          </view>
        </view>

        <!-- 选择类别 -->
        <view class="form-item">
          <text class="form-label">{{formData.type}}类别</text>
          <icon-text-selector 
            options="{{categoryOptions}}" 
            selected="{{formData.categoryValue}}" 
            bind:change="onCategoryChange" 
          />
        </view>
        <!-- 关联鹦鹉（可选，下拉可搜索） -->
        <view class="form-item">
          <text class="form-label">关联鹦鹉（可选）</text>
          <block wx:if="{{!isEdit}}">
            <view class="picker-display" catchtap="toggleParrotDropdown">
              <view class="item-line">
                <text class="item-name">{{selectedParrotName || '不关联'}}</text>
                <block wx:if="{{selectedParrotName && (selectedParrotNumber || selectedRingNumber)}}">
                  <text class="item-meta">（</text>
                  <text class="item-meta" wx:if="{{selectedParrotNumber}}">{{selectedParrotNumber}}</text>
                  <text class="item-meta" wx:if="{{selectedParrotNumber && selectedRingNumber}}">｜</text>
                  <text class="item-meta" wx:if="{{selectedRingNumber}}">{{selectedRingNumber}}</text>
                  <text class="item-meta">）</text>
                </block>
              </view>
              <image class="picker-arrow" src="/images/remix/arrow-down-s-line-gray.png" mode="aspectFit" />
            </view>
            <view class="dropdown-menu dropdown-panel" wx:if="{{showParrotDropdown}}" catchtap="stopPropagation">
              <view class="search-row">
                <input 
                  class="search-input" 
                  placeholder="搜索名称、编号或脚环号" 
                  value="{{parrotSearchKeyword}}" 
                  bindinput="onParrotSearchInput" 
                />
                <view class="clear-btn" wx:if="{{parrotSearchKeyword}}" bindtap="clearParrotSearch">清除</view>
              </view>
              <scroll-view scroll-y="true" class="dropdown-scroll">
                <view class="dropdown-item" catchtap="selectParrot" data-id="" data-name="" data-num="" data-ring="">
                  <text class="item-text">不关联</text>
                  <text class="check-icon">{{!selectedParrotId ? '✓' : ''}}</text>
                </view>
                <view class="dropdown-item" wx:for="{{filteredParrotOptions}}" wx:key="id" catchtap="selectParrot" data-id="{{item.id}}" data-name="{{item.name}}" data-num="{{item.parrot_number}}" data-ring="{{item.ring_number}}">
                  <view class="item-line">
                    <text class="item-name">{{item.name}}</text>
                    <block wx:if="{{item.parrot_number || item.ring_number}}">
                      <text class="item-meta">（</text>
                      <text class="item-meta" wx:if="{{item.parrot_number}}">{{item.parrot_number}}</text>
                      <text class="item-meta" wx:if="{{item.parrot_number && item.ring_number}}">｜</text>
                      <text class="item-meta" wx:if="{{item.ring_number}}">{{item.ring_number}}</text>
                      <text class="item-meta">）</text>
                    </block>
                  </view>
                  <text class="check-icon">{{selectedParrotId == item.id ? '✓' : ''}}</text>
                </view>
              </scroll-view>
            </view>
          </block>
          <block wx:else>
            <view class="picker-display disabled">
              <view class="item-line">
                <text class="item-name">{{selectedParrotName || '不关联'}}</text>
                <block wx:if="{{selectedParrotName && (selectedParrotNumber || selectedRingNumber)}}">
                  <text class="item-meta">（</text>
                  <text class="item-meta" wx:if="{{selectedParrotNumber}}">{{selectedParrotNumber}}</text>
                  <text class="item-meta" wx:if="{{selectedParrotNumber && selectedRingNumber}}">｜</text>
                  <text class="item-meta" wx:if="{{selectedRingNumber}}">{{selectedRingNumber}}</text>
                  <text class="item-meta">）</text>
                </block>
              </view>
            </view>
          </block>
        </view>
        <!-- 日期 -->
        <view class="form-item">
          <text class="form-label">{{formData.type}}日期</text>
          <picker mode="date" value="{{formData.date}}" bindchange="onDateChange">
            <view class="picker-display">
              <text>{{formData.date || '请选择日期'}}</text>
              <image class="picker-arrow" src="/images/remix/arrow-down-s-line-gray.png" mode="aspectFit" />
            </view>
          </picker>
        </view>
        <!-- 金额 -->
        <view class="form-item">
          <text class="form-label">{{formData.type}}金额</text>
          <view class="text-input amount-display {{!formData.amount ? 'placeholder' : ''}}" bindtap="openKeyboard">
            {{formData.amount || '请输入金额'}}
          </view>
        </view>

        <!-- 描述 -->
        <view class="form-item">
          <text class="form-label">{{formData.type}}描述</text>
          <input class="text-input description-input" placeholder="请输入描述" value="{{formData.description}}" bindinput="onDescInput" />
        </view>


        </view>
      </scroll-view>

      <!-- 底部按钮 -->
      <view class="modal-footer">
        <button class="btn-secondary" bindtap="onClose">取消</button>
        <button class="btn-add {{formData.type==='收入' ? 'btn-add-income' : 'btn-add-expense'}} {{!canSubmit ? 'btn-disabled' : ''}}" bindtap="onSubmit" disabled="{{!canSubmit}}">{{isEdit ? '保存' : '添加'}}</button>
      </view>
    </view>
  </view>

  <numeric-keyboard
    visible="{{showKeyboard}}"
    value="{{formData.amount}}"
    theme="{{formData.type==='收入' ? 'income' : 'expense'}}"
    bind:input="onKeyboardInput"
    bind:confirm="onKeyboardConfirm"
    bind:close="closeKeyboard"
    bind:save="onKeyboardSave"
    saveButtonText="{{isEdit ? '保存' : '添加'}}"
    saveDisabled="{{!canSubmit}}"
    catchtap="stopPropagation"
  />
</view>
