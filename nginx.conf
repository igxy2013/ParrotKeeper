user www-data;
worker_processes auto;
pid /run/nginx.pid;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    multi_accept on;
    use epoll;
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    server_tokens off;
    types_hash_max_size 2048;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # SSL全局配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # 安全头部
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # 跨源隔离（SharedArrayBuffer 需要）：顶层页面启用
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;

    # 性能优化
    keepalive_timeout 65;
    keepalive_requests 1000;
    client_max_body_size 20M;

    # 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;

    # WebSocket 连接升级映射（仅在需要时升级，否则保持 keep-alive）
    map $http_upgrade $connection_upgrade {
        default keep-alive;
        'websocket' upgrade;
    }

    # HTTP强制跳转HTTPS
    server {
        listen 80;
        server_name acbim.cn www.acbim.cn aixbim.cn www.aixbim.cn bimai.xyz www.bimai.xyz;
        return 301 https://$host$request_uri;
    }

    # aixbim.cn 配置
    server {
        listen 443 ssl http2;
        server_name aixbim.cn www.aixbim.cn;
        
        ssl_certificate /etc/letsencrypt/live/aixbim.cn/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/aixbim.cn/privkey.pem;
        
        # 安全规则
        location ~ /\.(env|git) { deny all; return 403; }
        location ~ /(wp-config\.php|config\.json|\.htaccess) { deny all; return 403; }
        
        location / {
            proxy_pass http://backend_bimaixyz;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_cache_bypass $http_upgrade;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffers 16 64k;
            proxy_busy_buffers_size 128k;
            proxy_buffer_size 32k;
        }
    }

    # acbim.cn 配置（已移除IP限制）
    server {
        listen 443 ssl http2;
        server_name acbim.cn www.acbim.cn;
        
        ssl_certificate /etc/letsencrypt/live/acbim.cn/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/acbim.cn/privkey.pem;
        
        # 移除了IP限制代码，现在所有IP都可以访问
        
        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffers 16 64k;
            proxy_busy_buffers_size 128k;
            proxy_buffer_size 32k;
        }
    }
    
    server {
        listen 5075;
        server_name acbim.cn www.acbim.cn; # 替换为你的域名或保留为空
    # 静态文件处理
    location /uploads/ {
        root /var/www/parrot-keeper;  # 文件实际存储的绝对路径
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        }
    location / {
        proxy_pass http://backend5075; # 替换为你的后端服务器地址
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering on;
        proxy_buffers 16 64k;
        proxy_busy_buffers_size 128k;
        proxy_buffer_size 32k;
      }
    }

    # bimai.xyz 配置
    server {
        listen 443 ssl http2;
        server_name bimai.xyz www.bimai.xyz;
    
        ssl_certificate /etc/letsencrypt/live/bimai.xyz/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/bimai.xyz/privkey.pem;
        
        # 图片通过后端路由提供：避免静态目录与后端保存路径不一致导致404
        location /uploads/ {
            proxy_pass http://backend_bimaixyz;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffers 16 64k;
            proxy_busy_buffers_size 128k;
            proxy_buffer_size 32k;
            # 前端缓存头（与静态文件一致），后端仍按需返回实际文件
            expires 30d;
            add_header Cache-Control "public, max-age=2592000, immutable" always;
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
        }
        
        location / {
            proxy_pass http://backend_bimaixyz;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffers 16 64k;
            proxy_busy_buffers_size 128k;
            proxy_buffer_size 32k;
        }
    }

    # 后端服务配置
    upstream backend {
        server 118.113.202.139:5075;
        keepalive 64;
    }

    upstream backend_bimaixyz {
        server 118.113.202.139:5075;
        keepalive 64;
    }
        
    upstream backend5075 {
        server 118.113.202.139:5075;
        keepalive 64;
    }
}
